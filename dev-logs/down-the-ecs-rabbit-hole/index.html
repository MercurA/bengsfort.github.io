<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width initial-scale=1">
	
		<title>Down the ECS Rabbit Hole</title>
	
		<!--// Metadata //-->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width initial-scale=1">
	
		<!--// Metadata //-->
		<meta name="description" content="Words and thoughts about app development, indie game development, and pixel art.">
		<meta property="og:type" content="website">
		<meta property="og:title" content="Developmental Pixels">
		<meta property="og:url" content="http://aesinv.com/index.html">
		<meta property="og:site_name" content="Developmental Pixels">
		<meta property="og:description" content="Words and thoughts about app development, indie game development, and pixel art.">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Developmental Pixels">
		<meta name="twitter:description" content="Words and thoughts about app development, indie game development, and pixel art.">
		<meta name="twitter:creator" content="@bengsfort">
		<meta property="fb:admins" content="100000177595822">
		<meta property="fb:app_id" content="1893256420958255">
		
		
		<!--// Stylesheets //-->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link href="/styles/main.css" rel="stylesheet">
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/atom-one-dark.min.css">
	</head>
	<body>
		<header>
			<a class="nav-menu-trigger waves-effect waves-light" data-target=".nav-pane">
				<i class="material-icons close">close</i>
				<i class="material-icons open">menu</i>
			</a>
			<div class="nav-pane">
				<div class="nav-content">
					<div class="author-card">
						<div class="author-card-top">
							<div class="author-avatar-wrapper">
								<img class="author-avatar" src="/assets/avatar.png" alt="Matt Bengston" />
							</div>
						</div>
					
						<div class="author-card-body">
							<h5 class="author-name">Matt Bengston</h5>
							
							<div class="author-job-info">
								<span class="author-position">Software Developer</span>
								<a class="author-employer" target="_blank" href="https://unity3d.com">Unity Technologies</a>
							</div>
					
							<div class="author-social">
								<a class="author-github" target="_blank" href="https://github.com/bengsfort">
									<svg class="icon icon-github-with-circle">
										<use xlink:href="#icon-github-with-circle" />
									</svg>
								</a>
								<a class="author-twitter" target="_blank" href="https://twitter.com/bengsfort">
									<svg class="icon icon-twitter-with-circle">
										<use xlink:href="#icon-twitter-with-circle" />
									</svg>
								</a>
							</div>
						</div>
					</div>			<nav id="site-navigation">
						<ul class="site-nav">
								<li >
									<a href="/" class="waves-effect">All Posts</a>
								</li>
								<li >
									<a href="/articles/" class="waves-effect">Articles</a>
								</li>
								<li class="active">
									<a href="/dev-logs/" class="waves-effect">Dev Logs</a>
								</li>
								<li >
									<a href="/pixel-art/" class="waves-effect">Pixel Art</a>
								</li>
								<li >
									<a href="/about/" class="waves-effect">About</a>
								</li>
						</ul>
					</nav>		</div>
				<div class="nav-footer">
					<span class="copyright-info"><i class="tiny material-icons">copyright</i> Matt Bengston</span>
					<span class="source-info"><a href="https://github.com/bengsfort/bengsfort.github.io" target="_blank"><i class="tiny material-icons">code</i> View on Github</a></span>
				</div>	</div>
		</header>
		<main class="main-wrapper">
			<div class="container">
				<section class="intro-text">
					<h1 class="headline">Down the ECS Rabbit Hole</h1>
						<span class="subtitle">My unquenchable desire to refactor everything before it even begins kicked in.</span>
						<span class="series">This post is part of an ongoing series about Flying is Hard.</span>
				</section>				<p>In my last log I mentioned that I get bored of projects really easily. My computer is literally a graveyard of probably 15 or so prototypes in various forms of completion (maybe 75% of which are platformers) that don&#39;t get any love. Many of which include a different design pattern from the rest, in keeping with my tradition of &quot;try all the design patterns!&quot; Well, I had told myself I wasn&#39;t going to go down that road again but after seeing a GDC talk about ECS I was itching with intrigue and just HAD to try to implement it.</p>
<p>Since this is a <a href="https://unity3d.com">Unity</a> project (eagle-eyed readers may have noticed that the first prototype video I shared was SpriteKit tho!), when it comes to ECS the current go-to framework is <a href="https://github.com/sschmid/Entitas-CSharp">Entitas-CSharp</a> which is a ECS framework made specifically for C# / Unity by some of the guys at Wooga. It&#39;s some really interesting tech, that said after doing some tests and playing around with it I decided that it just wasn&#39;t for me. It felt too detached from the normal Unity workflow and I didn&#39;t like how certain things were handled as well as the fact that it mostly depends on generated code; it just felt like too much was out of my hands and controlled by some black box.</p>
<p>I spent the next few weeks playing around with writing my own ECS framework with varying levels in intricacy; but after about 4 different versions I decided to settle on an extremely simplified version of the pattern that could potentially be considered an ECS/MVC pattern. It enforces the separation of data / logic but maintains the standard Unity workflow and keeps how things are working very transparent for easy debugging.</p>
<h3 id="brief-overview-of-the-pattern-i-settled-on">Brief overview of the pattern I settled on</h3>
<p>The pattern I wound up going with enforces the following structure:</p>
<ul>
<li>Entities are MonoBehaviours and each GameObject should be limited to 1 Entity</li>
<li>Components are public and serializable, and make up the public API for Entities</li>
<li>Systems are private and take in a selection of Components that are then used for Entity manipulation</li>
<li>Entities act as delegates for systems for the built-in Unity MonoBehaviour messages </li>
</ul>
<p>This allows for quick addition of new features, easy debugging of functionality (&quot;oh, the thrust is acting up? let me pop into the thrust system and see what is going on&quot;), performance benefits due to limiting each GameObject to only one MonoBehaviour, and the standard Unity workflow of throwing GameObjects into a scene and being able to tweak everything needed in there with no issues. Since I am currently not dealing with any entity managers, implementation/scaffolding was very trivial as well since it just required writing base classes for Entities, Components, and Systems.</p>
<h3 id="high-level-examples">High-level examples</h3>
<p>Let&#39;s start with entities since they hold everything together and will perhaps give you a better idea of where the other two fit in. </p>
<pre><code class="hljs csharp"><span class="hljs-comment">// ExampleEntity.cs</span>
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Components;
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Systems;
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Entities.Core;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">FlyingIsHard.Assets.Bengsfort.Entities</span>
{
    <span class="hljs-comment">// BaseEntity inherits from MonoBehaviour so it can delegate Unity messages</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ExampleEntity</span> : <span class="hljs-title">BaseEntity</span>
    {
        <span class="hljs-comment">// All components are serializable, so this will be editable within Unity</span>
        <span class="hljs-keyword">public</span> ExampleComponent component;

        <span class="hljs-comment">// Systems are handled per-entity currently</span>
        <span class="hljs-keyword">private</span> ExampleSystem m_System;

        <span class="hljs-comment">// Instantiate a new system instance, passing the component to it</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params"></span>)
        </span>{
            m_System = <span class="hljs-keyword">new</span> ExampleSystem(component);
        }

        <span class="hljs-comment">// Run the systems tick every frame if it is active</span>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">if</span> (m_System.active)
                m_System.Tick();
        }
    }
}</code></pre>

<p>As I mentioned before, Entities just hold all of your components and act as a delegate for Unity events and systems. All of the components are serializable, so each one can be fully configurable within the Unity editor and tweaked during the play state to test values at runtime. Let&#39;s take a look at a component now:</p>
<pre><code class="hljs csharp"><span class="hljs-comment">// ExampleComponent.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Components.Core;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">FlyingIsHard.Assets.Bengsfort.Components</span>
{
    [Serializable]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ExampleComponent</span> : <span class="hljs-title">BaseComponent</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> score = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> scoreStep = <span class="hljs-number">2</span>;
        <span class="hljs-keyword">public</span> Text text;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> label
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">return</span> score + <span class="hljs-string">" points"</span>;
            }
        }
    }
}</code></pre>

<p>This is an example of a somewhat typical component, with the addition of a getter member to demonstrate that the only <em>logic</em> allowed are formatting helpers or similar. They are small and focused on maintaining the state of a particular functionality. This is also very nice because it means that I can rebuild an object at any point completely just by tossing the proper state into it. Now lets look at the systems that actually use these states.</p>
<pre><code class="hljs csharp"><span class="hljs-comment">// ExampleSystem.cs</span>
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Components;
<span class="hljs-keyword">using</span> FlyingIsHard.Assets.Bengsfort.Systems.Core;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">FlyingIsHard.Assets.Bengsfort.Systems</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ExampleSystem</span> : <span class="hljs-title">BaseSystem</span>
    {
        ExampleComponent m_State;
        ExamplePlayerComponent m_Player;

        <span class="hljs-comment">// Increase the score every frame </span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Tick</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-comment">// Early out if we shouldn't increment the score</span>
            <span class="hljs-keyword">if</span> (!m_Player.incrementScore)
                <span class="hljs-keyword">return</span>;

            <span class="hljs-keyword">var</span> step = m_State.scoreStep;

            <span class="hljs-keyword">if</span> (m_Player.inBonusZone)
                step *= <span class="hljs-number">2.0</span>; <span class="hljs-comment">// Double points in the bonus zone</span>

            m_State.score += step;
            m_State.text = m_State.label;
        }

        <span class="hljs-comment">// Cache the state references on instantiation</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ExampleSystem</span>(<span class="hljs-params">ExampleComponent component</span>)
        </span>{
            m_State = component;
            <span class="hljs-comment">// Example static component</span>
            m_Player = StageManager.Player.playerState;
        }
    }
}</code></pre>

<p>As you can see above, the systems are basically pure logic focused on a single job. They cache state/data references on instantiation and then manipulate those as needed to get their job done.</p>
<p>One thing with this pattern though is that you wind up creating a lot of files very quickly. In most instances for example every time you make an entity you can also expect to make a component and system to go along with it, at least when implementing a new feature. To speed this up I wound up making an editor script that adds a new window menu to Unity for fast creation of entities, components and system files:</p>
<p><img src="/assets/down-the-ecs-rabbit-hole/ecs-editor-helper.png" alt="The editor helper"></p>
<p>As I&#39;ve been getting much more proficient with making editor scripts lately, this turned out to be pretty easy to implement. The <a href="https://docs.unity3d.com/ScriptReference/EditorWindow.html">EditorWindow</a> docs are great for figuring out how to create a custom window, so all I had to focus on was the file generator portion of the functionality. The route I went to make that happen was a pretty basic one:</p>
<ul>
<li>Have template C# files for each type of class</li>
<li>On press of the create button, find the correct template file and read all of its contents into a string</li>
<li>Use <code>String.Format</code> to inject the values from the editor window text fields into the template</li>
<li>Write the file to disk and force Unity to import the new C# file</li>
</ul>
<p>Outside of the normal editor window boilerplate stuff, all of this was able to fit into the nice little method below.</p>
<pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CreateClassFromTemplate</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-comment">// Get the template path</span>
    <span class="hljs-keyword">var</span> tmplPathPrefix = Application.dataPath + <span class="hljs-string">"/Bengsfort/Editor/Scaffolding/Templates"</span>;
    <span class="hljs-keyword">var</span> tmplFile = (tmplPathPrefix + <span class="hljs-string">"/"</span> + m_DialogTitles[(<span class="hljs-keyword">int</span>)type] + <span class="hljs-string">"Template.cs.tmpl"</span>)
        .Replace(<span class="hljs-string">'/'</span>, Path.DirectorySeparatorChar);

    <span class="hljs-comment">// Check for the existence of the template</span>
    <span class="hljs-keyword">if</span> (!File.Exists(tmplFile))
    {
        Debug.LogError(<span class="hljs-string">"Missing the template file!"</span>);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Try to create the new template</span>
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-comment">// Read the file to a variable than format it with the new data</span>
        <span class="hljs-keyword">var</span> template = File.ReadAllText(tmplFile, System.Text.Encoding.UTF8);
        m_TemplateFile = <span class="hljs-keyword">string</span>.Format(template,
            m_ClassName,
            DevName,
            DateTime.Now
        );

        <span class="hljs-comment">// Determine the correct output file</span>
        <span class="hljs-keyword">var</span> targetFile = Application.dataPath + <span class="hljs-string">"/Bengsfort"</span>;
        <span class="hljs-keyword">switch</span> (type)
        {
            <span class="hljs-keyword">case</span> ScaffoldDialogType.Component:
                targetFile += <span class="hljs-string">"/Components/"</span> + m_ClassName + <span class="hljs-string">".cs"</span>;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ScaffoldDialogType.Entity:
                targetFile += <span class="hljs-string">"/Entities/"</span> + m_ClassName + <span class="hljs-string">".cs"</span>;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ScaffoldDialogType.System:
                targetFile += <span class="hljs-string">"/Systems/"</span> + m_ClassName + <span class="hljs-string">".cs"</span>;
                <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-comment">// Reformat the path to the output file to be platform agnostic</span>
        <span class="hljs-keyword">var</span> newClass = targetFile.Replace(<span class="hljs-string">'/'</span>, Path.DirectorySeparatorChar);

        <span class="hljs-comment">// Write the shiny new file to disk</span>
        File.WriteAllText(
            newClass,
            m_TemplateFile
        );

        <span class="hljs-comment">// Tell Unity to import the asset</span>
        AssetDatabase.ImportAsset(
            newClass.Substring(newClass.IndexOf(<span class="hljs-string">"Assets"</span> + Path.DirectorySeparatorChar + <span class="hljs-string">"Bengsfort"</span>)), 
            ImportAssetOptions.ForceUpdate
        );
    }
    <span class="hljs-keyword">catch</span> (FormatException e)
    {
        <span class="hljs-comment">// Oh noes! D: It failed!</span>
        Debug.LogError(<span class="hljs-string">"There was an error creating the new class!"</span>);
        Debug.LogError(e.Message);
    }
}</code></pre>

<p>At first, everything worked great... except for it crashing when trying to format the file. I tried debugging the issue for hours, but then I finally found out the issue; which was deceptively simple: Escape the brackets.</p>
<p>As it turns out, every time <code>String.Format</code> sees a <code>{}</code> it assumes that the contents needs to be formatted with some sort of value! Looking back, it was such a &#39;duh&#39; moment. The solution was to just escape the brackets by adding double brackets, and once I did that the entire thing started working beautifully.</p>
<pre><code class="hljs">// {<span class="hljs-number">0</span>}
// Created <span class="hljs-keyword">by</span> {<span class="hljs-number">1</span>} @ {<span class="hljs-number">2</span>:d}
using System;
using FlyingIsHard.Assets.Bengsfort.Components.Core;

<span class="hljs-keyword">namespace</span> FlyingIsHard.Assets.Bengsfort.Components
{{
    [Serializable]
    public class {<span class="hljs-number">0</span>} : BaseComponent
    {{    
    }}
}}</code></pre>

<p>You can check out the entire editor window class as well as all of my templates in <a href="https://gist.github.com/bengsfort/3bea3a353562eeef667130d4ad98d222">this gist</a> on Github.</p>
<p>So far this setup has worked really well and has increased my productivity a lot. That said, I will likely tweak this in the future to contain an Entity manager so there will only be a single instance of any given System acting on entities based on a component identifier that will determine whether or not the system cares about a specific entity, but I&#39;ll leave that for another day.</p>
<p>Stay tuned for more Flying is Hard logs, and maybe follow along on twitter <a href="https://twitter.com/bengsfort">@bengsfort</a>.</p>

			</div>
		</main>

		<svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		  <defs>
		    <symbol id="icon-github-with-circle" viewBox="0 0 20 20">
		      <title>github-with-circle</title>
		      <path class="path1" d="M10.015 9.949c0 0-0.010 0-0.015 0h-0.015c-1.191 0-2.24-0.303-2.861 0.268-0.371 0.342-0.527 0.754-0.527 1.197 0 1.852 1.483 2.080 3.389 2.080h0.029c1.905 0 3.389-0.229 3.389-2.080 0-0.443-0.156-0.856-0.527-1.197-0.622-0.571-1.671-0.268-2.862-0.268zM8.393 12.48c-0.363 0-0.656-0.408-0.656-0.91s0.293-0.908 0.656-0.908c0.363 0 0.657 0.406 0.657 0.908s-0.293 0.91-0.657 0.91zM11.606 12.48c-0.363 0-0.657-0.408-0.657-0.91s0.294-0.908 0.657-0.908c0.362 0 0.656 0.406 0.656 0.908s-0.293 0.91-0.656 0.91zM10 0.4c-5.302 0-9.6 4.298-9.6 9.6s4.298 9.6 9.6 9.6 9.6-4.298 9.6-9.6-4.298-9.6-9.6-9.6zM10.876 13.939c-0.172 0-0.514 0-0.876 0.002-0.362-0.002-0.704-0.002-0.876-0.002-0.76 0-3.772-0.059-3.772-3.689 0-0.834 0.286-1.445 0.755-1.955-0.074-0.184-0.078-1.232 0.32-2.236 0 0 0.916 0.1 2.301 1.051 0.289-0.081 0.781-0.122 1.272-0.122s0.982 0.041 1.273 0.121c1.385-0.951 2.301-1.051 2.301-1.051 0.398 1.004 0.395 2.053 0.32 2.236 0.469 0.51 0.755 1.121 0.755 1.955-0.001 3.632-3.013 3.69-3.773 3.69z"></path>
		    </symbol>
		    <symbol id="icon-twitter-with-circle" viewBox="0 0 20 20">
		      <title>twitter-with-circle</title>
		      <path class="path1" d="M10 0.4c-5.302 0-9.6 4.298-9.6 9.6s4.298 9.6 9.6 9.6 9.6-4.298 9.6-9.6-4.298-9.6-9.6-9.6zM13.905 8.264c0.004 0.082 0.005 0.164 0.005 0.244 0 2.5-1.901 5.381-5.379 5.381-1.068 0-2.062-0.312-2.898-0.85 0.147 0.018 0.298 0.025 0.451 0.025 0.886 0 1.701-0.301 2.348-0.809-0.827-0.016-1.525-0.562-1.766-1.312 0.115 0.021 0.233 0.033 0.355 0.033 0.172 0 0.34-0.023 0.498-0.066-0.865-0.174-1.517-0.938-1.517-1.854v-0.023c0.255 0.141 0.547 0.227 0.857 0.237-0.508-0.34-0.841-0.918-0.841-1.575 0-0.346 0.093-0.672 0.256-0.951 0.933 1.144 2.325 1.896 3.897 1.977-0.033-0.139-0.049-0.283-0.049-0.432 0-1.043 0.846-1.891 1.891-1.891 0.543 0 1.035 0.23 1.38 0.598 0.431-0.086 0.835-0.242 1.2-0.459-0.141 0.441-0.44 0.812-0.831 1.047 0.383-0.047 0.747-0.148 1.086-0.299-0.253 0.379-0.574 0.713-0.943 0.979z"></path>
		    </symbol>
		  </defs>
		</svg>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/js/bin/materialize.min.js"></script>
		<script type="text/javascript">
			var trigger = $('.nav-menu-trigger'),
				target = $(trigger.data('target'));
			
			trigger.on('click', function() {
				trigger.toggleClass('active');
				target.toggleClass('in');
			});
		</script>		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		  ga('create', 'UA-66600710-1', 'auto');
		  ga('send', 'pageview');
		</script>
	</body>
</html>