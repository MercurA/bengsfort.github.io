<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Building a simple JavaScript game - 1. A basic game engine | Code &amp; Stuff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Once I started getting into web development my desire to be a game developer got put on the back burner while I continued to explore and build my skills as a web developer. As my experience grew and I">
<meta property="og:type" content="article">
<meta property="og:title" content="Building a simple JavaScript game - 1. A basic game engine">
<meta property="og:url" content="http://aesinv.com/development/making-a-js-game-part-1-game-engine/index.html">
<meta property="og:site_name" content="Code & Stuff">
<meta property="og:description" content="Once I started getting into web development my desire to be a game developer got put on the back burner while I continued to explore and build my skills as a web developer. As my experience grew and I">
<meta property="og:updated_time" content="2017-03-06T13:50:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Building a simple JavaScript game - 1. A basic game engine">
<meta name="twitter:description" content="Once I started getting into web development my desire to be a game developer got put on the back burner while I continued to explore and build my skills as a web developer. As my experience grew and I">
  
    <link rel="alternate" href="/atom.xml" title="Code &amp; Stuff" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Code &amp; Stuff</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://aesinv.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-making-a-js-game-part-1-game-engine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/making-a-js-game-part-1-game-engine/" class="article-date">
  <time datetime="2015-11-27T07:45:48.000Z" itemprop="datePublished">27 November, 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Building a simple JavaScript game - 1. A basic game engine
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Once I started getting into web development my desire to be a game developer got put on the back burner while I continued to explore and build my skills as a web developer. As my experience grew and I began to understand the underlying concepts behind what makes a game it started to come back around again, but instead of using traditional languages I’ve been having a lot of fun experimenting with video game development with JavaScript.</p>
<p>There are plenty of existing libraries and foundations for JavaScript game development you can build off of (<a href="http://phaser.io/" target="_blank" rel="external">Phaser</a>, <a href="http://unity3d.com/" target="_blank" rel="external">Unity</a>, <a href="http://www.kiwijs.org/" target="_blank" rel="external">Kiwi</a>, <a href="https://playcanvas.com/" target="_blank" rel="external">PlayCanvas</a>), my personal favorite being Unity. However, there is a certain charm and satisfaction that comes from building something from scratch. If you’re looking to jump right into build a crazy 3D cross-platform behemoth I’d certainly suggest checking out some of the frameworks/engines referenced above, but for the sake of a great educational exercise, we’ll be building a simple little top-down game from scratch.</p>
<p>Before we continue, I’d just like to mention that throughout the writing and development of this simple game I’m going to be listening to a live performance from the Legend of Zelda: Symphony of the Goddesses to really get into the spirit of the project. I highly recommend you fire it up and do the same, it’s terrific!</p>
<iframe class="inline-youtube" width="640" height="360" src="https://www.youtube.com/embed/Vbfc3HAOw7o?rel=0" frameborder="0" allowfullscreen></iframe>

<h2 id="High-level-overview"><a href="#High-level-overview" class="headerlink" title="High-level overview"></a>High-level overview</h2><p>We’re going to be making a simple top-down game with basic old-school gameplay characteristics. The finished product will allow us to walk around a small town, go in buildings, and fight baddies just outside the town. As the character moves, the camera will remain still until it either gets to the edge of the viewport or moves within a <em>door tile</em>. When these two events occur, the camera will either move to display the next portion of the world or the player will be transported into a new room (whatever the door leads to), respectively.</p>
<p>We’ll be using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" target="_blank" rel="external">HTML5 Canvas API</a> to handle rendering our game, and we’ll be developing our JavaScript with the help of <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a>, <a href="http://browserify.org/" target="_blank" rel="external">Browserify</a>, and <a href="http://www.browsersync.io/" target="_blank" rel="external">Browser Sync</a>. In terms of managing what’s going on within the game, we’ll be attaching state objects to all of our different components so we can manage the current state of each component individually, which I personally find to be the easiest method of monitoring and managing data.</p>
<p>I’ve completed a basic project boilerplate you can download and follow along with, available on <a href="https://github.com/aesinv/javascript-game-demo/releases/tag/0.1.0-boilerplate" target="_blank" rel="external">Github</a>. Alternatively, you can visit the <a href="https://github.com/aesinv/javascript-game-demo/" target="_blank" rel="external">repository</a> for the demo and just checkout commit 3a4f588. If you’d like a more in-depth look at setting up Gulp for projects, you can check out a <a href="!--￼19--">previous post</a> that goes over building a gulp file for Jekyll pretty thoroughly.</p>
<h2 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h2><p>Our first order of business will be creating a good project foundation. We could build this entire thing in a single monstrous file, but for the sake of readability and maintainability I’m more a fan of modularity, which is why I’ve opted to build out the game and its components as modules then bundle them together via <a href="http://browserify.org/" target="_blank" rel="external">browserify</a>. Let’s have a look at our proposed project structure:</p>
<pre><code>index.html  // Loads up game module for game-playing party time.
/js/        // Main JS root.
- game.js   // Primary game module.
- core/     // Contains core &quot;engine&quot;-related modules.
- players/  // Contains all enemy/character-related modules.
- utils/    // Contains global constants/utility functions.
- world/    // Contains the main world classes and all levels.
</code></pre><p>It’s a pretty simple structure, and should be fairly predictable. Our main <code>game.js</code> file will require the proper modules from <code>players/</code>, <code>utils/</code>, <code>core/</code>, and <code>world/</code> as dependencies, which will in turn require any additional dependencies needed to generate our game. In this part we’ll more than likely only touch one (maybe two) files in each directory.</p>
<h2 id="Creating-a-viewport-with-canvas"><a href="#Creating-a-viewport-with-canvas" class="headerlink" title="Creating a viewport with canvas"></a>Creating a viewport with canvas</h2><p>First things first, we want to create our main game module so we can start working. Then, we’ll include that on our html page and have it dynamically inject a high-dpi, or high resolution, canvas onto the page after calculating the correct pixel ratio; this way we can make sure we’ll have crystal clear rendering even on higher pixel density devices.</p>
<p>Let’s start with that first bit by creating a bare-bones game module inside of <code>/js/game.js</code>.<br><figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/game.js</span></div><div class="line"><span class="keyword">var</span> $container = <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Create base game class</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.viewport = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</div><div class="line">    <span class="keyword">this</span>.context = viewport.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.viewport.width = <span class="number">800</span>;</div><div class="line">    <span class="keyword">this</span>.viewport.height = <span class="number">600</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Append the canvas node to our container</span></div><div class="line">    $container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line">    <span class="comment">// Toss some text into our canvas</span></div><div class="line">    <span class="keyword">this</span>.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">    <span class="keyword">this</span>.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">800</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate the game in a global</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game();</div><div class="line"></div><div class="line"><span class="comment">// Export the game as a module</span></div><div class="line"><span class="built_in">module</span>.exports = game;</div></pre></td></tr></table></figure></p>
<p>We’re not doing anything fancy here, just creating a canvas (6 - 10), tossing it into our container (13), then rendering some text (16 - 17). More than likely if you view the above code on a high pixel density monitor it will output the text but it will be <em>super</em> blurry and gross. To solve this, we’re going to create a utility that will calculate the correct pixel ratio then downscale the canvas for optimum rendering quality. We’re going to be basing our utilities off of a terrific <a href="http://www.html5rocks.com/en/tutorials/canvas/hidpi/" target="_blank" rel="external">HTML5 Rocks blog post</a> on the subject, and tossing them into our handy-dandy <code>utils/</code> directory under the file name <code>utils.canvas.js</code>.</p>
<p>Just a note, but our utility files will be extremely simple exports of object literals contained with methods, so you can expect them to follow a structure like so:</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">methodOne</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">    <span class="attr">methodTwo</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>First, we’ll need a way to get the correct pixel ratio. To do this we’re going to need a canvas context, which we’ll use to get the device backing ratio from the backing device backing store. We’ll then divide the pixel ratio from the window by that backing ratio, giving us our pixel ratio.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Determine the proper pixel ratio for the canvas */</span></div><div class="line">getPixelRatio : <span class="function"><span class="keyword">function</span> <span class="title">getPixelRatio</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Determining pixel ratio.'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// I'd rather not have a giant var declaration block,</span></div><div class="line">  <span class="comment">// so I'm storing the props in an array to dynamically</span></div><div class="line">  <span class="comment">// get the backing ratio.</span></div><div class="line">  <span class="keyword">var</span> backingStores = [</div><div class="line">    <span class="string">'webkitBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'mozBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'msBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'oBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'backingStorePixelRatio'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> deviceRatio = <span class="built_in">window</span>.devicePixelRatio;</div><div class="line"></div><div class="line">  <span class="comment">// Iterate through our backing store props and determine the proper backing ratio.</span></div><div class="line">  <span class="keyword">var</span> backingRatio = backingStores.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">prev, curr</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (context.hasOwnProperty(curr) ? context[curr] : <span class="number">1</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// Return the proper pixel ratio by dividing the device ratio by the backing ratio</span></div><div class="line">  <span class="keyword">return</span> deviceRatio / backingRatio;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>The comments are pretty verbose, but a secondary quick rundown of whats going on:</p>
<ol>
<li>We create an array of the properly browser-prefixed backing store props. (10 - 16)</li>
<li>We reduce our array to a single backing store ratio, defaulting to 1 if none exist. (21 - 23)</li>
<li>We divide the device pixel ratio (from the window) by the backing ratio, giving us our pixel ratio. (26)</li>
</ol>
<p>Next, we need to apply our calculated ratio to our canvas then downscale the entire canvas via CSS and transforms, giving us predictable high quality rendering with predictable dimensions. We’ll toss all of this inside of another canvas utility, then return the canvas to our main game object for instantiation and dom injection.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Generate a canvas with the proper width / height</span></div><div class="line"> * Based on: http://www.html5rocks.com/en/tutorials/canvas/hidpi/</div><div class="line"> */</div><div class="line">generateCanvas : <span class="function"><span class="keyword">function</span> <span class="title">generateCanvas</span>(<span class="params">w, h</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Generating canvas.'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">      context = canvas.getContext(<span class="string">'2d'</span>);</div><div class="line">  <span class="comment">// Pass our canvas' context to our getPixelRatio method</span></div><div class="line">  <span class="keyword">var</span> ratio = <span class="keyword">this</span>.getPixelRatio(context);</div><div class="line"></div><div class="line">  <span class="comment">// Set the canvas' width then downscale via CSS</span></div><div class="line">  canvas.width = <span class="built_in">Math</span>.round(w * ratio);</div><div class="line">  canvas.height = <span class="built_in">Math</span>.round(h * ratio);</div><div class="line">  canvas.style.width = w +<span class="string">'px'</span>;</div><div class="line">  canvas.style.height = h +<span class="string">'px'</span>;</div><div class="line">  <span class="comment">// Scale the context so we get accurate pixel density</span></div><div class="line">  context.setTransform(ratio, <span class="number">0</span>, <span class="number">0</span>, ratio, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> canvas;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Again, pretty straight forward. You’ll notice that after creating our canvas and getting the context, we’re passing that context to our <code>getPixelRatio()</code> method then multiplying our canvas width and height by the returned number, then setting the width and height <em>styles</em> to the original width and height; this is us <em>downscaling</em> the canvas. It’s kind of like if you watch a 1080p video on YouTube at 400px wide. Our transform is then relatively scaling the canvas back up by the amount we downscaled it, that way we get accurate pixel sizes. Try removing the setTransform and viewing the effects, it’s super interesting.</p>
<p>Now that both of our utility methods for canvas generation are created, we can rewrite our main game module create a properly sized canvas dynamically and then append it into our container, giving us our viewport.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cUtils = <span class="built_in">require</span>(<span class="string">'./utils/utils.canvas.js'</span>),</div><div class="line">    $container = <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params">w, h</span>) </span>&#123;</div><div class="line">  <span class="comment">// Generate a canvas and store it as our viewport</span></div><div class="line">  <span class="keyword">this</span>.viewport = cUtils.generateCanvas(w, h);</div><div class="line">  <span class="keyword">this</span>.viewport.id = <span class="string">"gameViewport"</span>; <span class="comment">// give the canvas an ID for easy CSS/JS targeting</span></div><div class="line"></div><div class="line">  <span class="comment">// Get and store the canvas context as a global</span></div><div class="line">  <span class="keyword">this</span>.context = <span class="keyword">this</span>.viewport.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Append our viewport into a container in the dom</span></div><div class="line">  $container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line">  <span class="comment">// Spit out some text</span></div><div class="line">  <span class="keyword">this</span>.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">  <span class="keyword">this</span>.context.fillStyle = <span class="string">'#fff'</span>;</div><div class="line">  <span class="keyword">this</span>.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate a new game in the global scope at 800px by 600px</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game(<span class="number">800</span>, <span class="number">600</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = game;</div></pre></td></tr></table></figure>
<p>Our Game module remains largely the same, apart from us using the <code>generateCanvas()</code> method from our canvas utilities module to create our viewport instead of manually creating it. On the upside, we should now have a dynamically generated high resolution canvas to play around with, so now we have to figure out how to prime it for game play.</p>
<h2 id="Creating-a-game-loop"><a href="#Creating-a-game-loop" class="headerlink" title="Creating a game loop"></a>Creating a game loop</h2><p>So we’ve got a canvas and some folders that make us look like we really know what we’re doing. Reasonable next steps involve creating some sort of rendering and logic engine to handle updating the games state, and re-rendering our canvas to reflect the updated state. Luckily, we can take care of both of these in one fell swoop by creating a <a href="https://developer.mozilla.org/en-US/docs/Games/Anatomy" target="_blank" rel="external"><em>game loop</em></a>.</p>
<p>When it comes to animating and managing a canvas there are a few more hoops to jump through than when you’re animating a typical dom node, mostly because you can’t really reference the created canvas contents after you’ve rendered them. To solve this we’re going to wind up storing everything within a central state; with individual entities (players, enemies, etc.) storing they’re positioning and other pertinent data within their own states. Then, when it’s time to re-render, we’ll call each entities <code>render()</code> method which will use the data within their states to render the entity correctly.</p>
<p>Since with a canvas we need to clear objects out before re-rendering them in a different position, we’re going to be re-rendering the entire canvas every frame. To accomplish this we’re going to need a loop, which being JavaScript there are millions of ways to do that. Let’s take a look at our primary options:</p>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setTimeout" target="_blank" rel="external"><code>setTimeout</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval" target="_blank" rel="external"><code>setInterval</code></a> set to an interval that would fire off at a rate that would equal our target <abbr title="Frames per second">FPS</abbr>.</li>
<li>Utilize <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="external"><code>window.requestAnimationFrame</code></a>, which is the recommended method, to tell the browser we’d like to do an animation and to fire our render method before the next repaint.</li>
</ol>
<p>Our first option, using <code>setTimeout</code> or <code>setInterval</code> would be much easier (and readable for the most part), but it’s incredibly inefficient. The second option, while being way more complex, is miles more efficient due to the browser being able to optimize animations during repaint cycles.</p>
<h3 id="Scaffolding-out-the-loop"><a href="#Scaffolding-out-the-loop" class="headerlink" title="Scaffolding out the loop"></a>Scaffolding out the loop</h3><p>Let’s start by scaffolding out the modules that we’ll be needing for our main loop. The main loop will have three parts:</p>
<pre><code>/js/core/game.loop.js // The actual loop
/js/core/game.update.js // An update method
/js/core/game.render.js // A rendering method
</code></pre><p>These modules will need to access some constants that we will be setting in our global game module, so we’re going to create a new <code>constants</code> property along with an empty <code>state</code> within our main game module first.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params">w, h, targetFps, showFps</span>) </span>&#123;</div><div class="line">    <span class="comment">// Setup some constants</span></div><div class="line">    <span class="keyword">this</span>.constants = &#123;</div><div class="line">        <span class="attr">width</span>: w,</div><div class="line">        <span class="attr">height</span>: h,</div><div class="line">        <span class="attr">targetFps</span>: targetFps,</div><div class="line">        <span class="attr">showFps</span>: showFps</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Instantiate an empty state object</span></div><div class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</div><div class="line">    . . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate a new game in the global scope at 800px by 600px</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game(<span class="number">800</span>, <span class="number">600</span>, <span class="number">60</span>, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<p>In addition to our original props for the width and height, we’ve also added a target frame rate prop and a flag for whether or not to render the current FPS; the latter being totally optional both in implementation and use. Now that we’re storing all of this inside of a handy dandy exposed object, we can start on our new modules.</p>
<p>Since these are all integral to the functioning of our game, we can count these modules as <em>core</em> modules which we’ll instantiate from our main game module. Since the update and rendering method are fairly simple and straight forward (for now), so let’s start with those.</p>
<h4 id="The-game-update-module"><a href="#The-game-update-module" class="headerlink" title="The game update module"></a>The game update module</h4><p>Since we’re just scaffolding out our loop and currently have no actual functionality, our update method is going to be really boring. Eventually it will take the games state object, determine changes in, update it, then return it. We’ll just pretend we’re doing fancy stuff for now though.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.update.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.update.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Update Module</span></div><div class="line"> * Called by the game loop, this module will</div><div class="line"> * perform any state calculations / updates</div><div class="line"> * to properly render the next frame.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameUpdate</span> (<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"> tFrame </span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> state = scope.state || &#123;&#125;;</div><div class="line"></div><div class="line">        <span class="comment">// If there are entities, iterate through them and call their `update` methods</span></div><div class="line">        <span class="keyword">if</span> (state.hasOwnProperty(<span class="string">'entities'</span>)) &#123;</div><div class="line">            <span class="keyword">var</span> entities = state.entities;</div><div class="line">            <span class="comment">// Loop through entities</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entities) &#123;</div><div class="line">                <span class="comment">// Fire off each active entities `render` method</span></div><div class="line">                entities[entity].update();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameUpdate;</div></pre></td></tr></table></figure>
<p>Like I said, nothing super crazy going on. We’re injecting the global scope (8), then creating a new object based off of the global state (10), iterating through entities in the global state (13), firing the <code>update()</code> method for each active entity (16 - 22), then returning it (15). Easy.</p>
<p>One interesting thing you may have noticed is that I’m expecting a <code>scope</code> parameter to be passed in first, then I’m returning another function that is actually doing all of the work. You’ll see this in the render method as well, and it’s more of a personal preference more than anything. An alternative would be to remove the returned function, move it’s contents into the main <code>gameUpdate</code> function, and instead of injecting the scope we’d tap into the global <code>window.game</code> object. Since I want to avoid hard coding these references in, I’m just injecting the scope as a parameter.</p>
<h4 id="The-game-render-module"><a href="#The-game-render-module" class="headerlink" title="The game render module"></a>The game render module</h4><p>The render module is a little more busy than our update one, but it’s nothing too crazy yet. We’re going to move our dummy text from the main game module into this one, add our FPS rendering logic, then write a quick little loop to iterate through potential active entities.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.render.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.render.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Render Module</span></div><div class="line"> * Called by the game loop, this module will</div><div class="line"> * perform use the global state to re-render</div><div class="line"> * the canvas using new data. Additionally,</div><div class="line"> * it will call all game entities `render`</div><div class="line"> * methods.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameRender</span>(<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="comment">// Setup globals</span></div><div class="line">    <span class="keyword">var</span> w = scope.constants.width,</div><div class="line">        h = scope.constants.height;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Clear out the canvas</span></div><div class="line">        scope.context.clearRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line"></div><div class="line">        <span class="comment">// Spit out some text</span></div><div class="line">        scope.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">        scope.context.fillStyle = <span class="string">'#fff'</span>;</div><div class="line">        scope.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If we want to show the FPS, then render it in the top right corner.</span></div><div class="line">        <span class="keyword">if</span> (scope.constants.showFps) &#123;</div><div class="line">            scope.context.fillStyle = <span class="string">'#ff0'</span>;</div><div class="line">            scope.context.fillText(<span class="string">'FPS'</span>, w - <span class="number">100</span>, <span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If there are entities, iterate through them and call their `render` methods</span></div><div class="line">        <span class="keyword">if</span> (scope.state.hasOwnProperty(<span class="string">'entities'</span>)) &#123;</div><div class="line">            <span class="keyword">var</span> entities = scope.state.entities;</div><div class="line">            <span class="comment">// Loop through entities</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entities) &#123;</div><div class="line">                <span class="comment">// Fire off each active entities `render` method</span></div><div class="line">                entities[entity].render();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameRender;</div></pre></td></tr></table></figure>
<p>Like the update module we’re injecting the games context (10), then we’re clearing the canvas (17), rendering our dummy content (19-22) and setting it up to show the FPS in the top right corner of the canvas if the <code>showFps</code> flag is set (25-28).</p>
<p>The only fanciness occurring here is between lines 31 and 38, where we are iterating through all active entities with a simple <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in" target="_blank" rel="external"><code>for...in</code></a> loop (if the global state has any entities set, as per line 31), then firing off the <code>render()</code> method of each active entity (36).</p>
<p>We’ll be returning to this module in a little bit to change the text we’re writing in place of the actual frame rate, but for now it’s completed.</p>
<h4 id="The-loop-of-doom"><a href="#The-loop-of-doom" class="headerlink" title="The loop of doom"></a>The loop of doom</h4><p>Now it’s time for us to move onto our mythical loop, which will by far be the most complex portion of code we’ve written yet. As I mentioned earlier, we’re going to be using <code>requestAnimationFrame</code> to handle our loop, as recommended by <a href="https://developer.mozilla.org/en-US/docs/Games/Anatomy" target="_blank" rel="external">MDN</a> and based off of information from <a href="http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/" target="_blank" rel="external">Paul Irish</a>, coupled together with some frame rate throttling based on some terrific <a href="http://stackoverflow.com/a/19772220" target="_blank" rel="external">stack overflow answers</a>.</p>
<p>I know that’s a lot to swallow, so we’ll tackle this one one by one. Let’s start with the loop itself, then we’ll jump into the frame rate throttling.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Loop Module</span></div><div class="line"> * This module contains the game loop, which handles</div><div class="line"> * updating the game state and re-rendering the canvas</div><div class="line"> * (using the updated state) at the configured FPS.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameLoop</span> (<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> loop = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Main game rendering loop</span></div><div class="line">    loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123;</div><div class="line">        <span class="comment">// Request a new Animation Frame</span></div><div class="line">        <span class="comment">// setting to `stopLoop` so animation can be stopped via</span></div><div class="line">        <span class="comment">// `window.cancelAnimationFrame( loop.stopLoop )`</span></div><div class="line">        loop.stopLoop = <span class="built_in">window</span>.requestAnimationFrame( loop.main );</div><div class="line"></div><div class="line">        <span class="comment">// Update the game state</span></div><div class="line">        scope.state = scope.update( now );</div><div class="line">        <span class="comment">// Render the next frame</span></div><div class="line">        scope.render();</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Start off main loop</span></div><div class="line">    loop.main();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameLoop;</div></pre></td></tr></table></figure>
<p>By itself the loop isn’t too terrifying at all, and if you’ve checked out the MDN docs on the anatomy of a web game it should be very familiar; we’re just creating a callback and passing it into <code>window.requestAnimationFrame</code>, then firing off our update and render methods, which are instantiated in the global context (which has been injected in). I realize this isn’t the most elegant way to fire off the update and render methods, but my reasoning is to have the update and render modules instantiated and exposed globally if, for whatever reason, they need to be triggered manually. An alternative to this would be to require the modules within the game loop module, and instantiate them with the injected context.</p>
<p>Next, we’ll start with our frame rate throttling. There’s quite a lot to this, so I’ll try to break it down as best as I can. First we need to set up our variables for calculating the frame rate. We’re going to require the current animation tick timestamp, the previous animation tick timestamp as well as the difference between the two; our target FPS and our target interval between animation ticks <em>(1000 / fps)</em>.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 9 - 30</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize timer variables so we can calculate FPS</span></div><div class="line"><span class="keyword">var</span> fps = scope.constants.targetFps, <span class="comment">// Our target fps</span></div><div class="line">    fpsInterval = <span class="number">1000</span> / fps, <span class="comment">// the interval between animation ticks, in ms (1000 / 60 = ~16.666667)</span></div><div class="line">    before = <span class="built_in">window</span>.performance.now(), <span class="comment">// The starting times timestamp</span></div><div class="line"></div><div class="line">    <span class="comment">// Set up an object to contain our alternating FPS calculations</span></div><div class="line">    cycles = &#123;</div><div class="line">        <span class="attr">new</span>: &#123;</div><div class="line">            <span class="attr">frameCount</span>: <span class="number">0</span>, <span class="comment">// Frames since the start of the cycle</span></div><div class="line">            startTime: before, <span class="comment">// The starting timestamp</span></div><div class="line">            sinceStart: <span class="number">0</span> <span class="comment">// time elapsed since the startTime</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">old</span>: &#123;</div><div class="line">            <span class="attr">frameCount</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">startTime</span>: before,</div><div class="line">            <span class="attr">sineStart</span>: <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// Alternating Frame Rate vars</span></div><div class="line">    resetInterval = <span class="number">5</span>, <span class="comment">// Frame rate cycle reset interval (in seconds)</span></div><div class="line">    resetState = <span class="string">'new'</span>; <span class="comment">// The initial frame rate cycle</span></div><div class="line"></div><div class="line">loop.fps = <span class="number">0</span>; <span class="comment">// A prop that will expose the current calculated FPS to other modules</span></div><div class="line"></div><div class="line"><span class="comment">// Main game rendering loop</span></div><div class="line">loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123; . . . &#125;</div></pre></td></tr></table></figure>
<p>Whoa, that’s a lot of variables. Keeping the code comments in mind, there’s one thing I would like to explain which is the <code>cycles</code> object. If you look at the stack overflow answer I mentioned earlier, there’s a lot of examples of some calculations to determine and throttle the frame rate, but they use a single computation cycle which while testing I noticed some issues with.</p>
<ol>
<li>After a while, the performance would bog down due to the constant incrementation of the single frame count and elapsed time variables.</li>
<li>Also after some time, the accuracy would drastically decrease. As the calculations depend on the current time and frame count in relation to the original time, because the gap was so massive the resulting value would be mis-representative of the actual frame rate and would act as more of an “average-over-the-time-you’ve-had-this-page-open”.</li>
</ol>
<p>The second issue may be more of a presentation of the frame rate problem I admit, but as a solution I’ve made it so there are two increments going on in parallel and as they reach a pre-determined interval, <code>resetInterval</code>, the active cycle will get reset to 0 and the alternate cycle will take its place as the active cycle. This helps maintain an accurately calculated frame rate based on samples from a short period of time, rather than an increasingly large period of time.</p>
<p>Now, back to our loop.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 32. . .82</span></div><div class="line"></div><div class="line">loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123;</div><div class="line">    <span class="comment">// Request a new Animation Frame</span></div><div class="line">    <span class="comment">// setting to `stopLoop` so animation can be stopped via</span></div><div class="line">    <span class="comment">// `window.cancelAnimationFrame( loop.stopLoop )`</span></div><div class="line">    loop.stopLoop = <span class="built_in">window</span>.requestAnimationFrame( loop.main );</div><div class="line"></div><div class="line">    <span class="comment">// How long ago since last loop?</span></div><div class="line">    <span class="keyword">var</span> now = tframe,</div><div class="line">        elapsed = now - before,</div><div class="line">        activeCycle, targetResetInterval;</div><div class="line"></div><div class="line">    <span class="comment">// If it's been at least our desired interval, render</span></div><div class="line">    <span class="keyword">if</span> (elapsed &gt; fpsInterval) &#123;</div><div class="line">        <span class="comment">// Set before = now for next frame, also adjust for</span></div><div class="line">        <span class="comment">// specified fpsInterval not being a multiple of rAF's interval (16.7ms)</span></div><div class="line">        <span class="comment">// ( http://stackoverflow.com/a/19772220 )</span></div><div class="line">        before = now - (elapsed % fpsInterval);</div><div class="line"></div><div class="line">        <span class="comment">// Update the game state</span></div><div class="line">        scope.update( now );</div><div class="line">        <span class="comment">// Render the next frame</span></div><div class="line">        scope.render();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Throttling the loop to our ideal fps is actually relatively simple, as you can see above. Here are the headlines:</p>
<ul>
<li><strong>Lines 8 &amp; 9:</strong> cache the current timestamp, then subtract the previous timestamp from it to get the elapsed time.</li>
<li><strong>Line 13:</strong> If the elapsed time from line 9 is greater than our target interval, continue with the re-render.</li>
<li><strong>Lines 14 - 22:</strong> Set the variable holding the previous timestamp to the current timestamp, then fire the update and render modules.</li>
</ul>
<p>Pretty straight forward, so now let’s calculate the current frame rate and expose it for other modules (namely the rendering module).</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 49 - 78</span></div><div class="line"></div><div class="line">before = now - (elapsed % fpsInterval);</div><div class="line"></div><div class="line"><span class="comment">// Increment the vals for both the active and the alternate FPS calculations</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> calc <span class="keyword">in</span> cycles) &#123;</div><div class="line">    ++cycles[calc].frameCount;</div><div class="line">    cycles[calc].sinceStart = now - cycles[calc].startTime;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Choose the correct FPS calculation, then update the exposed fps value</span></div><div class="line">activeCycle = cycles[resetState];</div><div class="line">loop.fps = <span class="built_in">Math</span>.round(<span class="number">1000</span> / (activeCycle.sinceStart / activeCycle.frameCount) * <span class="number">100</span>) / <span class="number">100</span>;</div><div class="line"></div><div class="line"><span class="comment">// If our frame counts are equal....</span></div><div class="line">targetResetInterval = (cycles.new.frameCount === cycles.old.frameCount</div><div class="line">                       ? resetInterval * fps <span class="comment">// Wait our interval</span></div><div class="line">                       : (resetInterval * <span class="number">2</span>) * fps); <span class="comment">// Wait double our interval</span></div><div class="line"></div><div class="line"><span class="comment">// If the active calculation goes over our specified interval,</span></div><div class="line"><span class="comment">// reset it to 0 and flag our alternate calculation to be active</span></div><div class="line"><span class="comment">// for the next series of animations.</span></div><div class="line"><span class="keyword">if</span> (activeCycle.frameCount &gt; targetResetInterval) &#123;</div><div class="line">    cycles[resetState].frameCount = <span class="number">0</span>;</div><div class="line">    cycles[resetState].startTime = now;</div><div class="line">    cycles[resetState].sinceStart = <span class="number">0</span>;</div><div class="line"></div><div class="line">    resetState = (resetState === <span class="string">'new'</span> ? <span class="string">'old'</span> : <span class="string">'new'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Update the game state</span></div></pre></td></tr></table></figure>
<p>This is probably the most we’ve got going on so far, so let’s review it block by block.</p>
<ul>
<li><strong>Lines 4 - 7:</strong> First we’re going to iterate through both cycles, increment the frame counts and update the elapsed times since the start of the cycle.</li>
<li><strong>Lines 10 &amp; 11:</strong> Set the active cycle, then use some maths to determine and set our exposed property to the current frame rate.</li>
<li><strong>Lines 12 - 15:</strong> Set our target reset interval. Once the cycles begin alternating, when the <em>active</em> cycle reaches it’s target, the <em>inactive</em> cycle will be equal to half of the target since it runs in parallel. Therefore, rather than resetting at our interval, we want to reset at double our interval.</li>
<li><strong>Lines 21 - 27:</strong> If the active cycles frame count is greater than its target interval, reset the active cycle to 0 and switch to the inactive cycle.</li>
</ul>
<p>Now that that’s completed, we can run back to our rendering module (<code>/js/core/game.render.js</code>) and toss our exposed <code>loop.fps</code> value in place of our dummy <em>‘FPS’</em> text:</p>
<pre><code>scope.context.fillText(scope.loop.fps, w - 100, 50);
</code></pre><h4 id="Wrapping-it-all-together"><a href="#Wrapping-it-all-together" class="headerlink" title="Wrapping it all together"></a>Wrapping it all together</h4><p>Since we have all of our modules built and exposed as exportable modules, we can now simply instantiate them within the main game module and our game should automagically run our main loop, displaying the frame rate in the top right corner if you’ve set your <code>showFps</code> parameter to true.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">. . .</div><div class="line">$container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line"><span class="comment">// Instantiate core modules with the current scope</span></div><div class="line"><span class="keyword">this</span>.update = gameUpdate( <span class="keyword">this</span> );</div><div class="line"><span class="keyword">this</span>.render = gameRender( <span class="keyword">this</span> );</div><div class="line"><span class="keyword">this</span>.loop = gameLoop( <span class="keyword">this</span> );</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</div></pre></td></tr></table></figure>
<p>Huzzah! We’ve built (albeit basic) our own rudimentary game engine! It automagically generates a high resolution canvas element and injects it into our HTML, updates itself at a configurable frame rate, and displays said frame rate using an alternating calculation cycle strategy (which you can see if you toss a log of the frame rate of both cycles into your loop).</p>
<!-- video -->
<h2 id="Bonus-Creating-a-movable-player"><a href="#Bonus-Creating-a-movable-player" class="headerlink" title="Bonus: Creating a movable player"></a>Bonus: Creating a movable player</h2><p>I could end there, but I usually get really annoyed whenever I see a multi-part how-to that completely leaves me hanging before magic happens, so I don’t want to be <em>“that guy”</em>. To some people, getting the loop completed is magical and they’re probably way stoked at the moment; I am as well but I think an even more magical stopping point would be the ability to move a little box around the viewport. Nothing crazy, just enough to be interactive and really get the inspiration flowing when you get that “Eureka!” moment as you’re moving the box around the viewport aimlessly.</p>
<p>Let’s get cracking.</p>
<h3 id="Creating-our-player-module"><a href="#Creating-our-player-module" class="headerlink" title="Creating our player module"></a>Creating our player module</h3><p>Earlier I kept mentioning <em>entities</em>, which is essentially what we’re going to be creating. If you’ve played around in Unity before, the term will be familiar to you as Unity games are built from entities. Entities are essentially interactive components such as NPC’s, enemies, projectiles, etc. Eventually, our entity will have tons of different methods and properties such as health, damage, attack, and other game-type stuff; for now all we’re going to be needing is a state that will contain our position within the viewport, a render method, and an update method.</p>
<p>As far as utilities go, foreseeable necessary utilities include a way to bind our number to a specific boundary (the width of our viewport and 0) and a way of determining whether or not a key is being pressed at any time. Let’s start by scaffolding out our player entity, then we can create and plug in those utilities as needed.</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> player = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Create the initial state</span></div><div class="line">    player.state = &#123;</div><div class="line">        <span class="attr">position</span>: &#123;</div><div class="line">            <span class="attr">x</span>: x,</div><div class="line">            <span class="attr">y</span>: y</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">moveSpeed</span>: <span class="number">1.5</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Set up any other constants</span></div><div class="line">    <span class="keyword">var</span> height = <span class="number">23</span>,</div><div class="line">        width = <span class="number">16</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Draw the player on the canvas</span></div><div class="line">    player.render = <span class="function"><span class="keyword">function</span> <span class="title">playerRender</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        scope.context.fillStyle = <span class="string">'#40d870'</span>;</div><div class="line">        scope.context.fillRect(</div><div class="line">            player.state.position.x,</div><div class="line">            player.state.position.y,</div><div class="line">            width, height</div><div class="line">        );</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Fired via the global update method.</span></div><div class="line">    <span class="comment">// Mutates state as needed for proper rendering next state</span></div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, if so, update the players position.</span></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> player;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>As you can see, our entity structure is extremely similar to all of our other modules; we just have an exported function declaration with some properties and methods exposed. What’s important to note here are the exposed <code>render</code> and <code>update</code> methods, lines 23 - 30 and 34 - 37, respectively. You’ll remember that in both our global update and render modules we’re iterating through all of the active entities and firing off these methods, so the inclusion of them within our entity is crucial.</p>
<p>Again, we’re injecting the scope into the module but this isn’t 100% necessary; we could also inject it by ditching the <code>scope</code> parameter and using the <code>window.game</code> global to get the context. Since we were injecting it earlier, I’m sticking with that here. If it winds up bugging me later, I’m sure I’ll change it in the next post.</p>
<p>Technically, as long as we instantiate the player module our game should function and render our player in our viewport. This will more than likely occur on a per-level (or world) basis, but for now we’ll just toss that into our main module.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/game.js, lines 40 - 51</span></div><div class="line"></div><div class="line">that = <span class="keyword">this</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> createPlayer = <span class="function"><span class="keyword">function</span> <span class="title">createPlayer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// Set the state.entities prop to an empty object if it does not exist</span></div><div class="line">    that.state.entities = that.state.entities || &#123;&#125;;</div><div class="line">    <span class="comment">// Instantiate a player as an active entity</span></div><div class="line">    that.state.entities.player = <span class="keyword">new</span> playerEnt(</div><div class="line">        that,</div><div class="line">        that.constants.width / <span class="number">2</span>,</div><div class="line">        that.constants.height - <span class="number">100</span></div><div class="line">    );</div><div class="line">&#125;();</div></pre></td></tr></table></figure>
<h4 id="Getting-our-player-to-move"><a href="#Getting-our-player-to-move" class="headerlink" title="Getting our player to move"></a>Getting our player to move</h4><p>Now that we’ve got a working entity it’s time for us to fill up the entities update method so it actually does something. Our first order of business is getting our player to move around whenever we press the arrow keys down. Since we’re not using jQuery or any libraries we’re going to have to figure out a way to gracefully monitor the dom for key down events, then store whether or not a key is down at any given point as a boolean. There’s two ways we can do this, we can either return some functions that will act as getters and retrieve whatever the keys variable is set to at that moment (<code>keys.isLeftPressed()</code>), or we can utilize <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">Object.defineProperty</a> to actually create some getters for the variables (<code>keys.isPressed.left</code>). This is obviously left completely to personal preference, and I’m going to be using <code>Object.defineProperty</code> because I like the syntax it leaves us with.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.keysDown.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.keysDown.js</span></div><div class="line"></div><div class="line"><span class="comment">/** keysDown Utility Module</span></div><div class="line"> * Monitors and determines whether a key</div><div class="line"> * is pressed down at any given moment.</div><div class="line"> * Returns getters for each key.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">keysDown</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// Set isPressed to an empty object</span></div><div class="line">    <span class="keyword">this</span>.isPressed = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> left, right, up, down;</div><div class="line"></div><div class="line">    <span class="comment">// Set up `onkeydown` event handler.</span></div><div class="line">    <span class="built_in">document</span>.onkeydown = <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">39</span>) &#123; right = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">37</span>) &#123; left = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">38</span>) &#123; up = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">40</span>) &#123; down = <span class="literal">true</span>; &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Set up `onkeyup` event handler.</span></div><div class="line">    <span class="built_in">document</span>.onkeyup = <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">39</span>) &#123; right = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">37</span>) &#123; left = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">38</span>) &#123; up = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">40</span>) &#123; down = <span class="literal">false</span>; &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Define getters for each key</span></div><div class="line">    <span class="comment">// * Not strictly necessary. Could just return</span></div><div class="line">    <span class="comment">// * an object literal of methods, the syntactic</span></div><div class="line">    <span class="comment">// * sugar of `defineProperty` is just so much sweeter :)</span></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'left'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> left; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'right'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> right; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'up'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> up; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'down'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> down; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = keysDown();</div></pre></td></tr></table></figure>
<p>Now, I understand that this probably looks about as graceful as an ice skating bear with all of its if blocks, but it’s certainly a lot better than polluting our entity with all of this mumbo jumbo (trust me on this, I had it within the module when I first wrote it and the tears were real). So, what’s goin’ on here?</p>
<ul>
<li>We prep our <code>isPressed</code> property by setting it to an empty object and we cache all of our variables (10, 11).</li>
<li>Set up event listeners for when a key is pressed down, then we determine what keys are pressed and set variables accordingly (14 - 19).</li>
<li>Similarly, we set up event listeners for when a key is released and again set variables accordingly. This is crucial as it will tell our game <em>“Hey, we’re not moving left anymore”</em> (22 - 27).</li>
<li>Finally, we define some getters for each of our keys. They aren’t the most complex getters in the world, but they’re terrific as they give us the syntax of a variable declaration, but it will return whatever value is active at the time (33 - 55).</li>
</ul>
<p>After requiring this module into our player module, we then have access to the ability to request whether a key is active or not at any given time by calling that keys property within the <code>isPressed</code> object (<code>keys.isPressed.left</code> for example).</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"><span class="keyword">var</span> keys = <span class="built_in">require</span>(<span class="string">'../utils/utils.keysDown.js'</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">. . .</div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, and if so, update the players position.</span></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.left) &#123;</div><div class="line">            player.state.position.x -= player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.right) &#123;</div><div class="line">            player.state.position.x += player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.up) &#123;</div><div class="line">            player.state.position.y -= player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.down) &#123;</div><div class="line">            player.state.position.y += player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">    &#125;;</div><div class="line">. . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>Easier than expected, huh? And since we’ve defined our moveSpeed as a variable, later on we can alter the move speed dynamically to implement things like smooth surfaces, boost power ups, sprinting, etc. The only downside that we’re left with is if we keep going left for instance, we could easily get lost in the depths of the out-of-viewport wilderness; never to return. Let’s fix that.</p>
<h4 id="Binding-our-position-to-a-boundary"><a href="#Binding-our-position-to-a-boundary" class="headerlink" title="Binding our position to a boundary"></a>Binding our position to a boundary</h4><p>When I say we’re going to be binding our position to a boundary, it’s just a fancy way of saying that we’re going to be forcing our coordinates to not exceed a minimum or maximum value. It’s a really simple trick, and while it isn’t absolutely necessary to have as its own module it makes using it within our player module a lot cleaner. Not to mention we can always extend the module to contain other math-related helper functions as well.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.math.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.math.js</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Number.prototype.boundary</div><div class="line"> * Binds a number between a minimum and a maximum amount.</div><div class="line"> * var x = 12 * 3;</div><div class="line"> * var y = x.boundary(3, 23);</div><div class="line"> * y === 23</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> Boundary = <span class="function"><span class="keyword">function</span> <span class="title">numberBoundary</span>(<span class="params">min, max</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.min( <span class="built_in">Math</span>.max(<span class="keyword">this</span>, min), max );</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Expose methods</span></div><div class="line"><span class="built_in">Number</span>.prototype.boundary = Boundary;</div><div class="line"><span class="built_in">module</span>.exports = Boundary;</div></pre></td></tr></table></figure>
<p>All we’re doing here is taking the min and max boundaries, and applying our current position so it won’t exceed those two boundary points. Some <em>“Eureka!”</em>‘s include that since we’re extending the prototype of the Number object our number is available to us within the method via <code>this</code>, and I’m only exporting it as a module to get browserify to bundle the file up with the rest of our project.</p>
<p>Now we can jump back into our player module and change our update method to bind our position to the boundaries we’ve set.</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"><span class="keyword">var</span> keys = <span class="built_in">require</span>(<span class="string">'../utils/utils.keysDown.js'</span>),</div><div class="line">    mathHelpers = <span class="built_in">require</span>(<span class="string">'../utils/utils.math.js'</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">    . . .</div><div class="line"></div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, if so, update the players position.</span></div><div class="line">        . . .</div><div class="line"></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">        player.state.position.x = player.state.position.x.boundary(<span class="number">0</span>, (scope.constants.width - width));</div><div class="line">        player.state.position.y = player.state.position.y.boundary(<span class="number">0</span>, (scope.constants.height - height));</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    . . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>Trust me, this is a LOT cleaner than tossing all of that <em>min max</em> stuff into the module. As I mentioned before, since we extended the <code>Number</code> objects prototype with <code>Number.prototype.boundary</code>, that method is now available to all Numbers within our project. Since x and y are numbers rather than strings, they can then use boundary to return the proper position.</p>
<div class="bg-video-wrap" style="background-image: url('/img/videos/gulpVid.png');"><br>  <video class="bg-video-player" autoplay loop><br>    <source src="/img/videos/game-engine-vid.mp4" type="video/mp4; codecs=avc1.42E01E,mp4a.40.2"><br>    <source src="/img/videos/game-engine-vid.webm" type="video/webm; codecs=vp8,vorbis"><br>    <source src="/img/videos/game-engine-vid.ogv" type="video/ogg; codecs=theora,vorbis"><br>  </video><br></div>

<h2 id="Wrapping-Up"><a href="#Wrapping-Up" class="headerlink" title="Wrapping Up"></a>Wrapping Up</h2><p>So, let’s review what we’ve done in this episode:</p>
<ul>
<li>Built a pretty rad project structure that is fairly predictable and easy to work with.</li>
<li>Created a dynamically generated high-resolution canvas and injected it into the dom as a viewport.</li>
<li>Built out a rudimentary rendering and logic engine using <code>requestAnimationFrame</code>, dynamically throttling it to a configurable frame rate</li>
<li>Made a two-cycle alternating frame rate calculator for frame rate monitoring during development</li>
<li>Created our first interactive entity, the player, and added logic to move him around the screen</li>
<li>Got a feel for how to add onto to our project foundation</li>
</ul>
<p>Not too shabby for a first pass. I know we mostly did the <em>behind the scenes</em> stuff (the kind of stuff that takes forever, then you excitedly show it to the client and they go “uhhh. that’s it? that’s all you’ve done? what am I looking at?”) and the current iteration isn’t the most exciting thing in the world, but it’s a solid platform for us to start with. In the next couple posts we’ll start going in and doing the exciting stuff like creating sprites for our entities, generating levels, writing in collision detection, and possibly extracting our logic update layer further for more efficiency.</p>
<p>If you’d like to check out the code for this post in full, you can check it out on the <a href="https://github.com/aesinv/javascript-game-demo/tree/0.2.0-p1" target="_blank" rel="external">github repo</a> (specifically the 0.2.0-p1 tag), or you can <a href="https://github.com/aesinv/javascript-game-demo/releases/tag/0.2.0-p1" target="_blank" rel="external">download it</a> as a zip or tar file.</p>
<p>Safe travels until next round!</p>
<h2 id="Adventure-outline-parts"><a href="#Adventure-outline-parts" class="headerlink" title="Adventure outline / parts"></a>Adventure outline / parts</h2><ul>
<li><strong><a href="#">Part 1: A basic game engine</a></strong></li>
<li>Part 2: Creating our game world - Coming soon</li>
<li>Part 3: Sprites, enemies and danger - Coming soon</li>
<li>Part 4: Implementing an event system - Coming soon</li>
<li>Part ~: More will be added as they’re written!</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/making-a-js-game-part-1-game-engine/" data-id="cizy4qyea0006ahpg5tj5ugsa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-along/">code along</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dungeon-crawler/">dungeon crawler</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/game-development/">game development</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/games/">games</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/development/calculating-beacon-distances-with-optimized-averaging/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Calculating iBeacon distances with optimized averaging
        
      </div>
    </a>
  
  
    <a href="/development/building-a-gulp-workflow-around-jekyll/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Building a Gulp workflow wrapped around Jekyll</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">development</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/game-dev/">game dev</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Internet-of-Things/">Internet of Things</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adobe-cq/">adobe cq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aem/">aem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aem6/">aem6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/beacons/">beacons</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-along/">code along</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crying-yourself-to-sleep/">crying yourself to sleep</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-motion/">device motion</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dungeon-crawler/">dungeon crawler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experimental-tech/">experimental tech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/game-development/">game development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/games/">games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git-issues/">git issues</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gulp/">gulp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ibeacon/">ibeacon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jekyll/">jekyll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sass/">sass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sightly/">sightly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity/">unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utilities/">utilities</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/workflow/">workflow</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Internet-of-Things/" style="font-size: 10px;">Internet of Things</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/adobe-cq/" style="font-size: 15px;">adobe cq</a> <a href="/tags/aem/" style="font-size: 10px;">aem</a> <a href="/tags/aem6/" style="font-size: 10px;">aem6</a> <a href="/tags/beacons/" style="font-size: 10px;">beacons</a> <a href="/tags/code-along/" style="font-size: 10px;">code along</a> <a href="/tags/crying-yourself-to-sleep/" style="font-size: 10px;">crying yourself to sleep</a> <a href="/tags/device-motion/" style="font-size: 10px;">device motion</a> <a href="/tags/dungeon-crawler/" style="font-size: 10px;">dungeon crawler</a> <a href="/tags/experimental-tech/" style="font-size: 10px;">experimental tech</a> <a href="/tags/game-development/" style="font-size: 15px;">game development</a> <a href="/tags/games/" style="font-size: 10px;">games</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-issues/" style="font-size: 10px;">git issues</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/ibeacon/" style="font-size: 10px;">ibeacon</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/sass/" style="font-size: 10px;">sass</a> <a href="/tags/sightly/" style="font-size: 10px;">sightly</a> <a href="/tags/unity/" style="font-size: 10px;">unity</a> <a href="/tags/utilities/" style="font-size: 10px;">utilities</a> <a href="/tags/workflow/" style="font-size: 10px;">workflow</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/uncategorized/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/development/fixing-git-push-pull-timeout/">Fixing git push/pull timing out</a>
          </li>
        
          <li>
            <a href="/development/passing-data-from-aem6-to-javascript/">Different ways to pass data from AEM6 to Javascript</a>
          </li>
        
          <li>
            <a href="/development/simplified-aem-frontend-sass/">A simplified front end architecture solution for AEM</a>
          </li>
        
          <li>
            <a href="/game-dev/keeping-the-user-entertained-when-they-fail/">Game Dev Log: Keeping the player entertained when they fail</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Matt Bengston<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>