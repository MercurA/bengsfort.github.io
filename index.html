<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Code &amp; Stuff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A dive into app, indie game dev and pixel art with Matt Bengston.">
<meta property="og:type" content="website">
<meta property="og:title" content="Code & Stuff">
<meta property="og:url" content="http://aesinv.com/index.html">
<meta property="og:site_name" content="Code & Stuff">
<meta property="og:description" content="A dive into app, indie game dev and pixel art with Matt Bengston.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code & Stuff">
<meta name="twitter:description" content="A dive into app, indie game dev and pixel art with Matt Bengston.">
  
    <link rel="alternate" href="/atom.xml" title="Code &amp; Stuff" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Code &amp; Stuff</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://aesinv.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/uncategorized/hello-world/" class="article-date">
  <time datetime="2017-03-06T09:09:19.000Z" itemprop="datePublished">6 March, 2017</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/uncategorized/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/uncategorized/hello-world/" data-id="cizy2uzv30000zupgfl97euno" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fixing-git-push-pull-timeout" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/fixing-git-push-pull-timeout/" class="article-date">
  <time datetime="2016-05-26T12:02:30.000Z" itemprop="datePublished">26 May, 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/fixing-git-push-pull-timeout/">Fixing git push/pull timing out</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>There’s nothing worse than losing precious development time thanks to some random sporadic tooling error. It’s amazing how difficult it was to find an actual fix for this, although due to the network-related nature of the issue I can imagine there are at least 400 million different fixes and causes.</p>
<p>Out of the blue I was unable to pull or push to any repos. Since I use SSH with Github, I was able to circumvent the issue briefly by changing the origin to https then providing my user/pass when pushing and pulling but all of a sudden that stopped working completely as well. What gives?</p>
<p>So first up, the error. After remaining idle for quite a while, the command would fail with the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ git push</div><div class="line">ssh: connect to host github.com port 22: Operation timed out</div><div class="line">fatal: Could not read from remote repository.</div><div class="line"></div><div class="line">Please make sure you have the correct access rights</div><div class="line">and the repository exists.</div></pre></td></tr></table></figure>
<p>Alright… After some Googlin’ I was able to find a <a href="http://stackoverflow.com/questions/15589682/ssh-connect-to-host-github-com-port-22-connection-timed-out" target="_blank" rel="external">Stack overflow post</a> mentioning the same issue, with the accepted answer saying to change the repo URL from SSH to https. That was a no-go, but the first command to double check came in handy:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh -T git@github.com</div></pre></td></tr></table></figure>
<p>The post mentioned that should timeout, and it did. However with my repo already on https and it still not working, I had to explore other avenues to fix it. After restarting 4 times with no luck I did more searching and found myself on the following page on <a href="https://help.github.com" target="_blank" rel="external">Github Help</a>: <a href="https://help.github.com/articles/using-ssh-over-the-https-port/" target="_blank" rel="external">Using SSH over the HTTPS port</a>.</p>
<p>Hot. More things to try. The first was an altered version of the first command that essentially ran the same check but through a different port. I was supposed to receive a friendly success message back, so I went ahead and gave it a go:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ssh -T -p 443 git@ssh.github.com</div><div class="line">Hi aesinv! You&apos;ve successfully authenticated, but GitHub does not provide shell access.</div></pre></td></tr></table></figure>
<p>It was like finding a radio linked directly to the forrest rangers after being lost in the forrest for 2 weeks, it was absolutely beautiful. I went ahead and followed the second step listed on the article, which was to update my ssh config to route github connections through the HTTPS port.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># ~/.ssh/config</div><div class="line">Host github.com</div><div class="line">    Hostname ssh.github.com</div><div class="line">    Port 443</div></pre></td></tr></table></figure>
<p>Now for the moment of truth. To test the routing was complete I ran the same command I had run before, <code>$ ssh -T git@github.com</code>, and saw the same friendly greeting I had before. Hope swelled throughout my being. Then I tried pushing the changes that were waiting politely to be transported safely over to the repository, and what I was greeted with was a truly incredibly sight to behold.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ git push</div><div class="line">Warning: Permanently added the RSA host key for IP address &apos;[192.30.252.151]:443&apos; to the list of known hosts.</div><div class="line">Counting objects: 59, done.</div><div class="line">Delta compression using up to 8 threads.</div><div class="line">Compressing objects: 100% (48/48), done.</div><div class="line">Writing objects: 100% (59/59), 6.54 KiB | 0 bytes/s, done.</div><div class="line">Total 59 (delta 28), reused 0 (delta 0)</div><div class="line">To git@github.com:Organization/repo.git</div><div class="line">   2a7b8b5..0c8a46c  feature-hero -&gt; feature-hero</div></pre></td></tr></table></figure>
<p>I may have cried a tear of happiness.</p>
<p>Hopefully this can help someone else who gets tormented by this awful issue. I still am not sure what exactly caused it as things were working just great yesterday, but I’m glad I was able to find a fix. It took nearly 3 hours, but we can gloss over that.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/fixing-git-push-pull-timeout/" data-id="cizy4qye80004ahpg2sumway5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/crying-yourself-to-sleep/">crying yourself to sleep</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git-issues/">git issues</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/">github</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-passing-data-from-aem6-to-javascript" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/passing-data-from-aem6-to-javascript/" class="article-date">
  <time datetime="2016-05-15T08:15:10.000Z" itemprop="datePublished">15 May, 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/passing-data-from-aem6-to-javascript/">Different ways to pass data from AEM6 to Javascript</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Tl-dr"><a href="#Tl-dr" class="headerlink" title="Tl;dr"></a>Tl;dr</h2><blockquote>
<ul>
<li>Use <code>data-*</code> attributes to pass along information to JS, in some cases passing along a data URI so you can obtain data via AJAX.</li>
<li>Build a <em>component loader</em> that pushes the required components into an initialization queue as the page gets parsed.</li>
<li>Create a data scraper that does the same as the last point, but functions a little bit more automated.</li>
</ul>
</blockquote>
<p>We’ve all been there. There’s some fancy component that requires numerous different view states, all including a ton of data. Do you just dump all of that into the DOM and hide the elements when they’re not in use, potentially adding to your initial load time and bloating up your markup? Do you dynamically call for the new data every time the user uses the call to action, potentially slowing their real-time experience? More than likely there are approximately 4.3 billion different ways to handle this scenario (this is web development, after all), but not all of them work well in the realm of <a href="http://www.adobe.com/marketing-cloud/enterprise-content-management.html" target="_blank" rel="external">AEM</a>.</p>
<p>So far in <a href="http://www.adobe.com/marketing-cloud/enterprise-content-management.html" target="_blank" rel="external">AEM</a> land I’ve tried quite a few different options for passing data to the front end, and some have worked far better than others. What I’ve personally used that have worked the best include using data attributes and AJAX calls either on demand or to snag and cache the rest of the data after first load, using some sort of <em>component loader</em> that builds a queue of components to load at runtime then initializes them with data, and building a data scraper that, similar to the component loader, scrapes the page for key identifiers and then initializes each component with the data scraped from the page.</p>
<p>Which one is best? It’s hard to say as each one shines in different scenarios, but none of them are subjectively perfect. Let’s take a dive into each method, see how to implement it, and figure out when it makes sense to do so.</p>
<h2 id="Data-attribute-fun"><a href="#Data-attribute-fun" class="headerlink" title="Data attribute fun"></a>Data attribute fun</h2><p>First up let’s take a look at utilizing <code>data-*</code> attributes to pass along data to Javascript. Data attributes are semantic, standards compliant and very popular ever since their inclusion in HTML5, so they’re definitely a more obvious choice. In fact if you’re already well-versed in data attributes you can feel free to jump down to the next method as this will probably end up just being a refresher.</p>
<p>Data attributes benefit in that they’re almost effortless to implement (compared to the other options) and  semantically correct. Where they lose is large amounts of data and in some cases readability. For this reason data attributes are best paired with small amounts of simple data and a data URI that the Javascript can hit with a request for more yummy data.</p>
<p>So let’s pretend we’ve got a form. When the user updates one select we need to grab some data based on that select, tack it onto the end of a data URI that the back end dev has provided and use that to grab some JSON data from AEM which we can then toss into a different select, with an authorable prefix.</p>
<figure class="highlight html"><figcaption><span>component.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"namespace-component js-component"</span></span></div><div class="line">    <span class="attr">data-form-trigger</span>=<span class="string">".js-trigger-field"</span></div><div class="line">    <span class="attr">data-form-field</span>=<span class="string">".js-data-field"</span></div><div class="line">    <span class="attr">data-option-prefix</span>=<span class="string">"$&#123;component.optionPrefix&#125;"</span></div><div class="line">    <span class="attr">data-form-uri</span>=<span class="string">"$&#123;component.formUri&#125;"</span>&gt;</div><div class="line">    <span class="comment">&lt;!-- your markup --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>We’ve added the element selectors for our elements onto our main component as data attributes, along with the data URI and option prefix that AEM has graciously given us after being configured by our content author. We now have direct access to all of these and can use them directly in our Javascript by accessing the data attributes of our component container via the <code>.data()</code> method with jQuery, or <code>.dataset</code> property with vanilla JS.</p>
<figure class="highlight javascript"><figcaption><span>component.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> $component  = $(<span class="string">'.js-component'</span>),</div><div class="line">    $trigger    = $component.find($component.data(<span class="string">'form-trigger'</span>)),</div><div class="line">    $field      = $component.find($component.data(<span class="string">'form-field'</span>)),</div><div class="line">    prefix      = $component.data(<span class="string">'option-prefix'</span>),</div><div class="line">    contentUri  = $component.data(<span class="string">'form-uri'</span>);</div><div class="line"></div><div class="line"><span class="comment">// When the trigger is changed</span></div><div class="line">$trigger.on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// Get JSON from the content URI</span></div><div class="line">    $.getJSON(contentUri+$trigger.val(), <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="comment">// Iterate through the options array we've recieved</span></div><div class="line">        <span class="keyword">var</span> result = data.options.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">prev, opt</span>) </span>&#123;</div><div class="line">            <span class="comment">// Construct an HTML string of our new options</span></div><div class="line">            <span class="keyword">return</span> prev + <span class="string">"&lt;option value='"</span>+ opt.value +<span class="string">"'&gt;"</span> + prefix + opt.label + <span class="string">"&lt;/option&gt;"</span>;</div><div class="line">        &#125;, <span class="string">""</span>);</div><div class="line">        <span class="comment">// Inject the new content into our select</span></div><div class="line">        $field.html(result);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Simple and effective. We’re not hardcoding anything that shouldn’t be hardcoded, and we’ve given the user the ability to configure something that is dynamic and would have previously been un-configurable. Furthermore, implementation was incredibly simple as data attributes are a 1:1 in both the markup and JS, so grabbing them from the markup was as easy as grabbing any other elements property. Plus we don’t have to hardcode in a URL, given the back end developer has created a Sightly-retrievable property containing the proper URL.</p>
<p>The only downside to this particular implementation is the arguably ugly element block and the fact that we couldn’t just pass in some JSON without making the markup even uglier. Some people won’t mind it at all, but many developers find mass data attributes to be one of the ugliest sins of all humanity.</p>
<h2 id="A-component-loader"><a href="#A-component-loader" class="headerlink" title="A component loader"></a>A component loader</h2><p>Next up is building a component loader, which is a pretty slick solution if you don’t mind <code>&lt;script&gt;&lt;/script&gt;</code> tags. If you <strong>do</strong> absolutely despise script tags though, you should definitely stick around for the markup before making any final judgements as it leaves an super minimal footprint.</p>
<p>The component loader has a lot more going on than data attributes, however it is much more robust in applications where there’s a potential for lots of data being passed to the front end. Essentially we’re going to be splitting things up into 3 parts:</p>
<ol>
<li>A global function in the head that adds components to an initialization queue, as well as one that fires off all components stored in that initialization queue.</li>
<li>Script tags within the markup that fire off the loader function in the head, passing along a component name and it’s data.</li>
<li>A DOM ready event handler that triggers our component initialization function.</li>
</ol>
<p>This allows us to only run/trigger the components we actually need for this page and pass in as much data as we want, without worrying about Ajax calls. So let’s start out with what we want our script tags to look like, then we can build the loading / initialization functions.</p>
<h3 id="The-Markup"><a href="#The-Markup" class="headerlink" title="The Markup"></a>The Markup</h3><figure class="highlight html"><figcaption><span>component.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-use.component</span>=<span class="string">"path.to.backing.class.of.Component"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"namespace-component"</span> <span class="attr">id</span>=<span class="string">"$&#123;resource.name&#125;"</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--/* your component markup */--&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">namespace.loadComponent(<span class="string">'component-name'</span>, &#123;</div><div class="line">    <span class="attr">container</span>: <span class="string">'#$&#123;resource.name @ context="scriptString"&#125;'</span>,</div><div class="line">    <span class="attr">trigger</span>: <span class="string">'.js-component-trigger'</span>,</div><div class="line">    <span class="attr">field</span>: <span class="string">'.js-component-field'</span>,</div><div class="line">    <span class="attr">prefix</span>: <span class="string">'$&#123;component.optionPrefix @ context="scriptString"&#125;'</span>,</div><div class="line">    <span class="attr">jsonData</span>: <span class="string">'$&#123;component.optionData @ context="scriptString"&#125;'</span></div><div class="line">&#125;);</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Pretty spiffy. In this instance we’ve gone with a very similar setup to our last demo where we’re manipulating a select field based on another select, except this time we’re passing in all of our options as a giant JSON object (<code>${component.optionData}</code>) so we don’t have to deal with Ajax calls. Instead, all our JS has to do is switch properties of a cached object to get new data. The only real bummer here is that to make sure we’re targeting the correct instance of this component, we have to add an ID or some other identifier that matches up with only this DOM element (<code>${resource.name}</code>), which is not something we have to do when it comes to data attributes.</p>
<h3 id="The-loader-runner"><a href="#The-loader-runner" class="headerlink" title="The loader/runner"></a>The loader/runner</h3><p>Now that we know the syntax of our loader, it’s time to write the loader itself. Because it needs to be instantiated and ready to go before the components begin getting parsed, we need our loader to be created very early on, so somewhere in our <code>&lt;head&gt;&lt;/head&gt;</code>. We’ll also need to establish a global namespace, initialization method, and a queue for our components.</p>
<figure class="highlight javascript"><figcaption><span>namespace.headlibs.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*! Global Namespace Setup */</span></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">window</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> namespace = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Create our queue</span></div><div class="line">        <span class="keyword">var</span> queue = [];</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="comment">// Create containers for our components and activated components</span></div><div class="line">            components: &#123;&#125;,</div><div class="line">            <span class="attr">activeComponents</span>: &#123;&#125;,</div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Pushes a component to the component queue</div><div class="line">             * @param name String - name of the component</div><div class="line">             * @param data Object - parameters to pass to the component</div><div class="line">             */</div><div class="line">            loadComponent: <span class="function"><span class="keyword">function</span> <span class="title">loadComponent</span> (<span class="params">name, data</span>) </span>&#123;</div><div class="line">                queue.push(&#123;</div><div class="line">                    <span class="attr">name</span>: name,</div><div class="line">                    <span class="attr">properties</span>: data</div><div class="line">                &#125;);</div><div class="line">            &#125;,</div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Iterates through the component queue and runs all queued scripts.</div><div class="line">             * Will log an error to the console if a component can't be found.</div><div class="line">             */</div><div class="line">            runComponents: <span class="function"><span class="keyword">function</span> <span class="title">runComponents</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> ns = <span class="keyword">this</span>;</div><div class="line">                <span class="comment">// Iterate through our queue</span></div><div class="line">                <span class="keyword">this</span>.activeComponents = queue.map(<span class="function"><span class="keyword">function</span> <span class="title">iterateQueue</span> (<span class="params">c</span>) </span>&#123;</div><div class="line">                    <span class="comment">// If the component name provided exists..</span></div><div class="line">                    <span class="keyword">if</span> (ns.components.hasOwnProperty(c.name)) &#123;</div><div class="line">                        <span class="comment">// Instantiate the component and push it into our activeComponents reference</span></div><div class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> ns.components[c.name](c.properties);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// Otherwise, log an error to the console for further debugging</span></div><div class="line">                        <span class="built_in">console</span>.error(<span class="string">'Component Loader: The "'</span>+ c.name +<span class="string">'" component was not found.'</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line"></div><div class="line">                <span class="comment">// Reset the queue</span></div><div class="line">                queue = [];</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">window</span>.namespace = namespace();</div><div class="line">&#125;)(<span class="built_in">window</span>, <span class="literal">undefined</span>);</div></pre></td></tr></table></figure>
<p>Let’s go over what’s going on in this snippet:</p>
<ol>
<li>Queue initialization: We create a private queue to hold our to-be-initialized components (line #5)</li>
<li>Container initialization: We set up containers for all of our component objects as well as our activated components (lines #8, 9)</li>
<li>loadComponent method: We create a function that gets two arguments, a name (string) corresponding to the name of our component script and data (object) to be passed to it, and pushes those into our private queue (lines #15-20)</li>
<li>runComponents method: We create a function that iterates through our queue, checks to verify the component exists, and will either run the component or log a not-found error to the console depending on the result of the verification check (lines #25-41)</li>
</ol>
<p>In terms of code complexity, there really isn’t much going on aside from array traversal and manipulation. Something worth noting is that the <code>activeComponents</code> property doesn’t strictly need to be there unless you’re going to need to access one of your components after it’s been initialized for some reason (more than likely the only reason will be for debugging if something isn’t working correctly), so if you were to omit that you could just remove the variable assignment and call it a day. Another improvement that could be made would be to pass in the DOM element ID as another argument outside of the options object, then in your <code>runComponents</code> method pass along a cached version of the DOM element to save a line inside of your component scripts.</p>
<p>As you can see from the snippet, this depends on storing your components inside of an accessible object and using some sort of initialization function with each component. This really shines when used in tandem with something like <a href="http://browserify.org/" target="_blank" rel="external">Browserify</a>, where you can just require the component modules to generate your components object. Implementing via <a href="http://browserify.org/" target="_blank" rel="external">Browserify</a> does require having an external <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a> build though, although if you’re working on an increasingly intricate project this may already be implemented. You can see an example of what this coupled with Browserify would look like below.</p>
<figure class="highlight javascript"><figcaption><span>namespace.components.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Component namespace with Browserify */</span></div><div class="line"><span class="comment">// These are not strictly necessary in this instance, but are still good to</span></div><div class="line"><span class="comment">// include if something for some reason is being included manually elsewhere.</span></div><div class="line"><span class="built_in">window</span>.namespace = namespace || &#123;&#125;;</div><div class="line"><span class="built_in">window</span>.namespace.components = namespace.components || &#123;&#125;;</div><div class="line"></div><div class="line">namespace.components = &#123;</div><div class="line">    <span class="attr">linkedList</span>: <span class="built_in">require</span>(<span class="string">'./components/linkedlist/linkedlist.js'</span>),</div><div class="line">    <span class="attr">searchFilter</span>: <span class="built_in">require</span>(<span class="string">'./components/searchfilter/searchfilter.js'</span>)</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// linkedlist.js component</span></div><div class="line"><span class="keyword">var</span> linkedList = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">    <span class="comment">// do something</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = linkedList;</div></pre></td></tr></table></figure>
<p>If you’re ditching the added complexity of something like Browserify, this still works really well and is pretty straightforward. The only difference is you’ll be adding the components to the components object manually in your scripts.</p>
<figure class="highlight javascript"><figcaption><span>linkedlist.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.namespace = namespace || &#123;&#125;;</div><div class="line"><span class="built_in">window</span>.namespace.components = namespace.components || &#123;&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> linkedList = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">    <span class="comment">// Do things</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">namespace.components.linkedList = linkedList;</div></pre></td></tr></table></figure>
<p>The structures are very similar, but in one instance (Browserify) you’re leaving the component scripts strictly module-related and bulk-importing them, where the standard method you’re having to also verify existence of the globals then manually add the component to them. Technically speaking as long as we have the global declaration in the head, the globals verification is not strictly necessary (at least, the main <code>window.namespace = namespace || {}</code> part) but it’s always a good idea to include it just to be safe. If one thing somehow tweaks the order it can lead to a lot of really awful debugging time.</p>
<p>Another thing to note is that even though in the example the components are functions, you’re not absolutely tied down to this pattern. If you’re more into the type of pattern where you have a plain object with tons of methods including an <code>.init()</code> method, that’s totally doable as well it would just require the instantiation of the components in the <code>runComponents</code> declaration to be updated with the new pattern:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.activeComponents = queue.map(<span class="function"><span class="keyword">function</span> <span class="title">iterateQueue</span> (<span class="params">c</span>) </span>&#123;</div><div class="line">    <span class="comment">// If the component name provided exists..</span></div><div class="line">    <span class="keyword">if</span> (ns.components.hasOwnProperty(c.name)) &#123;</div><div class="line">        <span class="comment">// Instantiate the component and push it into our activeComponents reference</span></div><div class="line">        <span class="keyword">return</span> ns.components[c.name].init(c.properties);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Otherwise, log an error to the console for further debugging</span></div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'Component Loader: The "'</span>+ c.name +<span class="string">'" component was not found.'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>From there, all that’s left to do is fire our <code>runComponents()</code> method somewhere in the footer, after all of our components have been loaded into the queue. As an added bonus, if you toss it into an on DOM ready event, all of the components loaded via the component loader will initialize…. well, on DOM ready. One less thing to worry about in your components!</p>
<h2 id="A-component-scraper"><a href="#A-component-scraper" class="headerlink" title="A component scraper"></a>A component scraper</h2><p>So this method is extremely similar to the component loader and takes queues from it, however it handles  loading differently. With this method our plan is to assign some sort of identifier to our script tags that helps the scraper detect them, along with a data attribute that specifies what component the script tag belongs to. Inside of the script tag we then toss a JSON object with all of our data that we need passed to the component. From there it’s more or less the same, apart from our loader looking for the script tags rather than filling up a queue.</p>
<h3 id="The-Markup-1"><a href="#The-Markup-1" class="headerlink" title="The Markup"></a>The Markup</h3><p>First up we’ll look at the markup we’re going for. This will just need to be a JSON object with all of the data tossed into it. This works best for large amounts of data passed into the front end as JSON then dumped straight into the script tag, ideally to be used as a data store once it makes its way into whatever JS function will be taking care of it. This works for smaller amounts of data being used for different things, but it’s maybe not as clean when used in that way.</p>
<figure class="highlight html"><figcaption><span>component.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-use.component</span>=<span class="string">"path.to.your.component.Class"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"namespace-component"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Do awesome things --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--/* Example manually setting up props, including a json object as well */--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">class</span>=<span class="string">"js-scraper-data"</span> <span class="attr">data-component</span>=<span class="string">"linkedList"</span> <span class="attr">type</span>=<span class="string">"application/json"</span>&gt;</span><span class="javascript"></span></div><div class="line">&#123;</div><div class="line">    <span class="string">"id"</span>: <span class="string">"$&#123;component.id @ context='scriptToken'&#125;"</span>,</div><div class="line">    <span class="string">"moreUri"</span>: <span class="string">"$&#123;component.moreUri @ context='uri'&#125;"</span>,</div><div class="line">    <span class="string">"initialData"</span>: $&#123;component.storeData @ context=<span class="string">'unsafe'</span>&#125;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--/* Example with using a json object passed in from the back end */--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">class</span>=<span class="string">"js-scraper-data"</span> <span class="attr">data-component</span>=<span class="string">"linkedList"</span> <span class="attr">type</span>=<span class="string">"application/json"</span>&gt;</span><span class="javascript"></span></div><div class="line">$&#123;component.storeData @ context=<span class="string">'unsafe'</span>&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>As mentioned earlier, it’s pretty similar to the loader markup just sort of a different interpretation of it. The only bummer is that since we’re already specifying this as JSON, we can’t set the context of the JSON objects we’re passing in to <code>scriptString</code> otherwise we’ll run into parsing errors. This leaves us with only the <code>unsafe</code> context, which isn’t ideal but it works.</p>
<p>In this case we’re using the class <code>js-scraper-data</code> as our identifier so we can easily search for them from our scraper. We also add in a data attribute, <code>data-component</code>, to specify what component this script tag correlates with. From there it’s just a matter of constructing a JSON object of the data we want to pass through to our component and it’s ready to be scraped.</p>
<h3 id="The-scraper"><a href="#The-scraper" class="headerlink" title="The scraper"></a>The scraper</h3><p>Our scraper, similar to our loader, is going to be made up by two parts: the data scraper and the component runner, and it differs in that it can be placed outside of the head in the main JS file and it will fire off the components as it gets them, rather than adding them to a queue.</p>
<figure class="highlight javascript"><figcaption><span>namespace.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.namespace = <span class="built_in">window</span>.namespace || &#123;&#125;;</div><div class="line">namespace.components = <span class="built_in">window</span>.namespace.components || &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Stores initialized components for debugging</span></div><div class="line">namespace.activeComponents = [];</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates through the identified script tags, parses them, then passes</div><div class="line"> * the data along to runComponent for initialization and storage.</div><div class="line"> */</div><div class="line">namespace.scrapeComponents = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> scripts = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.js-scraper-data'</span>),</div><div class="line">        numComponents = scripts.length;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numComponents; ++i) &#123;</div><div class="line">        <span class="keyword">var</span> name = scripts[i].dataset.component,</div><div class="line">            data = <span class="built_in">JSON</span>.parse(scripts[i].innerText);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.runComponent(name, data);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Initializes and stores the component passed to it in activeComponents.</div><div class="line"> * @param component String - name of the component</div><div class="line"> * @param data Object - parameters to pass to the component</div><div class="line"> */</div><div class="line">namespace.runComponent = <span class="function"><span class="keyword">function</span> (<span class="params">component, data</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.components.hasOwnProperty(component)) &#123;</div><div class="line">        <span class="keyword">this</span>.activeComponents.push( <span class="keyword">this</span>.components[component](data) );</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'Component Scraper: Could not find component'</span>, component);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$(<span class="built_in">document</span>).on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    namespace.scrapeComponents();</div><div class="line">    <span class="comment">// Do other cool global stuff</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The functions themselves should look similar by now, but as noted earlier the main way we get the components  has been swapped. We no longer have a queue, and while iterating through each instance of our identifier we immediately parse and hand it off to be initialized (lines #14-18).</p>
<p>This sort of adjustment does mean we have to make sure that we call our <code>namespace.scrapeComponents()</code> method <strong>AFTER</strong> we’ve stored all of our components accessibly. You <em>could</em> keep this in the head and follow a similar structure to the component loader, but that would mean you would have to include the methods and namespace setup separately and in the headlibs rather than with the rest of your code.</p>
<h2 id="Final-thoughts"><a href="#Final-thoughts" class="headerlink" title="Final thoughts"></a>Final thoughts</h2><p>The three methods included in this post are all unique in their own way and all have their own strengths and weaknesses. Data attributes work absolutely great for the majority of situations, but can be ugly and are not suitable what-so-ever for large amounts of JSON data; the component loader works great for all situations but can be incredibly heavy-handed and unnecessary for simple components; the component scraper, like the component loader, works great for when you have a large amount of JSON data that needs to get passed along to the Javascript but again is complete overkill for the majority of simple components.</p>
<p>Which is the best solution? That depends fully on the project and the type of data that needs to be moved around, but hopefully these give you some ideas to build off of to come up with the perfect solution for your next project.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/passing-data-from-aem6-to-javascript/" data-id="cizy4qyeg0009ahpg2ajqrhtv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/adobe-cq/">adobe cq</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aem6/">aem6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sightly/">sightly</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-simplified-aem-frontend-sass" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/simplified-aem-frontend-sass/" class="article-date">
  <time datetime="2016-05-04T08:15:10.000Z" itemprop="datePublished">4 May, 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/simplified-aem-frontend-sass/">A simplified front end architecture solution for AEM</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Tl-dr"><a href="#Tl-dr" class="headerlink" title="Tl;dr"></a>Tl;dr</h2><blockquote>
<ul>
<li>Simplify your build process using some of AEM’s built-in features.</li>
<li>Use a Maven Sass plugin so you’re not limited to plain-old CSS or forcing back end devs to deal with gulp builds.</li>
<li>Create a simplified and optional gulp workflow that will sling updated files to AEM.</li>
</ul>
</blockquote>
<p><a href="http://www.adobe.com/marketing-cloud/enterprise-content-management.html" target="_blank" rel="external">AEM (Adobe Experience Manager)</a> isn’t the most front end developer friendly enterprise content management solution out there. It’s extremely heavy-handed and dependent on <a href="https://maven.apache.org/" target="_blank" rel="external">Maven</a> builds that generally don’t have access to a lot of the goodies us front end developers have grown accustom to in the instantaneous <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a> utopia. Out of the box you’re dealing with plain-old CSS and having to wait for long builds to finish to see if your 1-line change worked, who does that anymore?</p>
<p>There are a few solutions to this problem, one being (shameless plug) <a href="https://github.com/jzeltman/iron" target="_blank" rel="external">Iron (fe)</a> which is an AEM front end framework I helped out on that includes a component generator. Iron extracts the entire front end code out into a separate, independent space then builds, bundles and pushes your front end to AEM. It works for very complex projects however it’s massive overkill for simple AEM implementations, requires some ramp-up time for devs to get use to its structure, and can also provides complications for back end developers and architects.</p>
<h2 id="A-simple-solution"><a href="#A-simple-solution" class="headerlink" title="A simple solution"></a>A simple solution</h2><p>After trying out a lot of different architectures I came up with a slightly opinionated solution that has worked extremely well so far. It keeps things simple and goes back to the question of <em>“what exactly is required for this project that AEM cannot provide out of the box?”</em></p>
<p>Let’s take a look at what this will take care of:</p>
<ul>
<li>Sass for styles compiled via Maven build (no compiled code in source control, anyone/anything can run a build)</li>
<li>JavaScript concatenation via AEM</li>
<li>Predictable file structure</li>
<li>Optional automagic builds and file deployment to AEM</li>
</ul>
<p>While that’s not a huge list of features it’s a good platform to start from for the majority of projects, and provides the bare necessities for efficient and quick front end development while not causing any headaches for architects or back end devs.</p>
<h2 id="File-Structure"><a href="#File-Structure" class="headerlink" title="File Structure"></a>File Structure</h2><p>File structure and location is completely subjective, however I will say that the structure outlined here has been the most pleasant to work with compared to other front end AEM structures I’ve worked with. I tried to put everything in predictable locations as one of my biggest pet peeves with AEM is that there are so many different directories it’s incredibly difficult to find stuff the majority of the time.</p>
<p><img src="/img/aem-fe/structure-diagram.png" alt="Front end structure diagram"></p>
<p>As you can see from the diagram above, the code is essentially split up based on type:</p>
<ul>
<li>Component-specific templates, scripts, and styles are all within <code>jcr_root/apps/{namespace}/components/content</code></li>
<li>Global/utility styles and scripts, vendor libraries, and static assets are all within <code>jcr_root/etc/designs/{namespace}/</code></li>
</ul>
<p>This more or less goes along with standard practice and means that assets are predictable and easy to find. If you’re developing a carousel component there’s no constant switching between two massively separate directories, all of the code relative to the carousel is in <em>one</em> place, it’s completely self-contained. From a maintenance point of view alone this sort of modular structure enhances maintainability and ease of onboarding massively.</p>
<p><img src="/img/aem-fe/component-diagram.png" alt="Component-specific structure diagram"></p>
<p>Given that the majority of the time you’ll have a few extra vendor libraries and a couple global/utility files (namespace creation/general event binding and library instantiation on the JavaScript side, mixin/variable declarations and shared layout/utility class declarations on the Sass side), tossing a large amount of styles and scripts randomly in the component content section would pollute that hierarchy and really isn’t semantically correct as they are design-related. That’s where the <code>etc/designs</code> hierarchy comes into play.</p>
<p><img src="/img/aem-fe/designs-diagram.png" alt="Global/utility designs structure diagram"></p>
<p>The designs section is a little more open to interpretation as every project is going to be different and everybody likes to structure things their own way. The one important caveat to note is that the main <code>.scss</code> file needs to be completely independent from the rest of the sass files, otherwise you’ll wind up with every single one of your source <code>.scss</code> files being converted into <code>.css</code> files. Trust me, you don’t want that. In the case of the diagram above, with this in mind the <code>styles/</code> directory would contain 1 file: <code>main.scss</code> and that would import the files in the <code>sass/</code> directory and get built into <code>main.css</code>.</p>
<h2 id="Getting-Sass-to-work"><a href="#Getting-Sass-to-work" class="headerlink" title="Getting Sass to work"></a>Getting Sass to work</h2><p>Now that we’ve got a general idea of where things should go we can start setting up some scaffolding and get an actual build running. We’ll start with getting our <a href="https://maven.apache.org/" target="_blank" rel="external">Maven</a> build compiling Sass first since that’s the biggest hurdle.</p>
<p>Before we continue, there are ways to have Maven download and install npm and everything necessary to run your build at run time, however I’ve seen this work inconsistently and I’ve heard it can cause issues on some environments. What we’re after is a simplified solution that will run anywhere, anytime consistently.</p>
<h3 id="The-Maven-build"><a href="#The-Maven-build" class="headerlink" title="The Maven build"></a>The Maven build</h3><p>I’ve tried a few different Maven plugins for Sass compilation, and so far my favorite has been the <a href="https://github.com/warmuuh/libsass-maven-plugin" target="_blank" rel="external">libsass-maven-plugin</a> by <a href="https://github.com/warmuuh" target="_blank" rel="external">@warmuuh</a>. It’s essentially just a wrapper for libsass so it’s very robust in the options it provides, however there are some limitations that you may have to play around with to find workarounds.</p>
<p>All we have to do is add the plugin to our UI pom and configure it to use the correct files and paths.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- /(namespace)-ui/pom.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.warmuuh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>libsass-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.6-libsass_3.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile-sass<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">inputPath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/content/jcr_root/etc/designs/(namespace)/styles<span class="tag">&lt;/<span class="name">inputPath</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">includePath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/content/jcr_root/etc/designs/(namespace)/sass:$&#123;project.basedir&#125;/src/main/content/jcr_root/apps/(namespace)/components<span class="tag">&lt;/<span class="name">includePath</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">outputPath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/content/jcr_root/etc/designs/(namespace)/css<span class="tag">&lt;/<span class="name">outputPath</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">outputStyle</span>&gt;</span>compressed<span class="tag">&lt;/<span class="name">outputStyle</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">generateSourceMap</span>&gt;</span>true<span class="tag">&lt;/<span class="name">generateSourceMap</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">sourceMapOutputPath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/content/jcr_root/etc/designs/(namespace)/css<span class="tag">&lt;/<span class="name">sourceMapOutputPath</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">omitSourceMapingURL</span>&gt;</span>true<span class="tag">&lt;/<span class="name">omitSourceMapingURL</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- . . . --&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<p>It’s a pretty typical plugin definition until we get to the configuration block, which is where the magic happens. We’re doing the following:</p>
<ul>
<li><code>&lt;inputPath&gt;</code>: Tell it to use our main files directory as the source. It will compile every single <code>.scss</code> file inside of this directory, so its best to have your main file separated from the rest of your code for this reason.</li>
<li><code>&lt;includePath&gt;</code>: Set both our main source code directory (<code>etc/designs/namespace/sass</code>) and component content directory (<code>apps/namespace/components</code>) as paths the compiler should look in when handling an <code>@import</code> declaration.</li>
<li><code>&lt;outputPath&gt;</code>: Set where the compiled css file should be saved.</li>
<li><code>&lt;outputStyle&gt;</code>: Tell it to compress (minify) the output.</li>
<li><code>&lt;generateSourceMap&gt;</code>: Have the compiler also generate a source map for easier debugging during development.</li>
<li><code>&lt;sourceMapOutputPath&gt;</code>: Tell the compiler where the compiled source map should be saved.</li>
<li><code>&lt;omitSourceMapingURL&gt;</code>: That property name isn’t a typo. This just tells the compiler to not automatically inject the source map URL into the finished <code>.css</code> file. This was something that needs to be set to true and a URL manually added to the main sass file for Source Maps to work an, I found out the hard way.</li>
</ul>
<p>Now if we had any code in those directories and we ran a Maven build we’d wind up with a compiled css file and source map wherever we told the compiler to save them. Saucy!</p>
<h3 id="Setting-up-some-Sass-scaffolding"><a href="#Setting-up-some-Sass-scaffolding" class="headerlink" title="Setting up some Sass scaffolding"></a>Setting up some Sass scaffolding</h3><p>I won’t go too much in detail in this section, but rather go over some caveats and provide an example of how you could get up and running quickly. The example will include <a href="http://getbootstrap.com/" target="_blank" rel="external">Bootstrap</a>, but can obviously be altered to use any front end framework such as <a href="http://foundation.zurb.com/" target="_blank" rel="external">Foundation</a> or <a href="http://semantic-ui.com/" target="_blank" rel="external">Semantic UI</a>.</p>
<h4 id="The-globals-sass-source-directory"><a href="#The-globals-sass-source-directory" class="headerlink" title="The globals/sass source directory"></a>The globals/sass source directory</h4><p>We’ll start out with the <code>etc/designs/namespace/sass</code> directory, or our actual <em>Sass source</em>. Since every project I implement Bootstrap on it winds up getting heavily extended and customized, I prefer to include the actual Bootstrap source so I can hand pick exactly what gets built and what gets ignored. The source would get tossed into the <em>Sass source</em> directory into a directory <code>bootstrap/</code>. Along with the source code of our framework of choice we’d create some global/utility sass files that we can use for general Sass environment setup and shared or utility classes. Here’s an example of what this directory may look like after this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">bootstrap/          <span class="comment">// The source code for our framework of choice.</span></div><div class="line">_variables.scss     <span class="comment">// Site-wide Sass variables.</span></div><div class="line">_mixins.scss        <span class="comment">// Any custom mixins your code requires.</span></div><div class="line">_utils.scss         <span class="comment">// Utility classes such as floats, clears, show/hide classes.</span></div><div class="line">components.scss     <span class="comment">// Component bulk-import file.</span></div><div class="line">layout.scss         <span class="comment">// Layout-specific styles, such as page template scaffolding.</span></div><div class="line">icons.scss          <span class="comment">// Custom icon declarations.</span></div><div class="line">forms.scss          <span class="comment">// Global form styles.</span></div><div class="line">typography.scss     <span class="comment">// Global typography such as headers, color options, links, etc.</span></div><div class="line">globals.scss        <span class="comment">// Global styles that don't really fit in anywhere else.</span></div></pre></td></tr></table></figure>
<p>By far and away the most important file in the above example is <code>components.scss</code>, which bulk-<code>@import</code>‘s all component styles for inclusion in the style sheet. This makes important use of that <code>includePath</code> property we set in the Sass compiler plugin so that the <code>@import</code> declarations are far more readable than they would be otherwise:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// etc/designs/namespace/sass/components.scss</div><div class="line"></div><div class="line">/* . . . */</div><div class="line">@import "content/carousel/carousel.scss";</div><div class="line">@import "content/linkedlist/linkedlist.scss";</div><div class="line">/* . . . */</div></pre></td></tr></table></figure>
<p>Since we set that include path, we can request the component files relative to the component content. Super cool! One observation I will note from the last project using this structure was that sometimes I would find this file somewhat inconvenient to get to all the way over here in designs. Semantically it works great, but if I didn’t already have the file open in my editor I was always a bit annoyed to have to go all the way over to the designs directory to open it up and add a new component. That being said, you could probably move it somewhere closer to the components and it would be totally fine, such as <code>apps/namespace/components/components.scss</code>.</p>
<h4 id="The-main-file"><a href="#The-main-file" class="headerlink" title="The main file"></a>The main file</h4><p>Now we’ll add our main file that will be used by the compiler to compile our stylesheet. This is in that <code>etc/designs/namespace/styles</code> directory, and can be named whatever you want. I have a habit of naming it <code>main.scss</code> so I can expect the resulting css file to be <code>main.css</code>. This file is essentially just a bulk-importing file that will go through and import all of globals and framework files, followed by all of the components. If you chose to have the compiler generate a Source Map this file will also need a comment of the URL of the compiled source map added to the bottom of it.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">// etc/designs/namespace/styles/main.scss</div><div class="line"></div><div class="line">// Custom Variables and mixins</div><div class="line">@import "variables";</div><div class="line">@import "mixins";</div><div class="line">@import "icons";</div><div class="line"></div><div class="line">// Bootstrap imports</div><div class="line">/*</div><div class="line">  Removing vast majority of them since there are so many,</div><div class="line">  but you essentially just copy the entire `bootstrap.scss`</div><div class="line">  file into here with your own overrides scattered in between.</div><div class="line">*/</div><div class="line">@import "bootstrap/variables";</div><div class="line">@import "bootstrap/mixins";</div><div class="line">// More bootstrap imports...</div><div class="line"></div><div class="line">// Core Overrides</div><div class="line">@import "type";</div><div class="line">@import "layout";</div><div class="line"></div><div class="line">// Bootstrap Components...</div><div class="line"></div><div class="line">// Globals</div><div class="line">@import "utils";</div><div class="line">@import "forms";</div><div class="line">@import "globals";</div><div class="line"></div><div class="line">// Components</div><div class="line">@import "components";</div><div class="line"></div><div class="line">/*!# sourceMappingURL=namespace/css/main.css.map */</div></pre></td></tr></table></figure>
<p>The file is a pretty standard main file, with the exception of the source map URL declaration at the very bottom. I tried to remove as much of the Bootstrap stuff as I could to save space, but I left some to show how you’d include them thanks to the relative include paths.</p>
<h4 id="Some-dummy-component-files"><a href="#Some-dummy-component-files" class="headerlink" title="Some dummy component files"></a>Some dummy component files</h4><p>Now I’ll just show some dummy components to give you the idea of how you’ll import them. Let’s say we have a super complex component we need to create called the List component, back end has already finished the backing class for it and it just needs front end now. First we’ll go in and add that file to our <code>components.scss</code> file:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// etc/designs/namespace/sass/components.scss</div><div class="line"></div><div class="line">@import "content/carousel/carousel.scss";</div><div class="line">@import "content/linkedlist/linkedlist.scss";</div><div class="line">@import "content/list/list.scss";   // Our new component</div></pre></td></tr></table></figure>
<p>Then we’d just create the <code>.scss</code> file in it’s component folder. Easy peazy.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// apps/namespace/components/content/list/list.scss</div><div class="line"></div><div class="line">ul.namespace-list &#123;</div><div class="line">  list-style: none;</div><div class="line">  padding-left: 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Creating-clientlibs"><a href="#Creating-clientlibs" class="headerlink" title="Creating clientlibs"></a>Creating clientlibs</h2><p>At this stage if we were to run a Maven build we’d wind up with shiny new <code>main.css</code> and <code>main.css.map</code> files in our <code>etc/designs/namespace/css</code> directory. As great as that is, as far as AEM is concerned there are just some annoying files filling up precious space and not doing anything, so now is a perfect time to start creating some clientlibs.</p>
<p>We’re going to wind up having 3 different clientlib categories:</p>
<ul>
<li><code>namespace-frontend.design</code>: Main clientlib category containing all of the global styles and scripts.</li>
<li><code>namespace-frontend.components</code>: A complimentary design category that will be embedded into the main category.</li>
<li><code>namespace-frontend.vendor</code>: All of our vendor/external clientlibs.</li>
</ul>
<h3 id="Our-main-clientlib"><a href="#Our-main-clientlib" class="headerlink" title="Our main clientlib"></a>Our main clientlib</h3><p>We’ll start with the <code>namespace-frontend.designs</code> clientlib since that’s our main clientlib that will be included in our templates. We embed the components clientlib category in this one</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- etc/designs/namespace/.content.xml --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">jcr:root</span> <span class="attr">xmlns:sling</span>=<span class="string">"http://sling.apache.org/jcr/sling/1.0"</span> <span class="attr">xmlns:jcr</span>=<span class="string">"http://www.jcp.org/jcr/1.0"</span> <span class="attr">xmlns:rep</span>=<span class="string">"internal"</span></span></div><div class="line">    <span class="attr">jcr:mixinTypes</span>=<span class="string">"[rep:AccessControllable]"</span></div><div class="line">    <span class="attr">jcr:primaryType</span>=<span class="string">"cq:ClientLibraryFolder"</span></div><div class="line">    <span class="attr">sling:resourceType</span>=<span class="string">"widgets/clientlib"</span></div><div class="line">    <span class="attr">embed</span>=<span class="string">"[namespace-frontend.components]"</span></div><div class="line">    <span class="attr">categories</span>=<span class="string">"[namespace-frontend.design]"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure>
<p>With that in our design root we’ll then just set our main compiled CSS file to be included in this clientlib as well as any javascript files we need. The only thing of note here is that we’re embedding our component category into this clientlib so that it will be included whenever we inject this clientlib into our templates.</p>
<pre>
# etc/designs/namespace/css.txt
#base=css

main.css
</pre>
<pre>
# etc/designs/namespace/js.txt
#base=js

main.js
utils.js
</pre>

<p>This should be pretty standard for anybody who has made clientlibs before, all we’re doing is directing the clientlib to our files.</p>
<h3 id="Vendor-libraries"><a href="#Vendor-libraries" class="headerlink" title="Vendor libraries"></a>Vendor libraries</h3><p>Chances are you’re going to need to include some sort of JavaScript or CSS library on your project, so that’s where our vendor clientlib comes into play. This is going to be a separate category than our main design clientlib, so we’re tossing this into the <code>vendor/</code> directory of our design directory.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- etc/designs/namespace/vendor/.content.xml --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">jcr:root</span> <span class="attr">xmlns:sling</span>=<span class="string">"http://sling.apache.org/jcr/sling/1.0"</span> <span class="attr">xmlns:jcr</span>=<span class="string">"http://www.jcp.org/jcr/1.0"</span> <span class="attr">xmlns:rep</span>=<span class="string">"internal"</span></span></div><div class="line">    <span class="attr">jcr:mixinTypes</span>=<span class="string">"[rep:AccessControllable]"</span></div><div class="line">    <span class="attr">jcr:primaryType</span>=<span class="string">"cq:ClientLibraryFolder"</span></div><div class="line">    <span class="attr">sling:resourceType</span>=<span class="string">"widgets/clientlib"</span></div><div class="line">    <span class="attr">categories</span>=<span class="string">"[namespace-frontend.vendor]"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure>
<p>In typical AEM fashion, the libraries going in the <code>vendor/</code> directory get split up into <code>css/</code> and <code>js/</code> directories, which we’ll just include via the <code>css.txt</code> and <code>js.txt</code> files in the vendor root.</p>
<pre>
# etc/designs/namespace/vendor/js.txt
#base=js

bootstrap.carousel.js
bootstrap.collapse.js
jquery.validate.js
</pre>

<h3 id="Adding-component-scripts"><a href="#Adding-component-scripts" class="headerlink" title="Adding component scripts"></a>Adding component scripts</h3><p>Now we’ve got all of our vendor libraries set up, our main scripts and all of our styles ready to go, but now it’s time to get component-specific javascript hooked into everything. This is where we’re going to make use of that <code>namespace-frontend.components</code> clientlib category.  Each component that requires a script will have it’s own clientlib declaration that mates it to that category, which if you’ll remember from earlier is being embedded into our main designs clientlib.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- apps/namespace/components/content/linkedlist/js/.content.xml --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">jcr:root</span> <span class="attr">xmlns:sling</span>=<span class="string">"http://sling.apache.org/jcr/sling/1.0"</span> <span class="attr">xmlns:jcr</span>=<span class="string">"http://www.jcp.org/jcr/1.0"</span> <span class="attr">xmlns:rep</span>=<span class="string">"internal"</span></span></div><div class="line">    <span class="attr">jcr:mixinTypes</span>=<span class="string">"[rep:AccessControllable]"</span></div><div class="line">    <span class="attr">jcr:primaryType</span>=<span class="string">"cq:ClientLibraryFolder"</span></div><div class="line">    <span class="attr">sling:resourceType</span>=<span class="string">"widgets/clientlib"</span></div><div class="line">    <span class="attr">categories</span>=<span class="string">"[namespace-frontend.components]"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure>
<pre>
# apps/namespace/components/content/linkedlist/js/js.txt
linkedlist.js
linkedlist.item.js
</pre>

<p>It’s worth noting that the structure of the component directory is completely subjective. You can have something like:</p>
<pre>
apps/namespace/components/content/linkedlist/
  js/
    .content.xml
    js.txt
    linkedlist.js
</pre>

<p>or:</p>
<pre>
apps/namespace/components/content/linkedlist/
  .content.xml
  js.txt
  js/
    linkedlist.js
</pre>

<p>The concept is the same, so use whichever structure works for you and your project.</p>
<h3 id="Adding-our-clientlibs-to-templates"><a href="#Adding-our-clientlibs-to-templates" class="headerlink" title="Adding our clientlibs to templates"></a>Adding our clientlibs to templates</h3><p>This should be pretty trivial to anyone who is already well-versed in clientlibs in AEM, so I won’t go into extreme detail on this. All you need to do is include the main design clientlib category and our vendor clientlib. I generally have my vendor libraries included before my main designs.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- apps/namespace/components/page/global/head.html --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">data-sly-use.clientLib</span>=<span class="string">"$&#123;'/libs/granite/sightly/templates/clientlib.html'&#125;"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-unwrap</span> <span class="attr">data-sly-call</span>=<span class="string">"$&#123;clientLib.css @ categories='namespace-frontend.vendor'&#125;"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-unwrap</span> <span class="attr">data-sly-call</span>=<span class="string">"$&#123;clientLib.css @ categories='namespace-frontend.design'&#125;"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- apps/namespace/components/page/global/body.html --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">data-sly-use.clientLib</span>=<span class="string">"$&#123;'/libs/granite/sightly/templates/clientlib.html'&#125;"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"wrapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">header</span> <span class="attr">id</span>=<span class="string">"header"</span> <span class="attr">data-sly-include</span>=<span class="string">"header.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">data-sly-include</span>=<span class="string">"content.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">footer</span> <span class="attr">id</span>=<span class="string">"footer"</span> <span class="attr">data-sly-include</span>=<span class="string">"footer.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-unwrap</span> <span class="attr">data-sly-call</span>=<span class="string">"$&#123;clientLib.js @ categories='namespace-frontend.vendor'&#125;"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">sly</span> <span class="attr">data-sly-unwrap</span> <span class="attr">data-sly-call</span>=<span class="string">"$&#123;clientLib.js @ categories='namespace-frontend.design'&#125;"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Now we have a working Sass build via Maven, component styles/scripts in predictable locations, connected global/utility styles/scripts and vendor libraries. If you have no need for Gulp automation for quicker builds and code deployment to AEM you should be ready to start developing. If not, all that’s left is setting up our optional Gulp build.</p>
<h2 id="Gulp-Automation-for-the-time-savings"><a href="#Gulp-Automation-for-the-time-savings" class="headerlink" title="Gulp Automation for the time-savings"></a>Gulp Automation for the time-savings</h2><p>One of the things that really bugs me about most standard AEM setups is that if I need to make a 1-line change to some CSS, JavaScript or template my only options are using CRX/DE (yuck) or running a full Maven build (yuck). Let’s bring this build into the modern era with a gulp setup that will automagically sling our compiled Sass and other files to AEM on file change so we’re not stuck waiting for slow Maven build.</p>
<p>For the bare minimum all you really need as far as <a href="https://www.npmjs.com/" target="_blank" rel="external">npm</a> packages go is <a href="https://www.npmjs.com/package/gulp-slang" target="_blank" rel="external">gulp-slang</a> to auto-sling the files to AEM, which you can then fire off in a task or watch block.</p>
<p>If you’re interested in an example gulp file, we’ll set up one with sass compilation, <a href="http://jshint.com/" target="_blank" rel="external">jslinting</a> and auto-slinging whenever a style, script, or template is updated. First off we need to install some <a href="https://www.npmjs.com/" target="_blank" rel="external">npm</a> packages in our absolute project root and initialize our npm project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">npm init</div><div class="line"></div><div class="line"><span class="comment"># utils</span></div><div class="line">npm install --save-dev gulp gulp-watch gulp-plumber gulp-rename gulp-util gulp-watch</div><div class="line"></div><div class="line"><span class="comment"># style-related</span></div><div class="line">npm install --save-dev gulp-sass gulp-sourcemaps</div><div class="line"></div><div class="line"><span class="comment"># script related</span></div><div class="line">npm install --save-dev jshint gulp-jshint</div><div class="line"></div><div class="line"><span class="comment"># aem related</span></div><div class="line">npm install --save-dev gulp-slang</div></pre></td></tr></table></figure>
<p>From there we can start on our <code>gulpfile.js</code> by requiring everything we need up at the top of the file:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="keyword">var</span> gulp        = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">    watch       = <span class="built_in">require</span>(<span class="string">'gulp-watch'</span>),</div><div class="line">    <span class="comment">// Utilities</span></div><div class="line">    gutil       = <span class="built_in">require</span>(<span class="string">'gulp-util'</span>),</div><div class="line">    plumber     = <span class="built_in">require</span>(<span class="string">'gulp-plumber'</span>),</div><div class="line">    slang       = <span class="built_in">require</span>(<span class="string">'gulp-slang'</span>),</div><div class="line">    rename      = <span class="built_in">require</span>(<span class="string">'gulp-rename'</span>),</div><div class="line">    <span class="comment">// Styles</span></div><div class="line">    sass        = <span class="built_in">require</span>(<span class="string">'gulp-sass'</span>),</div><div class="line">    sourcemaps  = <span class="built_in">require</span>(<span class="string">'gulp-sourcemaps'</span>),</div><div class="line">    <span class="comment">// Scripts</span></div><div class="line">    jshint      = <span class="built_in">require</span>(<span class="string">'gulp-jshint'</span>);</div></pre></td></tr></table></figure>
<p>We then want to specify the paths that we need. This helps readability and maintainability, as namespaces can sometimes change mid-project and if you don’t have relative paths this can be a <em>nightmare</em> to refactor.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js, continued</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Paths */</span></div><div class="line"><span class="keyword">var</span> root        = <span class="string">'namespace-ui/src/main/content/jcr_root/'</span>,</div><div class="line">    components  = root + <span class="string">'apps/namespace/components/'</span>,</div><div class="line">    designs     = root + <span class="string">'etc/designs/namespace/'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Styles</span></div><div class="line">    cssPath     = designs + <span class="string">'css/'</span>,</div><div class="line">    sassPath    = designs + <span class="string">'sass/'</span>,</div><div class="line">    mainCss     = designs + <span class="string">'styles/main.scss'</span>,</div><div class="line">    cssBuild    = cssPath + <span class="string">'main.css'</span>,</div><div class="line">    cssSrcMaps  = cssPath + <span class="string">'main.css.map'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Scripts</span></div><div class="line">    jsPath      = designs + <span class="string">'js/'</span>,</div><div class="line">    vendorPath  = designs + <span class="string">'vendor/'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Images</span></div><div class="line">    imgPath     = designs + <span class="string">'img/'</span>;</div></pre></td></tr></table></figure>
<p>I generally like my console nice and colorful, so before any tasks I usually include some sort of colorful event notification utility function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js, continued</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Paths */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Helper: changeNotification</div><div class="line"> * Logs an event to the console.</div><div class="line"> *</div><div class="line"> * @param &#123;String&#125; fType - The file type that was changed.</div><div class="line"> * @param &#123;String&#125; eType - The event that occured.</div><div class="line"> * @param &#123;String&#125; msg - Short description of the actions that are being taken.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeNotification</span>(<span class="params">fType, eType, msg</span>) </span>&#123;</div><div class="line">  gutil.log(gutil.colors.cyan.bold(fType), <span class="string">'was'</span>, gutil.colors.yellow.bold(eType) + <span class="string">'.'</span>, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now we need to set up our sass builds. The key here is to try to replicate the sass build that the Maven build does as closely as possible so there are no noticeable differences between the Gulp build and Maven build. We do this by configuring sass with the same settings we authored in our pom file, creating a task that we can reference in other tasks as well as fire off ourselves when needed, then setting up a task to sling the shiny new files to AEM.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js, continued</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Paths */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* changeNotification */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Task: `sass:build`</div><div class="line"> * Compiles the sass and writes sourcemaps.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'sass:build'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</div><div class="line">    gulp.src(mainCss)</div><div class="line">        .pipe(plumber()) <span class="comment">// Prevents pipe breaking due to error (for watch task)</span></div><div class="line">        .pipe(sourcemaps.init())</div><div class="line">        .pipe(sass(&#123;</div><div class="line">            <span class="attr">outputStyle</span>: <span class="string">'compressed'</span>,</div><div class="line">            <span class="attr">omitSourceMapUrl</span>: <span class="literal">true</span>, <span class="comment">// This is hardcoded in the main.scss due to resource path issues</span></div><div class="line">            includePaths: [sassPath, components]</div><div class="line">        &#125;).on(<span class="string">'error'</span>, sass.logError))</div><div class="line">        .pipe(sourcemaps.write(<span class="string">'./'</span>, &#123;</div><div class="line">            <span class="attr">addComment</span>: <span class="literal">false</span></div><div class="line">        &#125;))</div><div class="line">        .pipe(plumber.stop())</div><div class="line">        .pipe(gulp.dest(cssPath));</div><div class="line"></div><div class="line">  <span class="comment">// Fire the callback Gulp passes in to tell it we're done</span></div><div class="line">  cb();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Task: `sass:sling`</div><div class="line"> * Slings the compiled stylesheet and sourcemaps to AEM.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'sass:sling'</span>, [<span class="string">'sass:build'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> gulp.src([cssBuild, cssSrcMaps])</div><div class="line">    .pipe(slang());</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Task: `sass`</div><div class="line"> * Runs the sass build and slings the results to AEM.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'sass'</span>, [<span class="string">'sass:build'</span>, <span class="string">'sass:sling'</span>]);</div></pre></td></tr></table></figure>
<p>Next up our JavaScript task, which in this particular instance is extremely light. All we’ll be doing is setting up some simple jslinting to keep silly errors at bay in our JS. We won’t be minifying the JS as that can be done by AEM out of the box, and we want to make sure this Gulp build is complementary to the Maven build, not a pre-requisite.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js, continued</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Paths */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* changeNotification */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Sass tasks */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Task: `js:lint`</div><div class="line"> * Lints project JS, excluding vendor libs.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'js:lint'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> gulp.src([components + <span class="string">'**/*.js'</span>, jsPath + <span class="string">'**/*.js'</span>])</div><div class="line">    .pipe(jshint())</div><div class="line">    .pipe(jshint.reporter(<span class="string">'default'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Last up will be our watch task, which will monitor all template files, scripts and styles for changes so that it can kick off builds immediately. We’re going to set up a watch stream for each type of file, which will then kick off a build or deployment for that particular type of code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gulpfile.js, continued</span></div><div class="line"><span class="comment">/* Requires */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Paths */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* changeNotification */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* Sass tasks */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"><span class="comment">/* JS tasks */</span></div><div class="line"><span class="comment">// . . .</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Task: `watch`</div><div class="line"> * Watches the HTML, Sass, and JS for changes. On a file change,</div><div class="line"> * will run builds file-type dependently and sling the new files</div><div class="line"> * up to AEM.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'watch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  gutil.log(<span class="string">'Waiting for changes.'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Set up our streams</span></div><div class="line">  <span class="keyword">var</span> jsWatch = gulp.watch([components + <span class="string">'**/*.js'</span>, jsPath + <span class="string">'**/*.js'</span>], [<span class="string">'js:lint'</span>]),</div><div class="line">      sassWatch = gulp.watch([components + <span class="string">'**/*.scss'</span>, mainCss, sassPath + <span class="string">'**/*.scss'</span>], [<span class="string">'sass'</span>]),</div><div class="line">      markupWatch = gulp.watch([components + <span class="string">'**/**/*.html'</span>, components + <span class="string">'**/**/*.jsp'</span>]),</div><div class="line">      imgWatch = gulp.watch([imgPath + <span class="string">'**/*'</span>]);</div><div class="line"></div><div class="line">  <span class="comment">// js needs to be linted</span></div><div class="line">  jsWatch.on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">    changeNotification(<span class="string">'JS file'</span>, ev.type, <span class="string">'Linting code &amp; slinging to AEM.'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> gulp.src(ev.path)</div><div class="line">      .pipe(slang(ev.path));</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// Sass needs to get built and slung up</span></div><div class="line">  sassWatch.on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">    changeNotification(<span class="string">'Sass file'</span>, ev.type, <span class="string">'Running compilation &amp; slinging to AEM.'</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">// Markup just needs to be slung to AEM</span></div><div class="line">  markupWatch.on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">    changeNotification(<span class="string">'Sightly file'</span>, ev.type, <span class="string">'Slinging file to AEM.'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> gulp.src(ev.path)</div><div class="line">      .pipe(slang(ev.path));</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// Images just need to be slung to AEM</span></div><div class="line">  imgWatch.on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">    changeNotification(<span class="string">'Image file'</span>, ev.type, <span class="string">'Slinging file to AEM.'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> gulp.src(ev.path)</div><div class="line">      .pipe(slang(ev.path));</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So a quick recap on the commands this gulp build provides:</p>
<ul>
<li><code>gulp watch</code> - Watches for changes to JavaSript, CSS/Sass, and HTML files, runs any necessary subtasks and slings the result to AEM.</li>
<li><code>gulp sass</code> - Builds all Sass files and slings the compiled stylesheet and source maps to AEM.</li>
<li><code>gulp js:lint</code> - Runs all JavaScript files against JSHint and outputs the results to the console.</li>
</ul>
<p>Now, if we run <code>gulp watch</code> any component-level and global changes will automagically be built and slung to AEM far faster than it would take to run a Maven build. The best part of this is that it allows for easier front end development, but also allows for the front end to not add any more dependencies to the project that back end devs may not want to deal with. Plus, you don’t have to check in any compiled code to version control as the Maven build will generate the compiled code every time.</p>
<p>If you’d like to check out the gulpfile more in-depth, you can view it in its entirety <a href="https://github.com/aesinv/simple-aem-fe-example/blob/master/gulpfile.js" target="_blank" rel="external">on Github</a>. You can also browse through a full example of this hierarchy with all of the code from this post in place via <a href="https://github.com/aesinv/simple-aem-fe-example" target="_blank" rel="external">this repo</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/simplified-aem-frontend-sass/" data-id="cizy4qyeh000bahpgre33qjgq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/adobe-cq/">adobe cq</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aem/">aem</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gulp/">gulp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/maven/">maven</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sass/">sass</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-keeping-the-user-entertained-when-they-fail" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/game-dev/keeping-the-user-entertained-when-they-fail/" class="article-date">
  <time datetime="2016-04-30T18:22:31.000Z" itemprop="datePublished">30 April, 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/game-dev/">game dev</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/game-dev/keeping-the-user-entertained-when-they-fail/">Game Dev Log: Keeping the player entertained when they fail</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m quickly discovering that games are just like really complex or unmaintained websites: as you progress you quickly find that there are a lot more scenarios and screens you need to deal with that never even crossed your mind when you started. For me one of these was <em>“Wait, what happens when the player falls off a platform?”</em> I knew it was always something that was going to happen, especially considering the game is inspired by <em>Super Monkey Ball</em>, but I had never actually taken the time to figure out what would happen on the screen.</p>
<p>Considering I want to polish the game as much as possible and have it stand out from other mobile games, some hard cut back to the spawn point was way out of the question. Since the playable character is literally just a ball there’s really no fancy animations I can have him do. With that in mind, I came up with the idea of the camera stopping shortly after falling off but continuing to look in the direction of the player, wherever he is, and then making up for the lack of animations with some UI overlay.</p>
<h2 id="Dealing-with-the-physics"><a href="#Dealing-with-the-physics" class="headerlink" title="Dealing with the physics"></a>Dealing with the physics</h2><p>First I had to actually write in the player respawn scripts, which turned out to be the most difficult by far. After creating some large triggers underneath the stage area I wound up wasting a good few hours trying to figure out why my collision events wouldn’t fire, but discovered that I hilariously had my console filtered to error messages only. After that revelation things didn’t get easier though, as it turns out updating a <a href="http://docs.unity3d.com/ScriptReference/Rigidbody.html" target="_blank" rel="external">Rigidbody</a>‘s position in Unity when it’s under heavy force is more involved than simply updating it’s coordinates.</p>
<p>Aside from updating positions, it turns out you also need to zero out the objects <a href="http://docs.unity3d.com/ScriptReference/Rigidbody-velocity.html" target="_blank" rel="external">velocity</a> so they don’t respawn and continue to fly through the air at supersonic speeds. Furthermore, it turns out Unity has a quirk where you also have to deactivate / activate the <a href="http://docs.unity3d.com/ScriptReference/Rigidbody.html" target="_blank" rel="external">Rigidbody</a>. Without this hard reset the rigidbody can experience some really bizarre and jerky movement patterns after it’s been repositioned absolutely via transform rather than physics.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Pause the object</span></div><div class="line">rb.velocity = Vector3.zero;</div><div class="line">rb.angularVelocity = Vector3.zero;</div><div class="line">rb.useGravity = <span class="literal">false</span>;</div><div class="line">rb.isKinematic = <span class="literal">true</span>;</div><div class="line"></div><div class="line"><span class="comment">// Update to the new position</span></div><div class="line">transform.position = respawnPoint;</div><div class="line">origin.transform.rotation = Quaternion.identity;</div><div class="line"></div><div class="line"><span class="comment">// Unpause the object, including a hard activate reset</span></div><div class="line">gameObject.SetActive(<span class="literal">false</span>);</div><div class="line">gameObject.SetActive(<span class="literal">true</span>);</div><div class="line">rb.useGravity = <span class="literal">true</span>;</div><div class="line">rb.isKinematic = <span class="literal">false</span>;</div></pre></td></tr></table></figure>
<p>It’s not the prettiest code, but it works flawlessly. Plus as an added bonus I didn’t really have to do any more legwork for the camera and player origin since they’re directly relational to the position of the player object. I wound up breaking these blocks up into their own separate public functions so I could also re-use them for when I implement pausing the game (which is already implemented in a very rudimentary state as a result of this).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public <span class="function"><span class="keyword">function</span> <span class="title">pause</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// pause the object</span></div><div class="line">	rb.velocity = Vector3.zero;</div><div class="line">	rb.angularVelocity = Vector3.zero;</div><div class="line">	rb.useGravity = <span class="literal">false</span>;</div><div class="line">	rb.isKinematic = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public <span class="function"><span class="keyword">function</span> <span class="title">unpause</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// unpause the object, including a hard activate reset</span></div><div class="line">	gameObject.SetActive(<span class="literal">false</span>);</div><div class="line">	gameObject.SetActive(<span class="literal">true</span>);</div><div class="line">	rb.useGravity = <span class="literal">true</span>;</div><div class="line">	rb.isKinematic = <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public <span class="function"><span class="keyword">function</span> <span class="title">respawn</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	pause();</div><div class="line"></div><div class="line">	<span class="comment">// Update to the new position</span></div><div class="line">	transform.position = respawnPoint;</div><div class="line">	origin.transform.rotation = Quaternion.identity;</div><div class="line"></div><div class="line">	unpause();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Freezing-the-camera-until-respawn"><a href="#Freezing-the-camera-until-respawn" class="headerlink" title="Freezing the camera until respawn"></a>Freezing the camera until respawn</h2><p>Getting the detached camera functionality wound up being far easier than I anticipated, however it required quite a bit of refactoring of my main camera script. I ended up creating a state property that would dictate what the camera should be doing at that moment; then created methods for each state. Detaching is essentially just unbinding the position from the players position and continuing to fire <a href="http://docs.unity3d.com/ScriptReference/Transform.LookAt.html" target="_blank" rel="external">LookAt</a> so the camera will maintain its gaze on the user as he plummets to certain doom.</p>
<h2 id="Creating-an-overlay"><a href="#Creating-an-overlay" class="headerlink" title="Creating an overlay"></a>Creating an overlay</h2><p>There were two elements I to the overlay that I really wanted to capture:</p>
<ol>
<li>An amusing message that would (hopefully) keep the user entertained.</li>
<li>A similarly amusing image of our main <em>character</em> looking battered and bruised.</li>
</ol>
<p><img src="/img/game-respawn/respawn-screen.png" alt="The completed overlay"></p>
<h3 id="Amusing-variety"><a href="#Amusing-variety" class="headerlink" title="Amusing variety"></a>Amusing variety</h3><p>Keeping with the idea of details, I didn’t want to just toss in a static text field and be done with it. Having an array of potential messages and randomly choosing one to show to the user seemed far more appealing, so that’s what I went ahead and did. That way there would be a sense of variety and spontaneity, rather than a predictable and boring preset message.</p>
<p>Thanks to Unity’s public variable configuration this was cake. I just set a public variable to be an array of Strings (<code>String[]</code>), then in my <code>Start()</code> method have it generate a random number between zero and the length of the array, using that number to extract a message from the array and apply it to the text field. Done!</p>
<h3 id="Adding-the-character-into-the-mix"><a href="#Adding-the-character-into-the-mix" class="headerlink" title="Adding the character into the mix"></a>Adding the character into the mix</h3><p>Creating a variant of the main character to take a render of was extremely fun, and surprisingly didn’t take too long. I took his base texture and created an alternate version with far more bummed out eyes and tons of scratches/bruises all over him, tossed it into Unity and snagged a screenshot of him in front of a green cube so I could toss that into Photoshop and get a clean transparent picture.</p>
<p><img src="/img/game-respawn/injured-player-resized.png" alt="The result of the character render"></p>
<h3 id="Animating-and-finishing-up-UI"><a href="#Animating-and-finishing-up-UI" class="headerlink" title="Animating and finishing up UI"></a>Animating and finishing up UI</h3><p>In case you haven’t picked up on this yet, but I think static is boring. The more moving things the better! It was time to animate this screen for extra fancy points, so I loaded up the character image into Unity and opened up the <a href="http://docs.unity3d.com/Manual/class-Animator.html" target="_blank" rel="external">Animator</a> window for the first time on this project. I actually really enjoyed using it, it reminded me a lot of my Flash and video editing days way back when so it was super easy and quick to get up-to-speed with.</p>
<p>I wound up not having to use the states feature at all as there was only one state, and I was using the animations as transitions for the game objects when first activated. The only snag was making sure to turn off looping, which wasn’t as apparent as I would have expected it to be.</p>
<h3 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h3><p>While bundling everything together wasn’t necessarily difficult it did require quite a large amount of refactoring so I could get everything centralized. This involved creating a lot of public methods and finally busting out my <code>LevelController</code> script which I’m using for controlling and maintaining level-related data.</p>
<p>I cached the player/camera/timer objects and controllers in my level controller and started thinking up exactly what would need to happen so I could start creating public methods in the respective controllers. I wound up with the following:</p>
<ol>
<li>Pause the timer (<code>Timer Controller</code>)</li>
<li>Lock the camera (<code>Camera Controller</code>)</li>
<li>Activate the overlay (<code>Level Controller</code>)</li>
<li>Pause, reset, and respawn the player (<code>Player Controller</code>)</li>
<li>Re-bind the camera to the player (<code>Camera Controller</code>)</li>
<li>Restart the timer (<code>Timer Controller</code>)</li>
</ol>
<p>Since this is all pretty cut and dry and taking easy functionality and tossing it into public functions, we’ll just focus on the interesting bits of the level controller.</p>
<p>Whenever the player hits the out of bounds collision trigger, I made the object fire off the <code>playerFell()</code> method of the Level Controller, which is as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public <span class="function"><span class="keyword">function</span> <span class="title">playerFell</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// Freeze the camera and pause the timer</span></div><div class="line">	cameraController.freezeCamera();</div><div class="line">	gameTimer.stopTimer();</div><div class="line"></div><div class="line">	<span class="comment">// Load the overlay from resources and toss it into the interface canvas</span></div><div class="line">	<span class="keyword">var</span> fellOverlay : GameObject = Instantiate(Resources.Load(<span class="string">"fell-screen"</span>, GameObject));</div><div class="line">	fellOverlay.transform.SetParent(canvas.transform, <span class="literal">false</span>);</div><div class="line"></div><div class="line">	<span class="comment">// Let's let the player contemplate what went wrong</span></div><div class="line">	<span class="keyword">yield</span> WaitForSeconds(<span class="number">3.5</span>);</div><div class="line"></div><div class="line">	<span class="comment">// Remove the overlay and restart everything</span></div><div class="line">	Destroy(fellOverlay);</div><div class="line">	playerController.respawn();</div><div class="line">	cameraController.unfreezeCamera();</div><div class="line">	gameTimer.Restart();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Essentially, we’re freezing the state of the game for 3.5 seconds to load and show the “you failed” overlay then resetting everything back to the original positions/values when the level started. As we saw up when we were fooling with the player controller above, there’s quite a bit more going on however since everything is isolated into their own public methods it makes the main script a lot more easy to comprehend. The most interesting thing here is that I decided to load the overlay as a prefabbed resource. This is because <a href="https://youtu.be/vnF9YEm_pxk?t=29m28s" target="_blank" rel="external">resources don’t take up memory on mobile devices until instantiated</a>, so the overlay isn’t hogging any necessary memory when it’s not active.</p>
<div class="bg-video-wrap" style="background-image: url('/img/entertaining-player-when-they-fail.gif');"><br>  <video class="bg-video-player" autoplay loop><br>    <source src="/img/videos/entertaining-player-when-they-fail.mp4" type="video/mp4; codecs=avc1.42E01E,mp4a.40.2"><br>    <source src="/img/videos/entertaining-player-when-they-fail.webm" type="video/webm; codecs=vp8,vorbis"><br>  </video><br></div>

<p>That’s all for this episode of the dev log. I hope you enjoyed it, make sure to check out the other parts below:</p>
<ol>
<li>From concept to reality</li>
<li>Trying a new look</li>
<li>Another player package refactor</li>
<li>Keeping the user entertained when they fail</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/game-dev/keeping-the-user-entertained-when-they-fail/" data-id="cizy4qye90005ahpgs4luedat" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/device-motion/">device motion</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/experimental-tech/">experimental tech</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/game-development/">game development</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/">unity</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-calculating-beacon-distances-with-optimized-averaging" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/calculating-beacon-distances-with-optimized-averaging/" class="article-date">
  <time datetime="2015-12-29T09:30:48.000Z" itemprop="datePublished">29 December, 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/calculating-beacon-distances-with-optimized-averaging/">Calculating iBeacon distances with optimized averaging</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>It’s no real secret that beacons are most certainly still an “emerging technology” with some growing pains. Unfortunately when you’re working on a hybrid app that depends on them, you kind of have to figure out a way to make things work. In this instance, it’s trying to weed-out the distance/signal strength inconsistencies so user location can be calculated correctly and accurately. </p>
<h2 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h2><p>When you’re detecting your beacons via an app that’s listening for them (using the <a href="https://github.com/petermetz/cordova-plugin-ibeacon" target="_blank" rel="external">Proximity Beacon Plugin</a> for <a href="https://cordova.apache.org/" target="_blank" rel="external">Cordova</a>/<a href="http://ionicframework.com/" target="_blank" rel="external">Ionic</a>, for example) you receive a constant bombardment of objects representing that beacon that you can do with as you please, including an estimated distance <em>(referred to as Accuracy)</em>. Here’s an example object you could expect to see back:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Example beacon object</span></div><div class="line">&#123;</div><div class="line">    <span class="attr">proximity</span>: <span class="string">'ProximityNear'</span>,</div><div class="line">    <span class="attr">accuracy</span>: <span class="number">3.39</span>,</div><div class="line">    <span class="attr">uuid</span>: <span class="string">'140b70ed-cfb3-418g-8611-4dcd06d2d63d'</span>,</div><div class="line">    <span class="attr">major</span>: <span class="number">7</span>,</div><div class="line">    <span class="attr">minor</span>: <span class="number">5</span>,</div><div class="line">    <span class="attr">rssi</span>: <span class="number">50</span>,</div><div class="line">    <span class="attr">tx</span>: <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now, when I say you get bombarded by these objects I mean it. To circumvent this and spare the users phone my team and I have a throttling service that only allows us to submit the beacon data for location calculation every 3 seconds or so, however we noticed a major issue crop up every so often which involved our distance (accuracy, line 4) being incredibly inaccurate. We’re talking upwards of 4 meters off from where we knew we were standing, which when the end result gets compared to a set of boundaries to determine whether or not the device is in a specified zone is a pretty big deal.</p>
<p>After lots of research and lots of data logging, we discovered two things:</p>
<ol>
<li>On average the distance reported by the beacon is somewhat consistent, however the pool of reported distances gets polluted by plenty hilariously inaccurate distances.</li>
<li>Since we were not taking an average of our collection of distances, the distance that would get submitted for calculation was the last distance received before the timeout was finished; basically Beacon Distance Roulette. </li>
</ol>
<p>Number 2 isn’t too big of an issue as it just involves storing beacon data in beacon-unique arrays then calculating the average of the stored distances for each array, which if the distances are stored as an array would be an extremely simple procedure:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Example averaging of a beacon array</span></div><div class="line"><span class="keyword">var</span> averages = [];</div><div class="line"></div><div class="line"><span class="comment">// Iterate through beacons</span></div><div class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> beacons) &#123;</div><div class="line">  <span class="comment">// beacons[key] = [5.27, 6.07, 5.45, 5.05, 4.04, 4.37, 4.55]</span></div><div class="line">  averages[key] = beacons[key].reduce(<span class="function"><span class="keyword">function</span> (<span class="params">prev, cur</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> prev + cur;</div><div class="line">  &#125;) / arr.length; <span class="comment">// 4.97</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// submit `averages` for calculation</span></div></pre></td></tr></table></figure>
<p>So that leaves us with tricky number 1, which would fall short when it comes to regular averaging if there were enough inaccurate distances; therefore requiring a more intricate solution. </p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><p>My first solution was to average the list twice, the first time being used to create a middle point to calculate the data pool for the second average. This however proved to be inaccurate as the distance inconsistencies grew farther apart. </p>
<p>The solution I decided to go with was to create a simple utility that would iterate through the array of numbers, tally up how many times each whole number appeared within the array, then use along with a buffer to establish boundaries that I could use to ignore unreliable data. Coupled with the throttling, this turned out to be exactly the solution we were looking for/</p>
<p>I first decided to scaffold out the utility so I could get an idea of exactly what it was it would need to do. This is generally where I start with everything that I make, as I just find it easier to go through at a high level then start to dive in deeper where necessary.</p>
<figure class="highlight javascript"><figcaption><span>optimizedAverages.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Optimized Average calculation</div><div class="line"> * Takes an array of numbers, then throws away unreliable numbers</div><div class="line"> * to get a more precise average.</div><div class="line"> *</div><div class="line"> * @param &#123;number[]&#125; Numbers - Array of numbers to optimize.</div><div class="line"> * @returns &#123;number&#125; - The optimized average, rounded to the nearest hundredth.</div><div class="line"> */ </div><div class="line"><span class="keyword">var</span> optimizedAverage = <span class="function"><span class="keyword">function</span> <span class="title">optimizeDistanceAverage</span>(<span class="params"> Numbers </span>) </span>&#123;</div><div class="line">  <span class="comment">// Tally up the amount of times a whole number occurs in the array</span></div><div class="line">  <span class="keyword">var</span> countNums;</div><div class="line">  </div><div class="line">  <span class="comment">// determine the most probable distance from the tally (the number that appears the most)</span></div><div class="line">  <span class="keyword">var</span> mostReliable;</div><div class="line"></div><div class="line">  <span class="comment">/** </span></div><div class="line">   * Get the average of the provided numbers that are:</div><div class="line">   *  1. Less than double the most reliable number,</div><div class="line">   *  2. More than half the most reliable number,</div><div class="line">   *  then round it to the nearest hundredth.</div><div class="line">   */</div><div class="line">   <span class="keyword">var</span> average;</div><div class="line">   <span class="keyword">return</span> average;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Expose Utility to whatever needs it</span></div><div class="line"><span class="keyword">if</span> ( <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">"object"</span> &amp;&amp; <span class="built_in">module</span>.exports ) <span class="built_in">module</span>.exports = optimizedAverage;</div><div class="line"><span class="keyword">if</span> ( <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">"undefined"</span> ) <span class="built_in">window</span>.optimizedAverage = optimizedAverage;</div></pre></td></tr></table></figure>
<p>Let’s start by writing some helpers that will come in handy for the rest, like an averaging function as well as a rounding function.</p>
<figure class="highlight javascript"><figcaption><span>optimizedAverages.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">. . .</div><div class="line">var optimizedAverage = <span class="function"><span class="keyword">function</span> <span class="title">optimizeDistanceAverage</span>(<span class="params"> Numbers </span>) </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Get the average from an array of numbers</div><div class="line">   * @param &#123;number[]&#125; arr - Array of numbers to average</div><div class="line">   * @returns &#123;number&#125; - The average of the numbers.</div><div class="line">   */</div><div class="line">  <span class="keyword">var</span> getAverage = <span class="function"><span class="keyword">function</span> <span class="title">getAverage</span>(<span class="params"> arr </span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> arr.reduce( <span class="function"><span class="keyword">function</span> <span class="title">reduceGetAverage</span>(<span class="params"> prev, cur </span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> prev + cur;</div><div class="line">    &#125;) / arr.length;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Round a number to the nearest hundredth</div><div class="line">   * @param &#123;number&#125; num - the number to round</div><div class="line">   * @returns &#123;number&#125; - the rounded result</div><div class="line">   */</div><div class="line">  <span class="keyword">var</span> roundResult = <span class="function"><span class="keyword">function</span> <span class="title">roundResult</span>(<span class="params"> num </span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> ( <span class="built_in">Math</span>.round( num * <span class="number">100</span> ) / <span class="number">100</span> ).toFixed( <span class="number">2</span> );</div><div class="line">  &#125;;</div><div class="line">  . . .</div><div class="line">&#125;;</div><div class="line">. . .</div></pre></td></tr></table></figure>
<p>The averaging function (<code>getAverage()</code>, <em>lines 7 - 11</em>) is essentially the same as the block shown in the last section that averaged the array, so nothing new there. The rounding function (<code>roundResult()</code>, <em>lines 18 - 20</em>) isn’t anything too special either, they’re just some math calculations that would be extremely annoying to write more than once.</p>
<p>From there we can start getting into the real meat-and-potatoes of the utility, namely the function that iterates through the distance array and tallies up how popular each whole number is. Since it’s JavaScript and this involves iterating through an array, there are obviously 8 million and four ways to write it however on this occasion I’m feeling the humble <code>for(;;) {}</code> loop, particularly because I’ve got to be able to declare keys to properly track each number.</p>
<figure class="highlight javascript"><figcaption><span>optimizedAverages.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Tallies up the amount of times a whole number occurs in the array.</div><div class="line"> * @param &#123;number[]&#125; numbers - Array of numbers to iterate over.</div><div class="line"> * @returns &#123;object&#125; - Returns the completed tally object.</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> countNums = <span class="function"><span class="keyword">function</span> <span class="title">countNums</span>(<span class="params"> numbers </span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> count = [];</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numbers.length; ++i) &#123;</div><div class="line">    <span class="comment">// Cache the whole number</span></div><div class="line">    <span class="keyword">var</span> floored = <span class="built_in">Math</span>.floor( numbers[i] );</div><div class="line">    <span class="comment">// Check to see if we've already stored the number</span></div><div class="line">    <span class="keyword">if</span> ( !count.hasOwnProperty( floored ) ) &#123;</div><div class="line">      count[floored] = <span class="number">1</span>; <span class="comment">// Start off the numbers tally</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      ++count[floored]; <span class="comment">// Add to the tally</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> count;</div><div class="line">&#125;( Numbers ); <span class="comment">// Self-invoke the function with the `Numbers` array</span></div></pre></td></tr></table></figure>
<p>As for loops go it’s a pretty basic one, but I’ll walk you through what we’re doing just in case:</p>
<ol>
<li>Creating an empty array to hold our number tallies. <em>(line 6)</em></li>
<li>Iterating through the passed in array, storing the active whole number as we go. <em>(lines 8, 10)</em></li>
<li>Checking to see if the number already has a tally, if not we start it off at 1 and if so we increment it by 1. <em>(lines 12 - 16)</em></li>
<li>Returning the array containing our tallies, then self-invoking the function with the array of distances passed into the utility. <em>(lines 19, 20)</em></li>
</ol>
<p>From there we’re on the home stretch, as now we have an array telling us how many times each distance present in the array appears, so we can easily determine the most probable distance and use that to create a buffer zone of distances we’ll still accept for our final average.</p>
<figure class="highlight javascript"><figcaption><span>optimizedAverages.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Determine the most reliable number (the number that appears most)</span></div><div class="line"><span class="keyword">var</span> mostReliable = countNums.reduce(<span class="function"><span class="keyword">function</span> <span class="title">reduceMostReliable</span>(<span class="params">prev, cur, i, arr</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> arr[prev] &gt; cur ? prev : i;</div><div class="line">&#125;, <span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>Since we’re saving our array containing our tally <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" target="_blank" rel="external">reduce</a> can come to the rescue and <em>reduce</em> our array down to a single, probable distance. This could be done a little bit more readable, but I’ll break down the logic so it’s a little bit easier to understand what’s going on. </p>
<p>The indexes of the array are the whole numbers that we got from our distances, so those are always available to us via <code>i</code>; since reduce provides the last returned value as <code>prev</code>, we can essentially persist the most probably whole number through <code>prev</code>, and still be able to access the amount of times it appeared by pointing the array to that index (<code>arr[prev]</code>). Therefore:</p>
<pre><code>if the current probable number (prev) appeared more times (arr[prev]) than the current value (cur)
   return the current probable number;
   otherwise return the current values index as the new probable number (i)
</code></pre><p>A little bit confusing, I know, but the second it clicks it makes all the sense in the world. As a bonus, it also means we’re one code block away from being done! Lastly we have to get the rounded average of our reliable distances, which are dictated by whether or not they are:</p>
<ol>
<li>Less than double the most probable distance</li>
<li>More than half of the most probable distance</li>
</ol>
<p>There are a couple different ways to write this, so I’ll start with the easy to read version then show the more compact version.</p>
<figure class="highlight javascript"><figcaption><span>optimizedAverages.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Create a new array with the provided numbers that are:</div><div class="line"> *  1. Less than double the most probable distance,</div><div class="line"> *  2. More than half the most probable distance,</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> reliableList = Numbers.filter(<span class="function"><span class="keyword">function</span>(<span class="params"> num </span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.ceil( num ) &gt; ( mostReliable / <span class="number">2</span> ) <span class="comment">// ceil of the number is greater than half </span></div><div class="line">      &amp;&amp; <span class="built_in">Math</span>.floor( num ) &lt; ( mostReliable * <span class="number">2</span> ); <span class="comment">// floor of the number is less than double</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Get the average of our new array</span></div><div class="line"><span class="keyword">var</span> reliableAverage = getAverage( reliableList );</div><div class="line"><span class="comment">// Return the rounded average</span></div><div class="line"><span class="keyword">return</span> roundResult( reliableAverage );</div></pre></td></tr></table></figure>
<p>Here all we’re doing is filtering through our original list and picking out any numbers that are over or under a certain threshold, that way we can keep our data pool small and accurate and get a better average. I’ve got it set at double and half, as I noticed that was a good buffer when reviewing the range of inconsistency in our data logs. </p>
<p>By setting it at double and half we provide a larger buffer for the higher distances (which have a larger range of inconsistency), and far less wiggle room when we’re closer to the beacon (when the distance will have less inconsistencies); making smaller distances more accurate and farther distances easier to estimate.</p>
<p>Like I said though, this final block can be written a little bit more concise as well:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Create a new array with the provided numbers that are:</div><div class="line"> *  1. Less than double the most probable distance,</div><div class="line"> *  2. More than half the most probable distance,</div><div class="line"> */</div><div class="line"><span class="keyword">return</span> roundResult( getAverage( Numbers.filter( <span class="function"><span class="keyword">function</span>(<span class="params"> num </span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.ceil( num ) &gt; ( mostReliable / <span class="number">2</span> ) &amp;&amp; <span class="built_in">Math</span>.floor( num ) &lt; ( mostReliable * <span class="number">2</span> );</div><div class="line">&#125;) ) );</div></pre></td></tr></table></figure>
<p>Yummy, what was previously 8 lines is now 3! This is another benefit of us adding our helpers in earlier, instead of having to toss all of those calculations inline we can just call them in our return on the fly after calculating our new reliableList.</p>
<p>After all is said and done piping our distances through this utility should allow us to get far more accurate distance calculations thanks to ignoring unreliable data. Here’s the results from some test runs I ran so you can see what I mean:</p>
<pre><code>Numbers provided: [1.97, 1.74, 1.44, 1.5, 1.47, 1.41, 1.42, 1.22, 1.17, 1.2, 2.15]
Pre-optimized average: 1.52
Numbers discarded: 1
Optimized average: 1.45

Numbers provided: [5.27, 2.25, 2.45, 1.87, 1.89, 2.11, 1.97, 2.06, 1.93, 2.22, 2.22]
Pre-optimized average: 2.39
Numbers discarded: 1
Optimized average: 2.10

Numbers provided: [14.78, 2.25, 2.45, 1.87, 1.89, 2.11, 9.33, 1.97, 2.06, 1.93, 2.22, 2.22, 11.17]
Pre-optimized average: 4.33
Numbers discarded: 3
Optimized average: 2.22
</code></pre><p>You can view the full file <a href="https://github.com/aesinv/optimized-averages/blob/master/optimizedAverages.js" target="_blank" rel="external">on GitHub</a>, with full comments and ready to roll. You can also play around with it on <a href="https://tonicdev.com/npm/optimized-averages" target="_blank" rel="external">Tonic</a>.</p>
<p>Cheers!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/calculating-beacon-distances-with-optimized-averaging/" data-id="cizy4qydx0000ahpgsnoa8ert" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Internet-of-Things/">Internet of Things</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT/">IoT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/beacons/">beacons</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ibeacon/">ibeacon</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/utilities/">utilities</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-making-a-js-game-part-1-game-engine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/making-a-js-game-part-1-game-engine/" class="article-date">
  <time datetime="2015-11-27T07:45:48.000Z" itemprop="datePublished">27 November, 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/making-a-js-game-part-1-game-engine/">Building a simple JavaScript game - 1. A basic game engine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Once I started getting into web development my desire to be a game developer got put on the back burner while I continued to explore and build my skills as a web developer. As my experience grew and I began to understand the underlying concepts behind what makes a game it started to come back around again, but instead of using traditional languages I’ve been having a lot of fun experimenting with video game development with JavaScript.</p>
<p>There are plenty of existing libraries and foundations for JavaScript game development you can build off of (<a href="http://phaser.io/" target="_blank" rel="external">Phaser</a>, <a href="http://unity3d.com/" target="_blank" rel="external">Unity</a>, <a href="http://www.kiwijs.org/" target="_blank" rel="external">Kiwi</a>, <a href="https://playcanvas.com/" target="_blank" rel="external">PlayCanvas</a>), my personal favorite being Unity. However, there is a certain charm and satisfaction that comes from building something from scratch. If you’re looking to jump right into build a crazy 3D cross-platform behemoth I’d certainly suggest checking out some of the frameworks/engines referenced above, but for the sake of a great educational exercise, we’ll be building a simple little top-down game from scratch.</p>
<p>Before we continue, I’d just like to mention that throughout the writing and development of this simple game I’m going to be listening to a live performance from the Legend of Zelda: Symphony of the Goddesses to really get into the spirit of the project. I highly recommend you fire it up and do the same, it’s terrific!</p>
<iframe class="inline-youtube" width="640" height="360" src="https://www.youtube.com/embed/Vbfc3HAOw7o?rel=0" frameborder="0" allowfullscreen></iframe>

<h2 id="High-level-overview"><a href="#High-level-overview" class="headerlink" title="High-level overview"></a>High-level overview</h2><p>We’re going to be making a simple top-down game with basic old-school gameplay characteristics. The finished product will allow us to walk around a small town, go in buildings, and fight baddies just outside the town. As the character moves, the camera will remain still until it either gets to the edge of the viewport or moves within a <em>door tile</em>. When these two events occur, the camera will either move to display the next portion of the world or the player will be transported into a new room (whatever the door leads to), respectively.</p>
<p>We’ll be using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" target="_blank" rel="external">HTML5 Canvas API</a> to handle rendering our game, and we’ll be developing our JavaScript with the help of <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a>, <a href="http://browserify.org/" target="_blank" rel="external">Browserify</a>, and <a href="http://www.browsersync.io/" target="_blank" rel="external">Browser Sync</a>. In terms of managing what’s going on within the game, we’ll be attaching state objects to all of our different components so we can manage the current state of each component individually, which I personally find to be the easiest method of monitoring and managing data.</p>
<p>I’ve completed a basic project boilerplate you can download and follow along with, available on <a href="https://github.com/aesinv/javascript-game-demo/releases/tag/0.1.0-boilerplate" target="_blank" rel="external">Github</a>. Alternatively, you can visit the <a href="https://github.com/aesinv/javascript-game-demo/" target="_blank" rel="external">repository</a> for the demo and just checkout commit 3a4f588. If you’d like a more in-depth look at setting up Gulp for projects, you can check out a <a href="!--￼19--">previous post</a> that goes over building a gulp file for Jekyll pretty thoroughly.</p>
<h2 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h2><p>Our first order of business will be creating a good project foundation. We could build this entire thing in a single monstrous file, but for the sake of readability and maintainability I’m more a fan of modularity, which is why I’ve opted to build out the game and its components as modules then bundle them together via <a href="http://browserify.org/" target="_blank" rel="external">browserify</a>. Let’s have a look at our proposed project structure:</p>
<pre><code>index.html  // Loads up game module for game-playing party time.
/js/        // Main JS root.
- game.js   // Primary game module.
- core/     // Contains core &quot;engine&quot;-related modules.
- players/  // Contains all enemy/character-related modules.
- utils/    // Contains global constants/utility functions.
- world/    // Contains the main world classes and all levels.
</code></pre><p>It’s a pretty simple structure, and should be fairly predictable. Our main <code>game.js</code> file will require the proper modules from <code>players/</code>, <code>utils/</code>, <code>core/</code>, and <code>world/</code> as dependencies, which will in turn require any additional dependencies needed to generate our game. In this part we’ll more than likely only touch one (maybe two) files in each directory.</p>
<h2 id="Creating-a-viewport-with-canvas"><a href="#Creating-a-viewport-with-canvas" class="headerlink" title="Creating a viewport with canvas"></a>Creating a viewport with canvas</h2><p>First things first, we want to create our main game module so we can start working. Then, we’ll include that on our html page and have it dynamically inject a high-dpi, or high resolution, canvas onto the page after calculating the correct pixel ratio; this way we can make sure we’ll have crystal clear rendering even on higher pixel density devices.</p>
<p>Let’s start with that first bit by creating a bare-bones game module inside of <code>/js/game.js</code>.<br><figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/game.js</span></div><div class="line"><span class="keyword">var</span> $container = <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Create base game class</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.viewport = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</div><div class="line">    <span class="keyword">this</span>.context = viewport.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.viewport.width = <span class="number">800</span>;</div><div class="line">    <span class="keyword">this</span>.viewport.height = <span class="number">600</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Append the canvas node to our container</span></div><div class="line">    $container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line">    <span class="comment">// Toss some text into our canvas</span></div><div class="line">    <span class="keyword">this</span>.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">    <span class="keyword">this</span>.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">800</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate the game in a global</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game();</div><div class="line"></div><div class="line"><span class="comment">// Export the game as a module</span></div><div class="line"><span class="built_in">module</span>.exports = game;</div></pre></td></tr></table></figure></p>
<p>We’re not doing anything fancy here, just creating a canvas (6 - 10), tossing it into our container (13), then rendering some text (16 - 17). More than likely if you view the above code on a high pixel density monitor it will output the text but it will be <em>super</em> blurry and gross. To solve this, we’re going to create a utility that will calculate the correct pixel ratio then downscale the canvas for optimum rendering quality. We’re going to be basing our utilities off of a terrific <a href="http://www.html5rocks.com/en/tutorials/canvas/hidpi/" target="_blank" rel="external">HTML5 Rocks blog post</a> on the subject, and tossing them into our handy-dandy <code>utils/</code> directory under the file name <code>utils.canvas.js</code>.</p>
<p>Just a note, but our utility files will be extremely simple exports of object literals contained with methods, so you can expect them to follow a structure like so:</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">methodOne</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">    <span class="attr">methodTwo</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>First, we’ll need a way to get the correct pixel ratio. To do this we’re going to need a canvas context, which we’ll use to get the device backing ratio from the backing device backing store. We’ll then divide the pixel ratio from the window by that backing ratio, giving us our pixel ratio.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Determine the proper pixel ratio for the canvas */</span></div><div class="line">getPixelRatio : <span class="function"><span class="keyword">function</span> <span class="title">getPixelRatio</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Determining pixel ratio.'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// I'd rather not have a giant var declaration block,</span></div><div class="line">  <span class="comment">// so I'm storing the props in an array to dynamically</span></div><div class="line">  <span class="comment">// get the backing ratio.</span></div><div class="line">  <span class="keyword">var</span> backingStores = [</div><div class="line">    <span class="string">'webkitBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'mozBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'msBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'oBackingStorePixelRatio'</span>,</div><div class="line">    <span class="string">'backingStorePixelRatio'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> deviceRatio = <span class="built_in">window</span>.devicePixelRatio;</div><div class="line"></div><div class="line">  <span class="comment">// Iterate through our backing store props and determine the proper backing ratio.</span></div><div class="line">  <span class="keyword">var</span> backingRatio = backingStores.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">prev, curr</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (context.hasOwnProperty(curr) ? context[curr] : <span class="number">1</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// Return the proper pixel ratio by dividing the device ratio by the backing ratio</span></div><div class="line">  <span class="keyword">return</span> deviceRatio / backingRatio;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>The comments are pretty verbose, but a secondary quick rundown of whats going on:</p>
<ol>
<li>We create an array of the properly browser-prefixed backing store props. (10 - 16)</li>
<li>We reduce our array to a single backing store ratio, defaulting to 1 if none exist. (21 - 23)</li>
<li>We divide the device pixel ratio (from the window) by the backing ratio, giving us our pixel ratio. (26)</li>
</ol>
<p>Next, we need to apply our calculated ratio to our canvas then downscale the entire canvas via CSS and transforms, giving us predictable high quality rendering with predictable dimensions. We’ll toss all of this inside of another canvas utility, then return the canvas to our main game object for instantiation and dom injection.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.canvas.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.canvas.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Generate a canvas with the proper width / height</span></div><div class="line"> * Based on: http://www.html5rocks.com/en/tutorials/canvas/hidpi/</div><div class="line"> */</div><div class="line">generateCanvas : <span class="function"><span class="keyword">function</span> <span class="title">generateCanvas</span>(<span class="params">w, h</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Generating canvas.'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">      context = canvas.getContext(<span class="string">'2d'</span>);</div><div class="line">  <span class="comment">// Pass our canvas' context to our getPixelRatio method</span></div><div class="line">  <span class="keyword">var</span> ratio = <span class="keyword">this</span>.getPixelRatio(context);</div><div class="line"></div><div class="line">  <span class="comment">// Set the canvas' width then downscale via CSS</span></div><div class="line">  canvas.width = <span class="built_in">Math</span>.round(w * ratio);</div><div class="line">  canvas.height = <span class="built_in">Math</span>.round(h * ratio);</div><div class="line">  canvas.style.width = w +<span class="string">'px'</span>;</div><div class="line">  canvas.style.height = h +<span class="string">'px'</span>;</div><div class="line">  <span class="comment">// Scale the context so we get accurate pixel density</span></div><div class="line">  context.setTransform(ratio, <span class="number">0</span>, <span class="number">0</span>, ratio, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> canvas;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Again, pretty straight forward. You’ll notice that after creating our canvas and getting the context, we’re passing that context to our <code>getPixelRatio()</code> method then multiplying our canvas width and height by the returned number, then setting the width and height <em>styles</em> to the original width and height; this is us <em>downscaling</em> the canvas. It’s kind of like if you watch a 1080p video on YouTube at 400px wide. Our transform is then relatively scaling the canvas back up by the amount we downscaled it, that way we get accurate pixel sizes. Try removing the setTransform and viewing the effects, it’s super interesting.</p>
<p>Now that both of our utility methods for canvas generation are created, we can rewrite our main game module create a properly sized canvas dynamically and then append it into our container, giving us our viewport.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cUtils = <span class="built_in">require</span>(<span class="string">'./utils/utils.canvas.js'</span>),</div><div class="line">    $container = <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params">w, h</span>) </span>&#123;</div><div class="line">  <span class="comment">// Generate a canvas and store it as our viewport</span></div><div class="line">  <span class="keyword">this</span>.viewport = cUtils.generateCanvas(w, h);</div><div class="line">  <span class="keyword">this</span>.viewport.id = <span class="string">"gameViewport"</span>; <span class="comment">// give the canvas an ID for easy CSS/JS targeting</span></div><div class="line"></div><div class="line">  <span class="comment">// Get and store the canvas context as a global</span></div><div class="line">  <span class="keyword">this</span>.context = <span class="keyword">this</span>.viewport.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Append our viewport into a container in the dom</span></div><div class="line">  $container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line">  <span class="comment">// Spit out some text</span></div><div class="line">  <span class="keyword">this</span>.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">  <span class="keyword">this</span>.context.fillStyle = <span class="string">'#fff'</span>;</div><div class="line">  <span class="keyword">this</span>.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate a new game in the global scope at 800px by 600px</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game(<span class="number">800</span>, <span class="number">600</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = game;</div></pre></td></tr></table></figure>
<p>Our Game module remains largely the same, apart from us using the <code>generateCanvas()</code> method from our canvas utilities module to create our viewport instead of manually creating it. On the upside, we should now have a dynamically generated high resolution canvas to play around with, so now we have to figure out how to prime it for game play.</p>
<h2 id="Creating-a-game-loop"><a href="#Creating-a-game-loop" class="headerlink" title="Creating a game loop"></a>Creating a game loop</h2><p>So we’ve got a canvas and some folders that make us look like we really know what we’re doing. Reasonable next steps involve creating some sort of rendering and logic engine to handle updating the games state, and re-rendering our canvas to reflect the updated state. Luckily, we can take care of both of these in one fell swoop by creating a <a href="https://developer.mozilla.org/en-US/docs/Games/Anatomy" target="_blank" rel="external"><em>game loop</em></a>.</p>
<p>When it comes to animating and managing a canvas there are a few more hoops to jump through than when you’re animating a typical dom node, mostly because you can’t really reference the created canvas contents after you’ve rendered them. To solve this we’re going to wind up storing everything within a central state; with individual entities (players, enemies, etc.) storing they’re positioning and other pertinent data within their own states. Then, when it’s time to re-render, we’ll call each entities <code>render()</code> method which will use the data within their states to render the entity correctly.</p>
<p>Since with a canvas we need to clear objects out before re-rendering them in a different position, we’re going to be re-rendering the entire canvas every frame. To accomplish this we’re going to need a loop, which being JavaScript there are millions of ways to do that. Let’s take a look at our primary options:</p>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setTimeout" target="_blank" rel="external"><code>setTimeout</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval" target="_blank" rel="external"><code>setInterval</code></a> set to an interval that would fire off at a rate that would equal our target <abbr title="Frames per second">FPS</abbr>.</li>
<li>Utilize <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="external"><code>window.requestAnimationFrame</code></a>, which is the recommended method, to tell the browser we’d like to do an animation and to fire our render method before the next repaint.</li>
</ol>
<p>Our first option, using <code>setTimeout</code> or <code>setInterval</code> would be much easier (and readable for the most part), but it’s incredibly inefficient. The second option, while being way more complex, is miles more efficient due to the browser being able to optimize animations during repaint cycles.</p>
<h3 id="Scaffolding-out-the-loop"><a href="#Scaffolding-out-the-loop" class="headerlink" title="Scaffolding out the loop"></a>Scaffolding out the loop</h3><p>Let’s start by scaffolding out the modules that we’ll be needing for our main loop. The main loop will have three parts:</p>
<pre><code>/js/core/game.loop.js // The actual loop
/js/core/game.update.js // An update method
/js/core/game.render.js // A rendering method
</code></pre><p>These modules will need to access some constants that we will be setting in our global game module, so we’re going to create a new <code>constants</code> property along with an empty <code>state</code> within our main game module first.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Game</span>(<span class="params">w, h, targetFps, showFps</span>) </span>&#123;</div><div class="line">    <span class="comment">// Setup some constants</span></div><div class="line">    <span class="keyword">this</span>.constants = &#123;</div><div class="line">        <span class="attr">width</span>: w,</div><div class="line">        <span class="attr">height</span>: h,</div><div class="line">        <span class="attr">targetFps</span>: targetFps,</div><div class="line">        <span class="attr">showFps</span>: showFps</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Instantiate an empty state object</span></div><div class="line">    <span class="keyword">this</span>.state = &#123;&#125;;</div><div class="line">    . . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Instantiate a new game in the global scope at 800px by 600px</span></div><div class="line"><span class="built_in">window</span>.game = <span class="keyword">new</span> Game(<span class="number">800</span>, <span class="number">600</span>, <span class="number">60</span>, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<p>In addition to our original props for the width and height, we’ve also added a target frame rate prop and a flag for whether or not to render the current FPS; the latter being totally optional both in implementation and use. Now that we’re storing all of this inside of a handy dandy exposed object, we can start on our new modules.</p>
<p>Since these are all integral to the functioning of our game, we can count these modules as <em>core</em> modules which we’ll instantiate from our main game module. Since the update and rendering method are fairly simple and straight forward (for now), so let’s start with those.</p>
<h4 id="The-game-update-module"><a href="#The-game-update-module" class="headerlink" title="The game update module"></a>The game update module</h4><p>Since we’re just scaffolding out our loop and currently have no actual functionality, our update method is going to be really boring. Eventually it will take the games state object, determine changes in, update it, then return it. We’ll just pretend we’re doing fancy stuff for now though.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.update.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.update.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Update Module</span></div><div class="line"> * Called by the game loop, this module will</div><div class="line"> * perform any state calculations / updates</div><div class="line"> * to properly render the next frame.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameUpdate</span> (<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"> tFrame </span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> state = scope.state || &#123;&#125;;</div><div class="line"></div><div class="line">        <span class="comment">// If there are entities, iterate through them and call their `update` methods</span></div><div class="line">        <span class="keyword">if</span> (state.hasOwnProperty(<span class="string">'entities'</span>)) &#123;</div><div class="line">            <span class="keyword">var</span> entities = state.entities;</div><div class="line">            <span class="comment">// Loop through entities</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entities) &#123;</div><div class="line">                <span class="comment">// Fire off each active entities `render` method</span></div><div class="line">                entities[entity].update();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameUpdate;</div></pre></td></tr></table></figure>
<p>Like I said, nothing super crazy going on. We’re injecting the global scope (8), then creating a new object based off of the global state (10), iterating through entities in the global state (13), firing the <code>update()</code> method for each active entity (16 - 22), then returning it (15). Easy.</p>
<p>One interesting thing you may have noticed is that I’m expecting a <code>scope</code> parameter to be passed in first, then I’m returning another function that is actually doing all of the work. You’ll see this in the render method as well, and it’s more of a personal preference more than anything. An alternative would be to remove the returned function, move it’s contents into the main <code>gameUpdate</code> function, and instead of injecting the scope we’d tap into the global <code>window.game</code> object. Since I want to avoid hard coding these references in, I’m just injecting the scope as a parameter.</p>
<h4 id="The-game-render-module"><a href="#The-game-render-module" class="headerlink" title="The game render module"></a>The game render module</h4><p>The render module is a little more busy than our update one, but it’s nothing too crazy yet. We’re going to move our dummy text from the main game module into this one, add our FPS rendering logic, then write a quick little loop to iterate through potential active entities.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.render.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.render.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Render Module</span></div><div class="line"> * Called by the game loop, this module will</div><div class="line"> * perform use the global state to re-render</div><div class="line"> * the canvas using new data. Additionally,</div><div class="line"> * it will call all game entities `render`</div><div class="line"> * methods.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameRender</span>(<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="comment">// Setup globals</span></div><div class="line">    <span class="keyword">var</span> w = scope.constants.width,</div><div class="line">        h = scope.constants.height;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Clear out the canvas</span></div><div class="line">        scope.context.clearRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line"></div><div class="line">        <span class="comment">// Spit out some text</span></div><div class="line">        scope.context.font = <span class="string">'32px Arial'</span>;</div><div class="line">        scope.context.fillStyle = <span class="string">'#fff'</span>;</div><div class="line">        scope.context.fillText(<span class="string">'It\'s dangerous to travel this route alone.'</span>, <span class="number">5</span>, <span class="number">50</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If we want to show the FPS, then render it in the top right corner.</span></div><div class="line">        <span class="keyword">if</span> (scope.constants.showFps) &#123;</div><div class="line">            scope.context.fillStyle = <span class="string">'#ff0'</span>;</div><div class="line">            scope.context.fillText(<span class="string">'FPS'</span>, w - <span class="number">100</span>, <span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If there are entities, iterate through them and call their `render` methods</span></div><div class="line">        <span class="keyword">if</span> (scope.state.hasOwnProperty(<span class="string">'entities'</span>)) &#123;</div><div class="line">            <span class="keyword">var</span> entities = scope.state.entities;</div><div class="line">            <span class="comment">// Loop through entities</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entities) &#123;</div><div class="line">                <span class="comment">// Fire off each active entities `render` method</span></div><div class="line">                entities[entity].render();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameRender;</div></pre></td></tr></table></figure>
<p>Like the update module we’re injecting the games context (10), then we’re clearing the canvas (17), rendering our dummy content (19-22) and setting it up to show the FPS in the top right corner of the canvas if the <code>showFps</code> flag is set (25-28).</p>
<p>The only fanciness occurring here is between lines 31 and 38, where we are iterating through all active entities with a simple <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in" target="_blank" rel="external"><code>for...in</code></a> loop (if the global state has any entities set, as per line 31), then firing off the <code>render()</code> method of each active entity (36).</p>
<p>We’ll be returning to this module in a little bit to change the text we’re writing in place of the actual frame rate, but for now it’s completed.</p>
<h4 id="The-loop-of-doom"><a href="#The-loop-of-doom" class="headerlink" title="The loop of doom"></a>The loop of doom</h4><p>Now it’s time for us to move onto our mythical loop, which will by far be the most complex portion of code we’ve written yet. As I mentioned earlier, we’re going to be using <code>requestAnimationFrame</code> to handle our loop, as recommended by <a href="https://developer.mozilla.org/en-US/docs/Games/Anatomy" target="_blank" rel="external">MDN</a> and based off of information from <a href="http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/" target="_blank" rel="external">Paul Irish</a>, coupled together with some frame rate throttling based on some terrific <a href="http://stackoverflow.com/a/19772220" target="_blank" rel="external">stack overflow answers</a>.</p>
<p>I know that’s a lot to swallow, so we’ll tackle this one one by one. Let’s start with the loop itself, then we’ll jump into the frame rate throttling.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Game Loop Module</span></div><div class="line"> * This module contains the game loop, which handles</div><div class="line"> * updating the game state and re-rendering the canvas</div><div class="line"> * (using the updated state) at the configured FPS.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gameLoop</span> (<span class="params"> scope </span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> loop = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Main game rendering loop</span></div><div class="line">    loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123;</div><div class="line">        <span class="comment">// Request a new Animation Frame</span></div><div class="line">        <span class="comment">// setting to `stopLoop` so animation can be stopped via</span></div><div class="line">        <span class="comment">// `window.cancelAnimationFrame( loop.stopLoop )`</span></div><div class="line">        loop.stopLoop = <span class="built_in">window</span>.requestAnimationFrame( loop.main );</div><div class="line"></div><div class="line">        <span class="comment">// Update the game state</span></div><div class="line">        scope.state = scope.update( now );</div><div class="line">        <span class="comment">// Render the next frame</span></div><div class="line">        scope.render();</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Start off main loop</span></div><div class="line">    loop.main();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gameLoop;</div></pre></td></tr></table></figure>
<p>By itself the loop isn’t too terrifying at all, and if you’ve checked out the MDN docs on the anatomy of a web game it should be very familiar; we’re just creating a callback and passing it into <code>window.requestAnimationFrame</code>, then firing off our update and render methods, which are instantiated in the global context (which has been injected in). I realize this isn’t the most elegant way to fire off the update and render methods, but my reasoning is to have the update and render modules instantiated and exposed globally if, for whatever reason, they need to be triggered manually. An alternative to this would be to require the modules within the game loop module, and instantiate them with the injected context.</p>
<p>Next, we’ll start with our frame rate throttling. There’s quite a lot to this, so I’ll try to break it down as best as I can. First we need to set up our variables for calculating the frame rate. We’re going to require the current animation tick timestamp, the previous animation tick timestamp as well as the difference between the two; our target FPS and our target interval between animation ticks <em>(1000 / fps)</em>.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 9 - 30</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize timer variables so we can calculate FPS</span></div><div class="line"><span class="keyword">var</span> fps = scope.constants.targetFps, <span class="comment">// Our target fps</span></div><div class="line">    fpsInterval = <span class="number">1000</span> / fps, <span class="comment">// the interval between animation ticks, in ms (1000 / 60 = ~16.666667)</span></div><div class="line">    before = <span class="built_in">window</span>.performance.now(), <span class="comment">// The starting times timestamp</span></div><div class="line"></div><div class="line">    <span class="comment">// Set up an object to contain our alternating FPS calculations</span></div><div class="line">    cycles = &#123;</div><div class="line">        <span class="attr">new</span>: &#123;</div><div class="line">            <span class="attr">frameCount</span>: <span class="number">0</span>, <span class="comment">// Frames since the start of the cycle</span></div><div class="line">            startTime: before, <span class="comment">// The starting timestamp</span></div><div class="line">            sinceStart: <span class="number">0</span> <span class="comment">// time elapsed since the startTime</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">old</span>: &#123;</div><div class="line">            <span class="attr">frameCount</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">startTime</span>: before,</div><div class="line">            <span class="attr">sineStart</span>: <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// Alternating Frame Rate vars</span></div><div class="line">    resetInterval = <span class="number">5</span>, <span class="comment">// Frame rate cycle reset interval (in seconds)</span></div><div class="line">    resetState = <span class="string">'new'</span>; <span class="comment">// The initial frame rate cycle</span></div><div class="line"></div><div class="line">loop.fps = <span class="number">0</span>; <span class="comment">// A prop that will expose the current calculated FPS to other modules</span></div><div class="line"></div><div class="line"><span class="comment">// Main game rendering loop</span></div><div class="line">loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123; . . . &#125;</div></pre></td></tr></table></figure>
<p>Whoa, that’s a lot of variables. Keeping the code comments in mind, there’s one thing I would like to explain which is the <code>cycles</code> object. If you look at the stack overflow answer I mentioned earlier, there’s a lot of examples of some calculations to determine and throttle the frame rate, but they use a single computation cycle which while testing I noticed some issues with.</p>
<ol>
<li>After a while, the performance would bog down due to the constant incrementation of the single frame count and elapsed time variables.</li>
<li>Also after some time, the accuracy would drastically decrease. As the calculations depend on the current time and frame count in relation to the original time, because the gap was so massive the resulting value would be mis-representative of the actual frame rate and would act as more of an “average-over-the-time-you’ve-had-this-page-open”.</li>
</ol>
<p>The second issue may be more of a presentation of the frame rate problem I admit, but as a solution I’ve made it so there are two increments going on in parallel and as they reach a pre-determined interval, <code>resetInterval</code>, the active cycle will get reset to 0 and the alternate cycle will take its place as the active cycle. This helps maintain an accurately calculated frame rate based on samples from a short period of time, rather than an increasingly large period of time.</p>
<p>Now, back to our loop.</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 32. . .82</span></div><div class="line"></div><div class="line">loop.main = <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params"> tframe </span>) </span>&#123;</div><div class="line">    <span class="comment">// Request a new Animation Frame</span></div><div class="line">    <span class="comment">// setting to `stopLoop` so animation can be stopped via</span></div><div class="line">    <span class="comment">// `window.cancelAnimationFrame( loop.stopLoop )`</span></div><div class="line">    loop.stopLoop = <span class="built_in">window</span>.requestAnimationFrame( loop.main );</div><div class="line"></div><div class="line">    <span class="comment">// How long ago since last loop?</span></div><div class="line">    <span class="keyword">var</span> now = tframe,</div><div class="line">        elapsed = now - before,</div><div class="line">        activeCycle, targetResetInterval;</div><div class="line"></div><div class="line">    <span class="comment">// If it's been at least our desired interval, render</span></div><div class="line">    <span class="keyword">if</span> (elapsed &gt; fpsInterval) &#123;</div><div class="line">        <span class="comment">// Set before = now for next frame, also adjust for</span></div><div class="line">        <span class="comment">// specified fpsInterval not being a multiple of rAF's interval (16.7ms)</span></div><div class="line">        <span class="comment">// ( http://stackoverflow.com/a/19772220 )</span></div><div class="line">        before = now - (elapsed % fpsInterval);</div><div class="line"></div><div class="line">        <span class="comment">// Update the game state</span></div><div class="line">        scope.update( now );</div><div class="line">        <span class="comment">// Render the next frame</span></div><div class="line">        scope.render();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Throttling the loop to our ideal fps is actually relatively simple, as you can see above. Here are the headlines:</p>
<ul>
<li><strong>Lines 8 &amp; 9:</strong> cache the current timestamp, then subtract the previous timestamp from it to get the elapsed time.</li>
<li><strong>Line 13:</strong> If the elapsed time from line 9 is greater than our target interval, continue with the re-render.</li>
<li><strong>Lines 14 - 22:</strong> Set the variable holding the previous timestamp to the current timestamp, then fire the update and render modules.</li>
</ul>
<p>Pretty straight forward, so now let’s calculate the current frame rate and expose it for other modules (namely the rendering module).</p>
<figure class="highlight javascript"><figcaption><span>js/core/game.loop.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/core/game.loop.js, lines 49 - 78</span></div><div class="line"></div><div class="line">before = now - (elapsed % fpsInterval);</div><div class="line"></div><div class="line"><span class="comment">// Increment the vals for both the active and the alternate FPS calculations</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> calc <span class="keyword">in</span> cycles) &#123;</div><div class="line">    ++cycles[calc].frameCount;</div><div class="line">    cycles[calc].sinceStart = now - cycles[calc].startTime;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Choose the correct FPS calculation, then update the exposed fps value</span></div><div class="line">activeCycle = cycles[resetState];</div><div class="line">loop.fps = <span class="built_in">Math</span>.round(<span class="number">1000</span> / (activeCycle.sinceStart / activeCycle.frameCount) * <span class="number">100</span>) / <span class="number">100</span>;</div><div class="line"></div><div class="line"><span class="comment">// If our frame counts are equal....</span></div><div class="line">targetResetInterval = (cycles.new.frameCount === cycles.old.frameCount</div><div class="line">                       ? resetInterval * fps <span class="comment">// Wait our interval</span></div><div class="line">                       : (resetInterval * <span class="number">2</span>) * fps); <span class="comment">// Wait double our interval</span></div><div class="line"></div><div class="line"><span class="comment">// If the active calculation goes over our specified interval,</span></div><div class="line"><span class="comment">// reset it to 0 and flag our alternate calculation to be active</span></div><div class="line"><span class="comment">// for the next series of animations.</span></div><div class="line"><span class="keyword">if</span> (activeCycle.frameCount &gt; targetResetInterval) &#123;</div><div class="line">    cycles[resetState].frameCount = <span class="number">0</span>;</div><div class="line">    cycles[resetState].startTime = now;</div><div class="line">    cycles[resetState].sinceStart = <span class="number">0</span>;</div><div class="line"></div><div class="line">    resetState = (resetState === <span class="string">'new'</span> ? <span class="string">'old'</span> : <span class="string">'new'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Update the game state</span></div></pre></td></tr></table></figure>
<p>This is probably the most we’ve got going on so far, so let’s review it block by block.</p>
<ul>
<li><strong>Lines 4 - 7:</strong> First we’re going to iterate through both cycles, increment the frame counts and update the elapsed times since the start of the cycle.</li>
<li><strong>Lines 10 &amp; 11:</strong> Set the active cycle, then use some maths to determine and set our exposed property to the current frame rate.</li>
<li><strong>Lines 12 - 15:</strong> Set our target reset interval. Once the cycles begin alternating, when the <em>active</em> cycle reaches it’s target, the <em>inactive</em> cycle will be equal to half of the target since it runs in parallel. Therefore, rather than resetting at our interval, we want to reset at double our interval.</li>
<li><strong>Lines 21 - 27:</strong> If the active cycles frame count is greater than its target interval, reset the active cycle to 0 and switch to the inactive cycle.</li>
</ul>
<p>Now that that’s completed, we can run back to our rendering module (<code>/js/core/game.render.js</code>) and toss our exposed <code>loop.fps</code> value in place of our dummy <em>‘FPS’</em> text:</p>
<pre><code>scope.context.fillText(scope.loop.fps, w - 100, 50);
</code></pre><h4 id="Wrapping-it-all-together"><a href="#Wrapping-it-all-together" class="headerlink" title="Wrapping it all together"></a>Wrapping it all together</h4><p>Since we have all of our modules built and exposed as exportable modules, we can now simply instantiate them within the main game module and our game should automagically run our main loop, displaying the frame rate in the top right corner if you’ve set your <code>showFps</code> parameter to true.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">. . .</div><div class="line">$container.insertBefore(<span class="keyword">this</span>.viewport, $container.firstChild);</div><div class="line"></div><div class="line"><span class="comment">// Instantiate core modules with the current scope</span></div><div class="line"><span class="keyword">this</span>.update = gameUpdate( <span class="keyword">this</span> );</div><div class="line"><span class="keyword">this</span>.render = gameRender( <span class="keyword">this</span> );</div><div class="line"><span class="keyword">this</span>.loop = gameLoop( <span class="keyword">this</span> );</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</div></pre></td></tr></table></figure>
<p>Huzzah! We’ve built (albeit basic) our own rudimentary game engine! It automagically generates a high resolution canvas element and injects it into our HTML, updates itself at a configurable frame rate, and displays said frame rate using an alternating calculation cycle strategy (which you can see if you toss a log of the frame rate of both cycles into your loop).</p>
<!-- video -->
<h2 id="Bonus-Creating-a-movable-player"><a href="#Bonus-Creating-a-movable-player" class="headerlink" title="Bonus: Creating a movable player"></a>Bonus: Creating a movable player</h2><p>I could end there, but I usually get really annoyed whenever I see a multi-part how-to that completely leaves me hanging before magic happens, so I don’t want to be <em>“that guy”</em>. To some people, getting the loop completed is magical and they’re probably way stoked at the moment; I am as well but I think an even more magical stopping point would be the ability to move a little box around the viewport. Nothing crazy, just enough to be interactive and really get the inspiration flowing when you get that “Eureka!” moment as you’re moving the box around the viewport aimlessly.</p>
<p>Let’s get cracking.</p>
<h3 id="Creating-our-player-module"><a href="#Creating-our-player-module" class="headerlink" title="Creating our player module"></a>Creating our player module</h3><p>Earlier I kept mentioning <em>entities</em>, which is essentially what we’re going to be creating. If you’ve played around in Unity before, the term will be familiar to you as Unity games are built from entities. Entities are essentially interactive components such as NPC’s, enemies, projectiles, etc. Eventually, our entity will have tons of different methods and properties such as health, damage, attack, and other game-type stuff; for now all we’re going to be needing is a state that will contain our position within the viewport, a render method, and an update method.</p>
<p>As far as utilities go, foreseeable necessary utilities include a way to bind our number to a specific boundary (the width of our viewport and 0) and a way of determining whether or not a key is being pressed at any time. Let’s start by scaffolding out our player entity, then we can create and plug in those utilities as needed.</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> player = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Create the initial state</span></div><div class="line">    player.state = &#123;</div><div class="line">        <span class="attr">position</span>: &#123;</div><div class="line">            <span class="attr">x</span>: x,</div><div class="line">            <span class="attr">y</span>: y</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">moveSpeed</span>: <span class="number">1.5</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Set up any other constants</span></div><div class="line">    <span class="keyword">var</span> height = <span class="number">23</span>,</div><div class="line">        width = <span class="number">16</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Draw the player on the canvas</span></div><div class="line">    player.render = <span class="function"><span class="keyword">function</span> <span class="title">playerRender</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        scope.context.fillStyle = <span class="string">'#40d870'</span>;</div><div class="line">        scope.context.fillRect(</div><div class="line">            player.state.position.x,</div><div class="line">            player.state.position.y,</div><div class="line">            width, height</div><div class="line">        );</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Fired via the global update method.</span></div><div class="line">    <span class="comment">// Mutates state as needed for proper rendering next state</span></div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, if so, update the players position.</span></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> player;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>As you can see, our entity structure is extremely similar to all of our other modules; we just have an exported function declaration with some properties and methods exposed. What’s important to note here are the exposed <code>render</code> and <code>update</code> methods, lines 23 - 30 and 34 - 37, respectively. You’ll remember that in both our global update and render modules we’re iterating through all of the active entities and firing off these methods, so the inclusion of them within our entity is crucial.</p>
<p>Again, we’re injecting the scope into the module but this isn’t 100% necessary; we could also inject it by ditching the <code>scope</code> parameter and using the <code>window.game</code> global to get the context. Since we were injecting it earlier, I’m sticking with that here. If it winds up bugging me later, I’m sure I’ll change it in the next post.</p>
<p>Technically, as long as we instantiate the player module our game should function and render our player in our viewport. This will more than likely occur on a per-level (or world) basis, but for now we’ll just toss that into our main module.</p>
<figure class="highlight javascript"><figcaption><span>js/game.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/game.js, lines 40 - 51</span></div><div class="line"></div><div class="line">that = <span class="keyword">this</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> createPlayer = <span class="function"><span class="keyword">function</span> <span class="title">createPlayer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// Set the state.entities prop to an empty object if it does not exist</span></div><div class="line">    that.state.entities = that.state.entities || &#123;&#125;;</div><div class="line">    <span class="comment">// Instantiate a player as an active entity</span></div><div class="line">    that.state.entities.player = <span class="keyword">new</span> playerEnt(</div><div class="line">        that,</div><div class="line">        that.constants.width / <span class="number">2</span>,</div><div class="line">        that.constants.height - <span class="number">100</span></div><div class="line">    );</div><div class="line">&#125;();</div></pre></td></tr></table></figure>
<h4 id="Getting-our-player-to-move"><a href="#Getting-our-player-to-move" class="headerlink" title="Getting our player to move"></a>Getting our player to move</h4><p>Now that we’ve got a working entity it’s time for us to fill up the entities update method so it actually does something. Our first order of business is getting our player to move around whenever we press the arrow keys down. Since we’re not using jQuery or any libraries we’re going to have to figure out a way to gracefully monitor the dom for key down events, then store whether or not a key is down at any given point as a boolean. There’s two ways we can do this, we can either return some functions that will act as getters and retrieve whatever the keys variable is set to at that moment (<code>keys.isLeftPressed()</code>), or we can utilize <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">Object.defineProperty</a> to actually create some getters for the variables (<code>keys.isPressed.left</code>). This is obviously left completely to personal preference, and I’m going to be using <code>Object.defineProperty</code> because I like the syntax it leaves us with.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.keysDown.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.keysDown.js</span></div><div class="line"></div><div class="line"><span class="comment">/** keysDown Utility Module</span></div><div class="line"> * Monitors and determines whether a key</div><div class="line"> * is pressed down at any given moment.</div><div class="line"> * Returns getters for each key.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">keysDown</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// Set isPressed to an empty object</span></div><div class="line">    <span class="keyword">this</span>.isPressed = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> left, right, up, down;</div><div class="line"></div><div class="line">    <span class="comment">// Set up `onkeydown` event handler.</span></div><div class="line">    <span class="built_in">document</span>.onkeydown = <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">39</span>) &#123; right = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">37</span>) &#123; left = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">38</span>) &#123; up = <span class="literal">true</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">40</span>) &#123; down = <span class="literal">true</span>; &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Set up `onkeyup` event handler.</span></div><div class="line">    <span class="built_in">document</span>.onkeyup = <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">39</span>) &#123; right = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">37</span>) &#123; left = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">38</span>) &#123; up = <span class="literal">false</span>; &#125;</div><div class="line">        <span class="keyword">if</span> (ev.keyCode === <span class="number">40</span>) &#123; down = <span class="literal">false</span>; &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Define getters for each key</span></div><div class="line">    <span class="comment">// * Not strictly necessary. Could just return</span></div><div class="line">    <span class="comment">// * an object literal of methods, the syntactic</span></div><div class="line">    <span class="comment">// * sugar of `defineProperty` is just so much sweeter :)</span></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'left'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> left; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'right'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> right; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'up'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> up; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.isPressed, <span class="string">'down'</span>, &#123;</div><div class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> down; &#125;,</div><div class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = keysDown();</div></pre></td></tr></table></figure>
<p>Now, I understand that this probably looks about as graceful as an ice skating bear with all of its if blocks, but it’s certainly a lot better than polluting our entity with all of this mumbo jumbo (trust me on this, I had it within the module when I first wrote it and the tears were real). So, what’s goin’ on here?</p>
<ul>
<li>We prep our <code>isPressed</code> property by setting it to an empty object and we cache all of our variables (10, 11).</li>
<li>Set up event listeners for when a key is pressed down, then we determine what keys are pressed and set variables accordingly (14 - 19).</li>
<li>Similarly, we set up event listeners for when a key is released and again set variables accordingly. This is crucial as it will tell our game <em>“Hey, we’re not moving left anymore”</em> (22 - 27).</li>
<li>Finally, we define some getters for each of our keys. They aren’t the most complex getters in the world, but they’re terrific as they give us the syntax of a variable declaration, but it will return whatever value is active at the time (33 - 55).</li>
</ul>
<p>After requiring this module into our player module, we then have access to the ability to request whether a key is active or not at any given time by calling that keys property within the <code>isPressed</code> object (<code>keys.isPressed.left</code> for example).</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"><span class="keyword">var</span> keys = <span class="built_in">require</span>(<span class="string">'../utils/utils.keysDown.js'</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">. . .</div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, and if so, update the players position.</span></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.left) &#123;</div><div class="line">            player.state.position.x -= player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.right) &#123;</div><div class="line">            player.state.position.x += player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.up) &#123;</div><div class="line">            player.state.position.y -= player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (keys.isPressed.down) &#123;</div><div class="line">            player.state.position.y += player.state.moveSpeed;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">    &#125;;</div><div class="line">. . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>Easier than expected, huh? And since we’ve defined our moveSpeed as a variable, later on we can alter the move speed dynamically to implement things like smooth surfaces, boost power ups, sprinting, etc. The only downside that we’re left with is if we keep going left for instance, we could easily get lost in the depths of the out-of-viewport wilderness; never to return. Let’s fix that.</p>
<h4 id="Binding-our-position-to-a-boundary"><a href="#Binding-our-position-to-a-boundary" class="headerlink" title="Binding our position to a boundary"></a>Binding our position to a boundary</h4><p>When I say we’re going to be binding our position to a boundary, it’s just a fancy way of saying that we’re going to be forcing our coordinates to not exceed a minimum or maximum value. It’s a really simple trick, and while it isn’t absolutely necessary to have as its own module it makes using it within our player module a lot cleaner. Not to mention we can always extend the module to contain other math-related helper functions as well.</p>
<figure class="highlight javascript"><figcaption><span>js/utils/utils.math.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/utils/utils.math.js</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Number.prototype.boundary</div><div class="line"> * Binds a number between a minimum and a maximum amount.</div><div class="line"> * var x = 12 * 3;</div><div class="line"> * var y = x.boundary(3, 23);</div><div class="line"> * y === 23</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> Boundary = <span class="function"><span class="keyword">function</span> <span class="title">numberBoundary</span>(<span class="params">min, max</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.min( <span class="built_in">Math</span>.max(<span class="keyword">this</span>, min), max );</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Expose methods</span></div><div class="line"><span class="built_in">Number</span>.prototype.boundary = Boundary;</div><div class="line"><span class="built_in">module</span>.exports = Boundary;</div></pre></td></tr></table></figure>
<p>All we’re doing here is taking the min and max boundaries, and applying our current position so it won’t exceed those two boundary points. Some <em>“Eureka!”</em>‘s include that since we’re extending the prototype of the Number object our number is available to us within the method via <code>this</code>, and I’m only exporting it as a module to get browserify to bundle the file up with the rest of our project.</p>
<p>Now we can jump back into our player module and change our update method to bind our position to the boundaries we’ve set.</p>
<figure class="highlight javascript"><figcaption><span>js/players/player.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /js/players/player.js</span></div><div class="line"><span class="keyword">var</span> keys = <span class="built_in">require</span>(<span class="string">'../utils/utils.keysDown.js'</span>),</div><div class="line">    mathHelpers = <span class="built_in">require</span>(<span class="string">'../utils/utils.math.js'</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Player Module</span></div><div class="line"> * Main player entity module.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">scope, x, y</span>) </span>&#123;</div><div class="line">    . . .</div><div class="line"></div><div class="line">    player.update = <span class="function"><span class="keyword">function</span> <span class="title">playerUpdate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">// Check if keys are pressed, if so, update the players position.</span></div><div class="line">        . . .</div><div class="line"></div><div class="line">        <span class="comment">// Bind the player to the boundary</span></div><div class="line">        player.state.position.x = player.state.position.x.boundary(<span class="number">0</span>, (scope.constants.width - width));</div><div class="line">        player.state.position.y = player.state.position.y.boundary(<span class="number">0</span>, (scope.constants.height - height));</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    . . .</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Player;</div></pre></td></tr></table></figure>
<p>Trust me, this is a LOT cleaner than tossing all of that <em>min max</em> stuff into the module. As I mentioned before, since we extended the <code>Number</code> objects prototype with <code>Number.prototype.boundary</code>, that method is now available to all Numbers within our project. Since x and y are numbers rather than strings, they can then use boundary to return the proper position.</p>
<div class="bg-video-wrap" style="background-image: url('/img/videos/gulpVid.png');"><br>  <video class="bg-video-player" autoplay loop><br>    <source src="/img/videos/game-engine-vid.mp4" type="video/mp4; codecs=avc1.42E01E,mp4a.40.2"><br>    <source src="/img/videos/game-engine-vid.webm" type="video/webm; codecs=vp8,vorbis"><br>    <source src="/img/videos/game-engine-vid.ogv" type="video/ogg; codecs=theora,vorbis"><br>  </video><br></div>

<h2 id="Wrapping-Up"><a href="#Wrapping-Up" class="headerlink" title="Wrapping Up"></a>Wrapping Up</h2><p>So, let’s review what we’ve done in this episode:</p>
<ul>
<li>Built a pretty rad project structure that is fairly predictable and easy to work with.</li>
<li>Created a dynamically generated high-resolution canvas and injected it into the dom as a viewport.</li>
<li>Built out a rudimentary rendering and logic engine using <code>requestAnimationFrame</code>, dynamically throttling it to a configurable frame rate</li>
<li>Made a two-cycle alternating frame rate calculator for frame rate monitoring during development</li>
<li>Created our first interactive entity, the player, and added logic to move him around the screen</li>
<li>Got a feel for how to add onto to our project foundation</li>
</ul>
<p>Not too shabby for a first pass. I know we mostly did the <em>behind the scenes</em> stuff (the kind of stuff that takes forever, then you excitedly show it to the client and they go “uhhh. that’s it? that’s all you’ve done? what am I looking at?”) and the current iteration isn’t the most exciting thing in the world, but it’s a solid platform for us to start with. In the next couple posts we’ll start going in and doing the exciting stuff like creating sprites for our entities, generating levels, writing in collision detection, and possibly extracting our logic update layer further for more efficiency.</p>
<p>If you’d like to check out the code for this post in full, you can check it out on the <a href="https://github.com/aesinv/javascript-game-demo/tree/0.2.0-p1" target="_blank" rel="external">github repo</a> (specifically the 0.2.0-p1 tag), or you can <a href="https://github.com/aesinv/javascript-game-demo/releases/tag/0.2.0-p1" target="_blank" rel="external">download it</a> as a zip or tar file.</p>
<p>Safe travels until next round!</p>
<h2 id="Adventure-outline-parts"><a href="#Adventure-outline-parts" class="headerlink" title="Adventure outline / parts"></a>Adventure outline / parts</h2><ul>
<li><strong><a href="#">Part 1: A basic game engine</a></strong></li>
<li>Part 2: Creating our game world - Coming soon</li>
<li>Part 3: Sprites, enemies and danger - Coming soon</li>
<li>Part 4: Implementing an event system - Coming soon</li>
<li>Part ~: More will be added as they’re written!</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/making-a-js-game-part-1-game-engine/" data-id="cizy4qyea0006ahpg5tj5ugsa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-along/">code along</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dungeon-crawler/">dungeon crawler</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/game-development/">game development</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/games/">games</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-building-a-gulp-workflow-around-jekyll" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/development/building-a-gulp-workflow-around-jekyll/" class="article-date">
  <time datetime="2015-08-29T14:16:21.000Z" itemprop="datePublished">29 August, 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/development/">development</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/development/building-a-gulp-workflow-around-jekyll/">Building a Gulp workflow wrapped around Jekyll</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Tl-dr"><a href="#Tl-dr" class="headerlink" title="Tl;dr"></a>Tl;dr</h2><blockquote>
<ul>
<li>Jekyll is analog out of the box, a Gulp workflow allows you to simplify development massively.</li>
<li>Use either <a href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options" target="_blank" rel="external">child_process.spawn</a> or <a href="https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback" target="_blank" rel="external">child_process.exec</a> to run the Jekyll build from Node/Gulp.</li>
<li>A way of sequencing your tasks is crucial to the build. I currently use <a href="https://www.npmjs.com/package/run-sequence" target="_blank" rel="external">runSequence</a> but am looking at refactoring.</li>
<li>View the <a href="https://github.com/aesinv/aesinv-jekyll-blog/blob/master/gulpfile.js" target="_blank" rel="external">Completed Gulpfile</a> on <a href="https://github.com/aesinv/aesinv-jekyll-blog/" target="_blank" rel="external">GitHub</a>.</li>
</ul>
</blockquote>
<h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>Out of the box, <a href="http://jekyllrb.com/" target="_blank" rel="external">Jekyll</a> comes with everything you’d need to set up a simple, fully static website. When it comes time to add some dynamism however, things become quite analog. The default set up is very set in stone, and while you can add directories and files to include on compilation to your <code>_config.yml</code> file, if you want to delve into the realm of actual optimization of said included files you have to jump into <em>lots of pizza and a full night of Ruby</em> land. As a front end developer with no previous experience in <a href="https://www.ruby-lang.org/en/" target="_blank" rel="external">Ruby</a>, this wasn’t an appealing option for me (especially considering I can hardly stand even setting up <a href="https://rvm.io/" target="_blank" rel="external">RVM</a>).</p>
<p>Ideally then, this should be handled via a solid task manager such as <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a> that would allow me to toss in any optimizations I’d like with minimal effort. While there are tons of <a href="http://yeoman.io" target="_blank" rel="external">Yeoman</a> generators out there, where’s the fun in that?! Setting up a Gulp workflow is very straightforward and in some cases <em>quite fun</em> (I’m not supposed to let people see me say that or something, right?), however the problem of how to get it to interact nicely with Jekyll persists.</p>
<h2 id="Determining-what-handles-what"><a href="#Determining-what-handles-what" class="headerlink" title="Determining what handles what"></a>Determining what handles what</h2><p>Since Jekyll spins up it’s own build as well as a local development server and is required to generate the finished site, it’s clearly necessary to determine what should be handling what. Since running the <code>jekyll serve</code> command in parallel with Gulp would wind up with the two stepping on each others toes, that idea quickly got thrown out the window in favor for Gulp handling the majority of the legwork while the Jekyll build would be reserved strictly for site generation.</p>
<p>So, let’s start with what Jekyll can do right out of the box:</p>
<ul>
<li><a href="http://sass-lang.com/" target="_blank" rel="external">Sass</a> compilation</li>
<li>Markup / <a href="http://daringfireball.net/projects/markdown/" target="_blank" rel="external">Markdown</a> / Data compilation and site generation</li>
<li>Destination directory cleaning</li>
<li>Copying project source directories and files that are marked for inclusion</li>
<li>Spinning up a local dev server that auto re-gens on source file changes</li>
</ul>
<p>Because Jekyll cleans the destination directory with each build and I’m not a huge fan of compiled build files hanging out and partying with source files, any extra tasks being handled by Gulp need to be run after the Jekyll build every time, with the built files then being injected into the build directory. Since Gulp will be handling the local server, there’s no need to worry about that particular task. Additionally, to prevent requiring a full Jekyll/Asset re-build on simple stylesheet changes, that’s another thing that we can transfer responsibility over to Gulp. Gulp can then handle tacking on some extra CSS stuff (such as <a href="https://www.npmjs.com/package/gulp-minify-css" target="_blank" rel="external">minification</a> and <a href="https://www.npmjs.com/package/gulp-autoprefixer" target="_blank" rel="external">auto prefixing</a>), as well as all JavaScript and image optimization.</p>
<h2 id="Scaffolding-out-the-tasks"><a href="#Scaffolding-out-the-tasks" class="headerlink" title="Scaffolding out the tasks"></a>Scaffolding out the tasks</h2><p>At this point, it’s time to start scaffolding out exactly what needs to be built on a higher level so development is more focused on just writing some simple tasks rather than trying to determine what needs to be where and how <em>x</em> should be called by <em>y</em>.</p>
<h3 id="Main-utility-tasks"><a href="#Main-utility-tasks" class="headerlink" title="Main utility tasks"></a>Main utility tasks</h3><p>We need some main utility tasks to handle all of the heavy lifting, so they can easily get called by the build tasks. Each one should handle all of the optimizations and subtasks for it’s stated code type, that way the watch task can efficiently rebuild the portion of the code that’s changed and not the entire build process.</p>
<ul>
<li><code>buildJs</code>: Concatenate, lint, and minify all JavaScript</li>
<li><code>buildCss</code>: Take the built CSS, run it through the auto-prefixer, then minify</li>
<li><code>buildJekyll</code>: Utility function/task to run the Jekyll build</li>
<li><code>optimizeImg</code>: Run all images through <a href="https://www.npmjs.com/package/gulp-imagemin" target="_blank" rel="external">gulp-imagemin</a> for optimization</li>
<li><code>browser</code>: Initialize a <a href="http://browsersync.io" target="_blank" rel="external">BrowserSync</a> local server</li>
<li><code>browser:reload</code>: Reload our BrowserSync local server</li>
</ul>
<h3 id="Helper-convenience-tasks"><a href="#Helper-convenience-tasks" class="headerlink" title="Helper/convenience tasks"></a>Helper/convenience tasks</h3><p>Utility tasks out of the way, it would be useful to have some helper tasks that can batch the utility classes so the main build tasks and the watch stream aren’t polluted with tons of individual task calls and complications.</p>
<ul>
<li><code>build:assets</code>: Helper task to build, compile and optimize all site assets<ul>
<li><code>buildJs</code></li>
<li><code>buildCss</code></li>
<li><code>optimizeImg</code></li>
</ul>
</li>
<li><code>build</code>: Run the Jekyll build with the _<em>config.yml</em> file<ul>
<li><code>buildJekyll</code></li>
</ul>
</li>
<li><code>build:prod</code>: Same as <code>build</code>, but with the _<em>config.build.yml</em> file<ul>
<li><code>buildJekyll</code></li>
</ul>
</li>
</ul>
<p>It’s also worth noting that while the <code>build</code> and <code>build:prod</code> tasks may seem redundant, they’re necessary as <code>buildJekyll</code> is more of a utility function rather than a task, and to build using a specific config file requires it to be called as a function. I generally build my gulp tasks out as normal <a href="https://darrenderidder.github.io/talks/ModulePatterns/#/" target="_blank" rel="external">Node.js modules</a> so they can exist independent of each other and be called normally. This is achieved by utilizing the <a href="https://www.npmjs.com/package/gulp-auto-task" target="_blank" rel="external">gulp-auto-task</a> module, an absolute must-use with Gulp.</p>
<h3 id="Main-build-tasks"><a href="#Main-build-tasks" class="headerlink" title="Main build tasks"></a>Main build tasks</h3><p>Now that there are all of the tasks necessary to run builds, there needs to be some main build tasks that utilize our helpers and utilities to automate the entire proces for us.</p>
<ul>
<li><code>serve</code>: Fire up a BrowserSync server, run a full site and asset build then watch for any changes.<ul>
<li><code>browser</code></li>
<li><code>build</code></li>
<li><code>build:assets</code></li>
<li><code>browser:reload</code> (on change)</li>
</ul>
</li>
<li><code>deploy</code>: Run a full site and asset build, using the production config file.<ul>
<li><code>build:prod</code></li>
<li><code>build:assets</code></li>
</ul>
</li>
</ul>
<h2 id="Building-out-the-tasks"><a href="#Building-out-the-tasks" class="headerlink" title="Building out the tasks"></a>Building out the tasks</h2><p>Since the workflows needs are pretty well laid out, the Gulp tasks can efficiently start being developed. I like to start out by scaffolding out the utility tasks/functions then creating the main build process. That way I can get all of my tasks working, then the main build tasks are just quick, batched task or function calls.</p>
<h3 id="Getting-a-testable-Gulpfile-set-up"><a href="#Getting-a-testable-Gulpfile-set-up" class="headerlink" title="Getting a testable Gulpfile set up"></a>Getting a testable Gulpfile set up</h3><p>To make sure the tasks are easy to test, a very basic Gulpfile needs to be in place. Two must-use modules I use all the time and absolutely adore make super quick work of this: <a href="https://www.npmjs.com/package/gulp-auto-task" target="_blank" rel="external">gulp-auto-task</a> which automagically turns standard node modules into gulp tasks, and <a href="https://www.npmjs.com/package/require-dir" target="_blank" rel="external">require-dir</a> which will include all files within the specified folder, removing the possibility of having a giant mess of requires.</p>
<figure class="highlight javascript"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp          = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">    <span class="comment">/** Utils */</span></div><div class="line">    requireDir    = <span class="built_in">require</span>(<span class="string">'require-dir'</span>),</div><div class="line">    gulpAutoTask  = <span class="built_in">require</span>(<span class="string">'gulp-auto-task'</span>),</div><div class="line">    <span class="comment">/** Config */</span></div><div class="line">    paths        = <span class="built_in">require</span>(<span class="string">'./package.json'</span>).paths;</div><div class="line"></div><div class="line"><span class="comment">/** Import Main Tasks */</span></div><div class="line"><span class="comment">// Require modules so they can be called as functions</span></div><div class="line"><span class="keyword">var</span> utils = requireDir(<span class="string">'gulp-tasks'</span>); <span class="comment">// ex. utils.buildJekyll();</span></div><div class="line"><span class="comment">// Automagically set up tasks</span></div><div class="line">gulpAutoTask(<span class="string">'&#123;*,**/*&#125;.js'</span>, &#123;</div><div class="line">  <span class="attr">base</span>: paths.tasks,</div><div class="line">  <span class="attr">gulp</span>: gulp</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Technically, <code>require-dir</code> is not necessary at this stage, but it’s easy enough to include now and it saves having to include it later. With this in place, any <em>*.js</em> files placed within the <em>./gulp-tasks/</em> directory will not only get automatically required into the <code>utils</code> object, but they will also be turned into tasks without any <code>gulp.task</code> declarations. Some benefits to this include tasks becoming true modules, more readable files/file structure and <strong>tasks become reusable</strong>, which is very important for the Jekyll build task.</p>
<p>I’m also including a portion of <em>package.json</em> that I use to hold all of my paths. One quirk to working with tasks that are spread across different files is that globals can very quickly become very repetitive, so to solve this and to stay <strong>DRY</strong> I tossed a a <code>paths</code> object into my <em>package.json</em> file, so I can just require that object directly and keep all of my paths in one place.</p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  "paths": &#123;</div><div class="line">    "tasks": "gulp-tasks/",</div><div class="line">    "src": "project/",</div><div class="line">    "build": "_dist/",</div><div class="line">    "bower": "bower_components/",</div><div class="line">    "vendor": &#123;</div><div class="line">      "src": "project/js/lib/",</div><div class="line">      "dest": "_dist/js/"</div><div class="line">    &#125;,</div><div class="line">    "js": &#123;</div><div class="line">      "src": "project/js/",</div><div class="line">      "dest": "_dist/js/"</div><div class="line">    &#125;,</div><div class="line">    "sass": &#123;</div><div class="line">      "src": "project/_sass/"</div><div class="line">    &#125;,</div><div class="line">    "css": &#123;</div><div class="line">      "src": "project/css/",</div><div class="line">      "dest": "_dist/css/"</div><div class="line">    &#125;,</div><div class="line">    "img": &#123;</div><div class="line">      "src": "project/img/",</div><div class="line">      "dest": "_dist/img/"</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Utility-Tasks"><a href="#Utility-Tasks" class="headerlink" title="Utility Tasks"></a>Utility Tasks</h3><p>Since the Gulpfile is ready to accept tasks in the form of modules, the utility tasks can begin to take shape. As the modules are added they’ll automatically be available to test via <code>gulp &lt;fileName&gt;</code>, which is extremely helpful from a testing standpoint. For the sake of progress, I like to start with the easiest ones to get them knocked out first and foremost; in this case that’s the asset utilities as they are extremely simple and straight forward gulp tasks.</p>
<h4 id="CSS-Build"><a href="#CSS-Build" class="headerlink" title="CSS Build"></a>CSS Build</h4><figure class="highlight javascript"><figcaption><span>gulp-tasks/buildCss.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp        = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">    <span class="comment">/** Utilities */</span></div><div class="line">    rename      = <span class="built_in">require</span>(<span class="string">'gulp-rename'</span>),</div><div class="line">    size        = <span class="built_in">require</span>(<span class="string">'gulp-filesize'</span>),</div><div class="line">    <span class="comment">/** CSS */</span></div><div class="line">    sass          = <span class="built_in">require</span>(<span class="string">'gulp-sass'</span>),</div><div class="line">    minifyCss     = <span class="built_in">require</span>(<span class="string">'gulp-minify-css'</span>),</div><div class="line">    autoprefixer  = <span class="built_in">require</span>(<span class="string">'gulp-autoprefixer'</span>),</div><div class="line">    <span class="comment">/** Config */</span></div><div class="line">    paths      = <span class="built_in">require</span>(<span class="string">"../package.json"</span>).paths;</div><div class="line"></div><div class="line"><span class="comment">/** CSS Build */</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">buildCss</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> gulp.src(paths.css.src + <span class="string">'main.scss'</span>)</div><div class="line">    .pipe(sass(&#123;</div><div class="line">      <span class="attr">includePaths</span>: [paths.sass.src] <span class="comment">// Tell Sass where to look for files</span></div><div class="line">    &#125;).on(<span class="string">'error'</span>, sass.logError))</div><div class="line">    .pipe(autoprefixer(&#123;</div><div class="line">      <span class="attr">browsers</span>: [<span class="string">'last 2 versions'</span>]</div><div class="line">    &#125;))</div><div class="line">    .pipe(minifyCss())</div><div class="line">    .pipe(rename(&#123; <span class="attr">extname</span>: <span class="string">'.min.css'</span> &#125;))</div><div class="line">    .pipe(size()) <span class="comment">// Logs the minified file size to the console</span></div><div class="line">    .pipe(gulp.dest(paths.css.dest));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>The CSS task is a pretty straightforward, so there’s not too much in it that’s very special. There are two quirks that should be noted:</p>
<ul>
<li>Pass the path to the _<em>sass/</em> folder to the compiler so Sass knows where to look for files that get imported via <code>import();</code> (line 16)</li>
<li>Surrender the handling of styles completely from Jekyll to avoid Sass compilation errors.</li>
</ul>
<p>The former is easy enough and handled within our <code>sass()</code> function, but the latter requires messing with a couple more files.</p>
<ul>
<li><p>Tell Jekyll to exclude the <em>css/</em> directory by adding it to the excludes array within the _<em>config.yml</em> file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">exclude:</span> [css/]</div></pre></td></tr></table></figure>
</li>
<li><p>Remove the YAML front matter from the <em>main.scss</em> file:</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">// ---</span></div><div class="line"><span class="comment">// # Only the main Sass file needs front matter (the dashes are enough)</span></div><div class="line"><span class="comment">// ---</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="JavaScript-Build"><a href="#JavaScript-Build" class="headerlink" title="JavaScript Build"></a>JavaScript Build</h4><p>Again, there isn’t really anything super special about the JavaSript build that differs from any other run-of-the-mill Gulp JavaScript builds. I gather the vendor files from my <em>js/lib</em> directory and compile them to their own file, then similarly concatenate the regular <em>js/*.js</em> files and build them together. Since Jekyll doesn’t provide much in terms of JavaScript support out of the box, there’s no extra configuration required.</p>
<figure class="highlight javascript"><figcaption><span>gulp-tasks/buildJs.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp        = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">  <span class="comment">/** Utilities */</span></div><div class="line">    rename      = <span class="built_in">require</span>(<span class="string">'gulp-rename'</span>),</div><div class="line">    size        = <span class="built_in">require</span>(<span class="string">'gulp-filesize'</span>),</div><div class="line">  <span class="comment">/** JS Specific */</span></div><div class="line">    jshint      = <span class="built_in">require</span>(<span class="string">'gulp-jshint'</span>),</div><div class="line">    concat      = <span class="built_in">require</span>(<span class="string">'gulp-concat'</span>),</div><div class="line">    uglify      = <span class="built_in">require</span>(<span class="string">'gulp-uglify'</span>),</div><div class="line"><span class="comment">/** Config */</span></div><div class="line">    paths      = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).paths;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * JavaScript</div><div class="line"> * @todo Extract this to be more dynamic, helper function, specify path, file name, and what tasks to execute.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">buildJs</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Build vendor files</span></div><div class="line">  gulp.src(paths.vendor.src + <span class="string">'*.js'</span>)</div><div class="line">  <span class="comment">// Concat files</span></div><div class="line">    .pipe(concat(<span class="string">'vendor.js'</span>))</div><div class="line">  <span class="comment">// Minify combined files and rename</span></div><div class="line">    .pipe(uglify())</div><div class="line">    .pipe(rename(&#123; <span class="attr">extname</span>: <span class="string">'.min.js'</span> &#125;))</div><div class="line">    .pipe(size())</div><div class="line">    .pipe(gulp.dest(paths.vendor.dest));</div><div class="line"></div><div class="line">  <span class="keyword">return</span> gulp.src(paths.js.src + <span class="string">'*.js'</span>)</div><div class="line">  <span class="comment">// Concat files</span></div><div class="line">    .pipe(concat(<span class="string">'main.js'</span>))</div><div class="line">  <span class="comment">// Lint file</span></div><div class="line">    .pipe(jshint())</div><div class="line">    .pipe(jshint.reporter(<span class="string">'default'</span>))</div><div class="line">  <span class="comment">// Minify files and rename</span></div><div class="line">    .pipe(uglify())</div><div class="line">    .pipe(rename(&#123; <span class="attr">extname</span>: <span class="string">'.min.js'</span> &#125;))</div><div class="line">    .pipe(size())</div><div class="line">    .pipe(gulp.dest(paths.js.dest));</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Image-Optimization"><a href="#Image-Optimization" class="headerlink" title="Image Optimization"></a>Image Optimization</h4><p>After having discovered the importance of image optimization while working at a marketing firm and embarking on a giant performance optimization crusade, I try to include it in all of my projects. Luckily, basic image optimization with gulp is a cake walk with <a href="https://www.npmjs.com/package/gulp-imagemin" target="_blank" rel="external">gulp-imagemin</a>.</p>
<figure class="highlight javascript"><figcaption><span>gulp-tasks/optimizeImg.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp        = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">    <span class="comment">/** Images */</span></div><div class="line">    imagemin    = <span class="built_in">require</span>(<span class="string">'gulp-imagemin'</span>),</div><div class="line">    pngquant    = <span class="built_in">require</span>(<span class="string">'imagemin-pngquant'</span>),</div><div class="line">    <span class="comment">/** Config */</span></div><div class="line">    paths      = <span class="built_in">require</span>(<span class="string">"../package.json"</span>).paths;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Images</div><div class="line"> * @todo Determine better way of handling the inline SVG's so they can get optimized as well.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">optimizeImg</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> gulp.src([paths.img.src + <span class="string">'*'</span>, paths.img.src + <span class="string">'**/*'</span>])</div><div class="line">    .pipe(imagemin(&#123;</div><div class="line">      <span class="attr">progressive</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">use</span>: [pngquant(&#123;</div><div class="line">        <span class="attr">quality</span>: <span class="string">'65-75'</span></div><div class="line">      &#125;)]</div><div class="line">    &#125;))</div><div class="line">    .pipe(gulp.dest(paths.img.dest));</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>At this point I’m pretty happy with the results of the implementation on this site, however as noted in my @todo below I need to determine a better way of handling inline SVG’s, which I currently have as includes. One option I’ve been considering is tossing all of my SVG’s into <strong>assets/svg_, then updating this task to minify and optimize all SVG’s within that folder and toss them into my </strong>includes/svg_ folder so they can easily be inlined via <code>{% include svg/icon-name.svg %}</code>.</p>
<h4 id="Jekyll-Build"><a href="#Jekyll-Build" class="headerlink" title="Jekyll Build"></a>Jekyll Build</h4><p>While the Jekyll build is the real meat and potatoes of the workflow, it’s relatively simple and can be handled using one of two <a href="https://nodejs.org/api/child_process.html" target="_blank" rel="external">child_process</a> methods: <a href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options" target="_blank" rel="external">child_process.spawn</a> or <a href="https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback" target="_blank" rel="external">child_process.exec</a>.</p>
<p>Spawn and exec both do the same thing, but in different ways: spawn returns a stream, is asynchronously asynchronous and meant for streaming large amounts of data back to node, while exec returns a buffer and is synchronously asynchronous and meant for returning small data such as status messages. While both work, I personally prefer and am currently using exec for handling Jekyll builds.</p>
<p><strong>Jekyll Build using <code>child_process.exec</code></strong><br><figure class="highlight javascript"><figcaption><span>gulp-tasks/buildJekyll.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> exec          = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec,</div><div class="line">    <span class="comment">/** Utilities */</span></div><div class="line">    gutil         = <span class="built_in">require</span>(<span class="string">'gulp-util'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Gulp tasks get passed a callback first, so our secondary arg</span></div><div class="line"><span class="comment">// MUST be the second arg. Successful processes return callback(null).</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">buildJekyll</span>(<span class="params">callback, env</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> cmd = <span class="string">'jekyll build --config '</span>;</div><div class="line">  cmd += (env === <span class="string">'prod'</span> ? <span class="string">'_config.build.yml'</span> : <span class="string">'_config.yml'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback</span></div><div class="line">  <span class="keyword">return</span> exec(cmd, <span class="function"><span class="keyword">function</span>(<span class="params">error, stdout, stderror</span>) </span>&#123;</div><div class="line">    gutil.log(stdout); <span class="comment">// Log the output to the console</span></div><div class="line">    <span class="keyword">return</span> callback(error !== <span class="literal">null</span> ? <span class="string">'ERROR: Jekyll process exited with code: '</span>+error.code : <span class="literal">null</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><strong>Jekyll Build using <code>child_process.spawn</code></strong><br><figure class="highlight javascript"><figcaption><span>gulp-tasks/buildJekyll.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** gulp-tasks/buildJekyll.js */</span></div><div class="line"><span class="keyword">var</span> spawn         = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn;</div><div class="line"></div><div class="line"><span class="comment">// Gulp tasks get passed a callback first, so our secondary arg</span></div><div class="line"><span class="comment">// MUST be the second arg. Successful processes return callback(null).</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">buildJekyll</span>(<span class="params">callback, env</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> opts = [<span class="string">'build'</span>, <span class="string">'--config'</span>]; <span class="comment">// add base opts</span></div><div class="line"></div><div class="line">  <span class="comment">// if `env` is 'prod', use the production config file</span></div><div class="line">  opts.push(env === <span class="string">'prod'</span> ? <span class="string">'_config.build.yml'</span> : <span class="string">'_config.yml'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Init the `jekyll` command with our `opts` array</span></div><div class="line">  <span class="keyword">var</span> jekyll = spawn(<span class="string">'jekyll'</span>, opts, &#123;</div><div class="line">  <span class="comment">// https://nodejs.org/api/child_process.html#child_process_options_stdio</span></div><div class="line">    stdio: <span class="string">'inherit'</span> <span class="comment">// use stdin, stdout, etc.</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// Once finished, fire the Gulp callback</span></div><div class="line">  <span class="keyword">return</span> jekyll.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> callback(code === <span class="number">0</span> ? <span class="literal">null</span> : <span class="string">'ERROR: Jekyll process exited with code: '</span>+code);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Having used both spawn and exec, I personally prefer exec due to the cleanliness and compactness of the resulting file and I’ve noticed better consistency with how quick the process has been ending, allowing the following queued tasks to start quicker.</p>
<h3 id="Helper-and-Convenience-Tasks"><a href="#Helper-and-Convenience-Tasks" class="headerlink" title="Helper and Convenience Tasks"></a>Helper and Convenience Tasks</h3><p>With the utility tasks completed, the entire workflow could be emulated by manually running each task individually. As I don’t think anyone is really interested in a workflow that would require you to manually run each task individually, some helper tasks are definitely in order to automate everything. These tasks can then be called either individually or by the main build tasks, keeping our main build tasks concise.</p>
<p>Since these helper tasks are pretty much exclusively batch task runners, they can just get tossed into the Gulpfile after the task importation.</p>
<figure class="highlight javascript"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Helper Tasks */</span></div><div class="line">gulp.task(<span class="string">'build'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> utils.buildJekyll(callback, <span class="string">'serve'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'build:prod'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> utils.buildJekyll(callback, <span class="string">'prod'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'build:assets'</span>, [<span class="string">'buildCss'</span>, <span class="string">'buildJs'</span>, <span class="string">'optimizeImg'</span>]);</div></pre></td></tr></table></figure>
<p>On lines 2 - 4 the <code>build</code> task is getting declared, which just returns the <code>buildJekyll</code> utility function with the Gulp callback and non-<code>prod</code> environment passed in. On 6 - 8 the same is being done for the <code>build:prod</code> task but with the <code>prod</code> environment passed in as the second argument to dictate the use of the production build file. This duplication is a bummer, but it’s unfortunately necessary so the environment can get passed in. Since the <code>buildJekyll</code> call is being returned and the completed buffer returns by calling the Gulp callback, the task is also able to be used in sequence which is very important while making the main build tasks.</p>
<p>On line 9 the <code>build:assets</code> call isn’t anything super special, it’s just a simple Gulp task that is calling all of our asset build tasks. This isn’t super necessary but it’s nice being able to call just one task rather than three whenever a full asset build needs to be run.</p>
<h3 id="Implementing-BrowserSync"><a href="#Implementing-BrowserSync" class="headerlink" title="Implementing BrowserSync"></a>Implementing BrowserSync</h3><p>Since the entire build system is being handle by Gulp, it makes sense to have Gulp handle the local server as well. Rather than somehow hacking the the <code>jekyll serve</code> command into our watch command, tossing the blame to Gulp requires a lot less legwork; especially when integrating something like <a href="http://browsersync.io" target="_blank" rel="external">BrowserSync</a>, which is my personal favorite. Not only is BrowserSync super easy to set up but it has some super cool features such as device syncing (which is incredibly fun to play with).</p>
<p>While the tasks being so small is reason enough to toss them into the Gulpfile after our helpers, the initialization of the server and the reload task need to be within the same file for them to know each other exist, making throwing these into the Gulpfile a necessity.</p>
<figure class="highlight javascript"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BrowserSync needs to get required at the top of the file</span></div><div class="line"><span class="keyword">var</span> browserSync   = <span class="built_in">require</span>(<span class="string">'browser-sync'</span>).create(<span class="string">'jekyll'</span>);</div><div class="line"></div><div class="line">. . .</div><div class="line"></div><div class="line"><span class="comment">/** BrowserSync */</span></div><div class="line"><span class="comment">// Init server to build directory</span></div><div class="line">gulp.task(<span class="string">'browser'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  browserSync.init(&#123;</div><div class="line">    <span class="attr">server</span>: <span class="string">"./"</span> + paths.build,</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Force reload across all devices</span></div><div class="line">gulp.task(<span class="string">'browser:reload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  browserSync.reload();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Luckily BrowserSync is super easy to implement, so there isn’t a whole lot of bloat added to the Gulpfile. The module gets required and the server gets created with the name <em>Jekyll</em>, then the <code>browser</code> task actually initializes the server using the build path specified in the <em>package.json</em> file and finally the <code>browser:reload</code> task takes the initialized server and sends it a notice to refresh. Piece of cake.</p>
<h3 id="Creating-the-Main-Build-tasks"><a href="#Creating-the-Main-Build-tasks" class="headerlink" title="Creating the Main Build tasks"></a>Creating the Main Build tasks</h3><p>So far all of the tasks required to actually fully build the site are completely scaffolded out, and the build could actually be used by manually running <code>gulp build &amp;&amp; gulp build:assets</code> in the command line. That’s all great, but personally I would find that super annoying, plus it wouldn’t turn on the BrowserSync server. Since the whole point of this is complete automation, some build tasks are in order.</p>
<figure class="highlight javascript"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> watch         = <span class="built_in">require</span>(<span class="string">'gulp-watch'</span>),</div><div class="line">    runSequence   = <span class="built_in">require</span>(<span class="string">'run-sequence'</span>);</div><div class="line"></div><div class="line">. . .</div><div class="line"></div><div class="line"><span class="comment">/** Main Builds */</span></div><div class="line">gulp.task(<span class="string">'serve'</span>, [<span class="string">'browser'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  runSequence(<span class="string">'build'</span>, [<span class="string">'build:assets'</span>]);</div><div class="line">  <span class="comment">// CSS/SCSS</span></div><div class="line">  watch([</div><div class="line">        paths.src +<span class="string">'fonts/*'</span>,</div><div class="line">        paths.sass.src +<span class="string">'*.scss'</span>,</div><div class="line">        paths.css.src +<span class="string">'main.scss'</span>,</div><div class="line">        paths.sass.src +<span class="string">'**/*.scss'</span>,</div><div class="line">  ], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    runSequence(<span class="string">'buildCss'</span>, [<span class="string">'browser:reload'</span>]);</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">// JS</span></div><div class="line">  watch([paths.js.src +<span class="string">'*.js'</span>, paths.vendor.src +<span class="string">'*.js'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    runSequence(<span class="string">'buildJs'</span>, [<span class="string">'browser:reload'</span>]);</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">// Images</span></div><div class="line">  watch([paths.img.src +<span class="string">'*'</span>, paths.img.src +<span class="string">'**/*'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    runSequence(<span class="string">'optimizeImg'</span>, [<span class="string">'browser:reload'</span>]);</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">// Markup / Posts/ Data</span></div><div class="line">  watch([</div><div class="line">        paths.src +<span class="string">'*'</span>,</div><div class="line">        paths.src +<span class="string">'_data/*'</span>,</div><div class="line">        paths.src +<span class="string">'_plugins/*'</span>,</div><div class="line">        paths.src +<span class="string">'**/*.md'</span>,</div><div class="line">        paths.src +<span class="string">'**/*.html'</span>,</div><div class="line">        paths.src +<span class="string">'**/*.markdown'</span>,</div><div class="line">        paths.src +<span class="string">'_includes/**/*.md'</span>,</div><div class="line">        paths.src +<span class="string">'_includes/**/*.svg'</span>,</div><div class="line">        paths.src +<span class="string">'_includes/**/*.html'</span>,</div><div class="line">  ], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    runSequence(<span class="string">'build'</span>, [<span class="string">'build:assets'</span>, <span class="string">'browser:reload'</span>]);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  gutil.log(<span class="string">'Watching for changes.'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'deploy'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  runSequence(<span class="string">'build:prod'</span>, [<span class="string">'build:assets'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The <code>gulp deploy</code> task (lines 44 - 46) is nothing special, so I won’t really get into that as it’s essentially that I mentioned in the first part of this section, just a batch task. The <code>gulp serve</code> task (lines 7 - 42) however looks like quite the stinker, especially due to my use of the <a href="https://www.npmjs.com/package/gulp-watch" target="_blank" rel="external">gulp-watch</a> module rather than the built in <code>gulp.watch</code> function; the former taking an endless stream approach, which I prefer.</p>
<h4 id="The-gulp-serve-task-explained"><a href="#The-gulp-serve-task-explained" class="headerlink" title="The gulp serve task, explained"></a>The <code>gulp serve</code> task, explained</h4><p>While the task looks like an absolute monster, it’s actually pretty simple. On a very high level, it just sets up some listeners for each type of file that should trigger some sort of rebuild, and is broken down by type:</p>
<ul>
<li>CSS/Sass files which should trigger a style rebuild</li>
<li>JavaScript files which should trigger a JS rebuild</li>
<li>Images which should trigger image re-optimization</li>
<li>Anything else which should trigger a full rebuild due to the Jekyll build cleaning the destination folder</li>
</ul>
<p>As I said, pretty simple but there’s one other quirk to the build that will almost certainly need a refactor with the release of Gulp 4 that I haven’t explained yet, which is the <a href="https://www.npmjs.com/package/run-sequence" target="_blank" rel="external"><code>runSequence</code> module</a> that keeps getting called. Obviously there’s a very specific order that needs to be called each time; if the other tasks fire and complete before the Jekyll build is complete, they’ll be deleted by the Jekyll build and made pointless. This could be solved by adding some of the assets folders to the <code>excludes</code> within the _<em>config.yml</em> file, but I’d rather not have to toss in extra cleans in all of the builds and worry about extra artifacts sticking around and bloating up the built site.</p>
<p>RunSequence effectively forces tasks to run in sequence, so the queued tasks will not run until the first task is completed. This is why in all of the utility tasks the stream / callback is always getting returned, giving runSequence a reference of when one task ends so it can call the next task.</p>
<h2 id="To-do"><a href="#To-do" class="headerlink" title="To-do"></a>To-do</h2><p>Using runSequence to force things to run in order is a little bit of a hacky solution (it’s even mentioned as a hack within the readme for the module) until <a href="https://github.com/orchestrator/orchestrator" target="_blank" rel="external">orchestrator</a>, what Gulp is built off of, is updated to support <a href="https://github.com/orchestrator/orchestrator/issues/21" target="_blank" rel="external">non-dependent ordered tasks</a>. This is supposed to make it into <a href="https://github.com/gulpjs/gulp/milestones" target="_blank" rel="external">Gulp 4</a>, so once that’s released I will definitely be refactoring this to be less hacky.</p>
<div class="bg-video-wrap" style="background-image: url('/img/videos/gulpVid.png');"><br>  <video class="bg-video-player" autoplay loop><br>    <source src="/img/videos/gulpVid.mp4" type="video/mp4; codecs=avc1.42E01E,mp4a.40.2"><br>    <source src="/img/videos/gulpVid.webm" type="video/webm; codecs=vp8,vorbis"><br>    <source src="/img/videos/gulpVid.ogv" type="video/ogg; codecs=theora,vorbis"><br>  </video><br></div>

<h2 id="The-Completed-Workflow"><a href="#The-Completed-Workflow" class="headerlink" title="The Completed Workflow"></a>The Completed Workflow</h2><p>With everything built, development is started by running <code>gulp serve</code>, which spins up a BrowserSync server and does a full Jekyll and asset build, then watches for any changes and automagically runs whatever builds are necessary to quickly reflect that change on the BrowserSync server. Once development is finished and something is ready to be deployed, <code>gulp deploy</code> can be run to run a full Jekyll and asset build, but using the _<em>config.build.yml</em> config file to get the correct URLs and build settings for production. This task only gets run by my server after I’ve pushed up a new commit to it, which I’ll cover in a blog post later although there are many posts already in reference to this (such as <a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-jekyll-blogs-with-git" target="_blank" rel="external">this one</a> on <a href="digitalocean.com">Digital Ocean</a>).</p>
<p>You can find all of the completed files referenced in this post in the <a href="https://github.com/aesinv/aesinv-jekyll-blog/" target="_blank" rel="external">GitHub repository</a> for this site.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://aesinv.com/development/building-a-gulp-workflow-around-jekyll/" data-id="cizy4qye00001ahpgxwqgmsof" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gulp/">gulp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jekyll/">jekyll</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/workflow/">workflow</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/development/">development</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/game-dev/">game dev</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Internet-of-Things/">Internet of Things</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adobe-cq/">adobe cq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aem/">aem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aem6/">aem6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/beacons/">beacons</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-along/">code along</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crying-yourself-to-sleep/">crying yourself to sleep</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-motion/">device motion</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dungeon-crawler/">dungeon crawler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experimental-tech/">experimental tech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/game-development/">game development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/games/">games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git-issues/">git issues</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gulp/">gulp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ibeacon/">ibeacon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jekyll/">jekyll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sass/">sass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sightly/">sightly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity/">unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utilities/">utilities</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/workflow/">workflow</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Internet-of-Things/" style="font-size: 10px;">Internet of Things</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/adobe-cq/" style="font-size: 15px;">adobe cq</a> <a href="/tags/aem/" style="font-size: 10px;">aem</a> <a href="/tags/aem6/" style="font-size: 10px;">aem6</a> <a href="/tags/beacons/" style="font-size: 10px;">beacons</a> <a href="/tags/code-along/" style="font-size: 10px;">code along</a> <a href="/tags/crying-yourself-to-sleep/" style="font-size: 10px;">crying yourself to sleep</a> <a href="/tags/device-motion/" style="font-size: 10px;">device motion</a> <a href="/tags/dungeon-crawler/" style="font-size: 10px;">dungeon crawler</a> <a href="/tags/experimental-tech/" style="font-size: 10px;">experimental tech</a> <a href="/tags/game-development/" style="font-size: 15px;">game development</a> <a href="/tags/games/" style="font-size: 10px;">games</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-issues/" style="font-size: 10px;">git issues</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/ibeacon/" style="font-size: 10px;">ibeacon</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/sass/" style="font-size: 10px;">sass</a> <a href="/tags/sightly/" style="font-size: 10px;">sightly</a> <a href="/tags/unity/" style="font-size: 10px;">unity</a> <a href="/tags/utilities/" style="font-size: 10px;">utilities</a> <a href="/tags/workflow/" style="font-size: 10px;">workflow</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/uncategorized/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/development/fixing-git-push-pull-timeout/">Fixing git push/pull timing out</a>
          </li>
        
          <li>
            <a href="/development/passing-data-from-aem6-to-javascript/">Different ways to pass data from AEM6 to Javascript</a>
          </li>
        
          <li>
            <a href="/development/simplified-aem-frontend-sass/">A simplified front end architecture solution for AEM</a>
          </li>
        
          <li>
            <a href="/game-dev/keeping-the-user-entertained-when-they-fail/">Game Dev Log: Keeping the player entertained when they fail</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Matt Bengston<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>